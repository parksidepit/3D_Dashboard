<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Kunden Dashboard Pro - Live Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://rsms.me/inter/inter.css');
        
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5558dd;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            /* WICHTIG: Platz f√ºr die fixe Leiste schaffen, damit sie nichts verdeckt */
            padding-bottom: 80px; 
        }

        .main-container {
            background: rgba(255, 255, 255, 0.98);
            /* HINWEIS: Dieses backdrop-filter war der Grund, warum 'position: fixed' 
              innerhalb dieses Containers nicht funktioniert hat.
              Die Filterleiste muss *au√üerhalb* dieses Containers im HTML platziert werden.
            */
            backdrop-filter: blur(10px);
            border-radius: 24px;
            margin: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .glass-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.12);
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .kpi-card.active-filter {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3);
            border: 2px solid white;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.95;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        /* 2. Neue Styles f√ºr Lead-Analyse-Kachel */
        .lead-kpi-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .lead-kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        .lead-kpi-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .lead-kpi-stat {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
        }
        .lead-kpi-footer {
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }
        .lead-kpi-rate {
            font-weight: 600;
            color: var(--success-color);
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            padding: 1rem;
        }
        
        /* NEU: Spezielle Styles f√ºr Geo-Karten */
        #geoMapChart {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        #geoMapContainer {
            position: relative;
        }

        #geoMapContainer .leaflet-container {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            box-shadow: 0 15px 45px rgba(15, 23, 42, 0.18);
        }

        .leaflet-control-container .leaflet-top .leaflet-control {
            margin-top: 1rem;
        }

        .map-legend-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-family: 'Inter', sans-serif;
        }

        .map-legend-scale {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #4b5563;
        }

        .map-legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
        }

        .map-legend-info {
            font-size: 0.85rem;
            text-align: center;
            color: #1f2937;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.15);
            padding: 10px 12px;
            border-radius: 10px;
        }

        .geo-info-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #6b21a8;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
            border: 2px solid #e5e7eb;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .filter-container {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .custom-select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="%236366f1" d="M10 12L6 8h8l-4 4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 20px;
            padding-right: 2.5rem;
        }

        .matrix-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.875rem;
        }

        .matrix-table th, .matrix-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .matrix-table th {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matrix-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .matrix-table .interactive:hover {
            background: rgba(99, 102, 241, 0.1);
            cursor: pointer;
        }

        .matrix-table .active-filter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            /* *** √ÑNDERUNG: Breiteres Modal *** */
            max-width: 1100px; /* War 900px */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* 4. Neues Modal f√ºr Reason-Klicks */
        .simple-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .simple-modal-list li {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        
        .simple-modal-list li:hover {
            background-color: #f9fafb;
            color: var(--primary-color);
        }
        
        .simple-modal-list li:last-child {
            border-bottom: none;
        }
        
        .modal-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .modal-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%);
        }

        .sortable-header:hover {
            background-color: #f3f4f6;
        }
        .sortable-header .sort-icon {
            color: #9ca3af;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .sortable-header.sort-asc .sort-icon,
        .sortable-header.sort-desc .sort-icon {
            opacity: 1;
            color: var(--primary-color);
        }
        .sortable-header.sort-asc .sort-icon::before {
            content: '\f0de'; /* fa-sort-up */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        .sortable-header.sort-desc .sort-icon::before {
            content: '\f0dd'; /* fa-sort-down */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* ============ GEO-ANALYSE MODERN STYLES ============ */
        
        .geo-kpi-card {
            position: relative;
            padding: 1.5rem;
            border-radius: 16px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .geo-kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        }
        
        .geo-kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        .geo-kpi-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 3rem;
            opacity: 0.2;
        }
        
        .geo-kpi-content {
            position: relative;
            z-index: 1;
        }
        
        .geo-kpi-label {
            font-size: 0.875rem;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .geo-kpi-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .geo-kpi-sublabel {
            font-size: 0.875rem;
            opacity: 0.85;
        }
        
        /* Bundesland Ranking Item */
        .bundesland-item {
            background: white;
            border: 2px solid #f3f4f6;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .bundesland-item:hover {
            border-color: #8b5cf6;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        .bundesland-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .bundesland-item:hover::before {
            transform: scaleY(1);
        }
        
        .bundesland-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 1rem;
        }
        
        .rank-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #92400e;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #4b5563;
            box-shadow: 0 4px 12px rgba(192, 192, 192, 0.4);
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e9a96f 100%);
            color: #78350f;
            box-shadow: 0 4px 12px rgba(205, 127, 50, 0.4);
        }
        
        .rank-other {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .bundesland-name {
            font-weight: 700;
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .bundesland-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1.125rem;
            color: #1f2937;
        }
        
        .stat-label {
            font-size: 0.625rem;
            color: #6b7280;
            text-transform: uppercase;
            margin-top: 0.125rem;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        /* Search Input Animation */
        #geoSearchInput:focus {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.2);
        }
        
        /* Scroll Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .bundesland-item {
            animation: slideIn 0.4s ease backwards;
        }
        
        .bundesland-item:nth-child(1) { animation-delay: 0.05s; }
        .bundesland-item:nth-child(2) { animation-delay: 0.1s; }
        .bundesland-item:nth-child(3) { animation-delay: 0.15s; }
        .bundesland-item:nth-child(4) { animation-delay: 0.2s; }
        .bundesland-item:nth-child(5) { animation-delay: 0.25s; }
        
        /* Toast Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* ============ END GEO-ANALYSE MODERN STYLES ============ */

        /* 4. Anrufer-Modus UX Update */
        .anrufer-screen-grid { 
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 1.5rem; 
        }
        
        .anrufer-screen-grid .details-section { 
            /* Alte Styles entfernt */
            /* Neue flex layout */
            display: flex;
            flex-direction: column;
            height: 70vh; /* Feste H√∂he f√ºr den Container */
            border-left: 1px solid #e5e7eb; 
            padding-left: 1.5rem; 
        }
        
        /* Neuer Scroll-Bereich f√ºr Infos */
        .anrufer-details-info {
            flex-grow: 1; /* Nimmt verf√ºgbaren Platz ein */
            overflow-y: auto; /* Nur dieser Teil scrollt */
            padding-right: 1rem; /* Platz f√ºr Scrollbar */
        }
        
        /* Neuer fixer Bereich f√ºr Formular */
        .anrufer-details-form {
            flex-shrink: 0; /* Verhindert Schrumpfen */
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            background: white; /* Stellt sicher, dass es nicht transparent ist */
        }
        /* Ende Anrufer-Modus UX Update */

        .lead-score-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .lead-score-cold { background: #dbeafe; color: #1e40af; }
        .lead-score-warm { background: #fed7aa; color: #92400e; }
        .lead-score-hot { background: #fee2e2; color: #991b1b; }
        .lead-score-customer { background: #d1fae5; color: #065f46; }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- NEUE STYLES (Punkt 1 & 2) --- */
        .header-kpi {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            padding: 0.5rem;
            border: 2px solid transparent;
        }
        .header-kpi:hover {
            background: rgba(99, 102, 241, 0.05);
            border-color: rgba(99, 102, 241, 0.2);
        }
        .header-kpi.active-filter-header {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.1);
            transform: scale(1.03);
        }
        /* --- ENDE NEUE STYLES --- */
        
        /* SalesCockpit Styles */
        .task-list {
            list-style: none;
            padding-left: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .task-list li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .task-list li:hover {
            background: #f9fafb;
        }
        .task-list li:last-child {
            border-bottom: none;
        }
        
        /* 2. Style f√ºr Cockpit Z√§hler */
        .cockpit-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            margin-left: 0.5rem;
            min-width: 28px;
        }
        
        .cockpit-list-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .cockpit-list-item:hover {
            background-color: #f3f4f6;
        }

        #calendar-container {
            user-select: none;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .calendar-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .calendar-nav-btn {
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Fokus-Modus Styles */
        #fokus-task-list li {
            font-size: 0.9rem;
        }
        /* NEU: Separator-Styling */
        #fokus-task-list li.fokus-separator {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: #f5f3ff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
            cursor: default;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        #fokus-task-list li.completed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        #fokus-task-list li.active-fokus {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-left: 4px solid var(--primary-color);
            font-weight: 600;
        }

        /* --- NEUE FILTERBAR-LOGIK (FIXED BOTTOM) --- */
        #activeFilterBar {
            position: fixed;        /* WIEDER 'FIXED' */
            bottom: 1rem;           /* Am unteren Rand */
            left: 50%;              /* Horizontal zentrieren */
            transform: translateX(-50%); /* Genaue Zentrierung */
            
            width: auto;            /* Breite an Inhalt anpassen */
            min-width: 500px;       /* Mindestbreite */
            max-width: 80%;         /* Maximale Breite */
            
            /* NEU: Transparenz angepasst (von 0.9 auf 0.85) */
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.85) 0%, rgba(50, 40, 70, 0.85) 100%);
            backdrop-filter: blur(12px);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex; /* Immer sichtbar */
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            z-index: 9998;      /* Unter den Modals (9999) */
            border-radius: 16px; /* Abgerundete Ecken */
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            /* Animation beim Laden */
            animation: slideUp 0.5s 1s ease-out backwards; /* Startet nach 1s */
        }

        /* Die .active-Klasse wird nicht mehr ben√∂tigt */
        #activeFilterBar.active { }

        /* Aktualisierte Animation, um translateX(-50%) zu ber√ºcksichtigen */
        @keyframes slideUp {
            from {
                transform: translateY(100%) translateX(-50%);
                opacity: 0;
            }
            to {
                transform: translateY(0) translateX(-50%);
                opacity: 1;
            }
        }
        /* --- ENDE NEUE FILTERBAR-LOGIK --- */

        .filter-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            margin: 0 0.3rem;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
		.filter-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .filter-badge .remove-filter {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .filter-badge .remove-filter:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Smooth transitions */
        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* Global Search Dropdown */
        .global-search-container {
            position: relative;
            display: inline-block;
        }

        .global-search-input {
            width: 300px;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .global-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .global-search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .global-search-dropdown.active {
            display: block;
        }

        .global-search-result {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .global-search-result:last-child {
            border-bottom: none;
        }

        .global-search-result:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .global-search-result-company {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .global-search-result-details {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .global-search-highlight {
            background: #fef3c7;
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }

        .global-search-no-results {
            padding: 1.5rem;
            text-align: center;
            color: #9ca3af;
        }

        .global-search-show-all {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-top: 2px solid #e5e7eb;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.2s ease;
            position: sticky;
            bottom: 0;
        }

        .global-search-show-all:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }

        .global-search-results-count {
            font-size: 0.85rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }

        /* Results counter */
        .results-counter {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, rgba(249, 250, 251, 0.98) 0%, rgba(243, 244, 246, 0.98) 100%);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }
        
        .results-counter-text {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        .calendar-nav-btn:hover {
            background: #e5e7eb;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-header-cell {
            background: #f9fafb;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
        }
        .calendar-day-cell {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
        }
        .calendar-day-cell.other-month {
            background: #f9fafb;
            opacity: 0.6;
        }
        .calendar-day-cell .day-number {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .calendar-day-cell.is-today .day-number {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .calendar-tasks {
            margin-top: 0.5rem;
            max-height: 80px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        .calendar-task-item {
            display: block;
            padding: 2px 4px;
            margin-bottom: 2px;
            background: #eef2ff;
            color: #4338ca;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-task-item:hover {
            background: #e0e7ff;
            font-weight: 500;
        }
        
        /* 5. Custom scrollbar f√ºr task lists (aktualisiert) */
        .task-list::-webkit-scrollbar,
        .calendar-tasks::-webkit-scrollbar,
        .anrufer-details-info::-webkit-scrollbar,
        #reasonsNotBoughtTextList::-webkit-scrollbar,
        /* *** NEU: Scrollbar f√ºr Modal-Boxen *** */
        .modal-scroll-box::-webkit-scrollbar,
        /* *** NEU: Scrollbar f√ºr Tabelle *** */
        .table-scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .task-list::-webkit-scrollbar-thumb,
        .calendar-tasks::-webkit-scrollbar-thumb,
        .anrufer-details-info::-webkit-scrollbar-thumb,
        #reasonsNotBoughtTextList::-webkit-scrollbar-thumb,
        /* *** NEU: Scrollbar f√ºr Modal-Boxen *** */
        .modal-scroll-box::-webkit-scrollbar-thumb,
        /* *** NEU: Scrollbar f√ºr Tabelle *** */
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        /* NEU: Scrollbarer Container f√ºr Kundenliste-Tabelle */
        .table-scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        /* NEU: CSS f√ºr Erweiterter Filter Modal */
        #advancedFilterModal .modal-content {
            max-width: 1400px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .advanced-filter-categories {
            max-height: 60vh;
            overflow-y: auto;
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .filter-category {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            overflow: visible;
            transition: all 0.3s ease;
        }
        
        .filter-category.collapsed {
            overflow: hidden;
        }
        
        .filter-category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            user-select: none;
        }
        
        /* CSS f√ºr Checkbox-Dropdown */
        .checkbox-dropdown {
            position: relative;
            width: 100%;
        }
        
        .checkbox-dropdown-button {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .checkbox-dropdown-button:hover {
            border-color: var(--primary-color);
            background: #f9fafb;
        }
        
        .checkbox-dropdown-button::after {
            content: '‚ñº';
            position: absolute;
            right: 0.75rem;
            font-size: 0.75rem;
            color: #6366f1;
            transition: transform 0.2s;
        }
        
        .checkbox-dropdown-button.active::after {
            transform: rotate(180deg);
        }
        
        .checkbox-dropdown-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 0.25rem;
            max-height: 350px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .checkbox-dropdown-list.active {
            display: block;
        }
        
        .checkbox-dropdown-item {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .checkbox-dropdown-item:hover {
            background: #f3f4f6;
        }
        
        .checkbox-dropdown-item input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .checkbox-dropdown-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }
        
        .checkbox-dropdown-search {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .checkbox-dropdown-search input {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .checkbox-dropdown-search input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .selected-count {
            font-size: 0.875rem;
            color: #6366f1;
            font-weight: 600;
        }
        
        .filter-category-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }
        
        .filter-category-icon {
            transition: transform 0.3s ease;
        }
        
        .filter-category.collapsed .filter-category-icon {
            transform: rotate(-90deg);
        }
        
        .filter-category-content {
            padding: 1rem;
            background: #f9fafb;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-height: 500px;
            overflow: visible;
            transition: max-height 0.3s ease;
        }
        
        .filter-category.collapsed .filter-category-content {
            display: none;
        }
        
        .advanced-filter-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .advanced-filter-field label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .selection-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #6366f1;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 999px;
            min-width: 20px;
            height: 18px;
        }
        
        .advanced-filter-field select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            min-height: 80px;
        }
        
        .advanced-filter-field select[multiple] {
            min-height: 120px;
        }
        
        .advanced-filter-field input[type="date"] {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="modal-overlay active">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-white text-xl font-bold">Dashboard wird geladen...</h2>
            <p class="text-white opacity-75 mt-2">Verbindung zu Google Sheets wird hergestellt</p>
        </div>
    </div>

    <div class="main-container">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        3D Kunden Dashboard
                    </h1>
                    <p class="text-gray-600 mt-2">
                        Angemeldet als: <span id="userName" class="font-semibold"></span>
                        <button id="userNameBtn" class="ml-1 text-purple-600 hover:text-purple-800 transition-colors" title="Ihren angezeigten Namen √§ndern">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button> | 
                        <span id="onlineUsers" class="text-sm text-gray-500">
                            Lade Live-Status...
                        </span> |
                        <span class="text-sm">Letzte Aktualisierung: <span id="lastUpdate" class="font-semibold">-</span></span>
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="global-search-container">
                        <input type="text" 
                               id="globalSearchHeader" 
                               class="global-search-input" 
                               placeholder="Globale Suche..."
                               autocomplete="off"
                               title="Volltext-Suche √ºber alle Spalten (Strg+Shift+F)">
                        <i class="fas fa-search global-search-icon"></i>
                        <div id="globalSearchDropdown" class="global-search-dropdown">
                        </div>
                    </div>
                    <button id="refreshBtn" class="bg-white border-2 border-purple-600 text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Aktualisieren
                    </button>
                    <button id="helpBtn" onclick="toggleHelpModal()" class="bg-white border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-all" title="Tastenk√ºrzel anzeigen">
                        <i class="fas fa-keyboard mr-2"></i>Shortcuts
                    </button>
                    <button id="exportBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button id="infoBtn" onclick="openInfoModal()" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all" title="Dashboard-Anleitung und Informationen">
                        <i class="fas fa-info-circle mr-2"></i>Info
                    </button>
                </div>
            </div>

            <div class="mt-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl">
                <div class="grid grid-cols-7 gap-4">
                    
                    <div class="text-center header-kpi" title="Alle Filter zur√ºcksetzen und Gesamtanzahl anzeigen" 
                         onclick="applyHeaderFilter(this, 'total')">
                        <p class="text-sm text-gray-600">Gesamtkunden</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalCustomers">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Vision = ja" 
                         onclick="applyHeaderFilter(this, 'vision', 'ja')">
                        <p class="text-sm text-gray-600">Vision Module</p>
                        <p class="text-2xl font-bold text-blue-600" id="visionCount">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Scanning = ja" 
                         onclick="applyHeaderFilter(this, 'scanning', 'ja')">
                        <p class="text-sm text-gray-600">Scanning Module</p>
                        <p class="text-2xl font-bold text-green-600" id="scanningCount">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Interesse 3D? = ja" 
                         onclick="applyHeaderFilter(this, 'interesse3D', 'ja')">
                        <p class="text-sm text-gray-600">3D Interesse</p>
                        <p class="text-2xl font-bold text-orange-600" id="interesse3DCount">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Potenzieller NPS2 Kunde? = ja" 
                         onclick="applyHeaderFilter(this, 'nps2', 'ja')">
                        <p class="text-sm text-gray-600">NPS2 Interesse</p>
                        <p class="text-2xl font-bold text-teal-600" id="nps2InteresseCount">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Hei√üe Leads (Score enth√§lt 'üî•üî•üî•')" 
                         onclick="applyHeaderFilter(this, 'hotLeads')">
                        <p class="text-sm text-gray-600">Hei√üe Leads</p>
                        <p class="text-2xl font-bold text-red-600" id="hotLeadsCount">0</p>
                    </div>
                    
                    <div class="text-center header-kpi" title="Kunden filtern: Status = Kunde (Score enth√§lt 'üèÜ')" 
                         onclick="applyHeaderFilter(this, 'customers')">
                        <p class="text-sm text-gray-600">Kunden</p>
                        <p class="text-2xl font-bold text-green-600" id="customerCount">0</p>
                    </div>
                    
                </div>
            </div>
            </header>

        <div class="glass-card mb-6" id="dynamic-summary-card">
            <h3 class="text-lg font-semibold mb-3 text-gray-800">
                <i class="fas fa-file-alt mr-2 text-purple-600"></i>Aktuelle Auswahl
            </h3>
            <div id="dynamicSummaryText" class="text-lg text-gray-700" style="line-height: 1.6;">
                <p class="skeleton h-5 w-full"></p>
            </div>
        </div>

        <div class="filter-container">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-filter mr-2 text-purple-600"></i>Filter
                </h3>
                <div class="flex gap-2">
                    <button id="advancedFilterBtn" class="text-sm bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all">
                        <i class="fas fa-filter mr-1"></i>Erweiterter Filter
                    </button>
                    <button id="resetFilters" class="text-sm text-gray-500 hover:text-purple-600 transition-colors">
                        <i class="fas fa-undo mr-1"></i>Filter zur√ºcksetzen
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="search-box md:col-span-3">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearch" placeholder="Firma suchen..." 
                           list="companyDatalist"
                           class="w-full border rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400"
                           title="In Firma und E-Mail suchen (Ctrl+K)">
                    <datalist id="companyDatalist">
                    </datalist>
                </div>

                <select id="salesRepFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach Sales Rep filtern">
                    <option value="all">Alle Sales Reps</option>
                </select>

                <select id="akquiseTypFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach Akquise-Typ filtern">
                    <option value="all">Alle Akquise-Typen</option>
                </select>
                
                <select id="leadScoreFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach berechnetem Lead Score filtern">
                    <option value="all">Alle Lead Scores (ber.)</option>
                </select>

                <select id="leadStatusBerechnetFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach berechnetem Lead Status filtern">
                    <option value="all">Alle Lead Status (ber.)</option>
                </select>

                <select id="leadFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach Lead-Quelle filtern">
                    <option value="all">Alle Leads</option>
                </select>

                <select id="upsellStatusFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach Upsell Status filtern">
                    <option value="all">Alle Upsell Status</option>
                </select>

                <select id="bundeslandFilter" class="custom-select border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Nach Bundesland filtern">
                    <option value="all">Alle Bundesl√§nder</option>
                </select>
            </div>
        </div>

        <div class="flex space-x-4 mb-6 overflow-x-auto pb-2">
            <button class="tab-button active" data-tab="overview">
                <i class="fas fa-chart-line mr-2"></i>√úbersicht
            </button>
            <button class="tab-button" data-tab="cockpit">
                <i class="fas fa-tachometer-alt mr-2"></i>SalesCockpit
            </button>
            <button class="tab-button" data-tab="customers">
                <i class="fas fa-users mr-2"></i>Kundenliste
            </button>
            <button class="tab-button" data-tab="matrix">
                <i class="fas fa-th mr-2"></i>Matrix-Ansicht
            </button>
            <button class="tab-button" data-tab="anrufer">
                <i class="fas fa-phone mr-2"></i>Anrufer-Modus
            </button>
            <button class="tab-button" data-tab="reasons">
                <i class="fas fa-chart-pie mr-2"></i>Gr√ºnde-Analyse
            </button>
            <button class="tab-button" data-tab="geo">
                <i class="fas fa-map-marked-alt mr-2"></i>Geo-Analyse
            </button>
        </div>

        <div id="overview-tab" class="tab-content">

            <div class="glass-card mb-8">
                <h3 class="text-lg font-semibold mb-4 text-gray-800" title="Zeigt die Top 6 Lead-Quellen (basierend auf der Gesamtanzahl der Leads) und deren Conversion Rate zu Kunden. Nutzt die gesamte Datenbasis, nicht die gefilterte.">
                    <i class="fas fa-bullhorn mr-2 text-purple-600"></i>Lead-Quellen Analyse (Top 6)
                </h3>
                <div id="lead-kpi-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <p class="text-gray-500">Lade Lead-Analyse...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-chart-pie mr-2 text-purple-600"></i>Lead Score Verteilung
                    </h3>
                    <div class="chart-container">
                        <canvas id="leadScoreChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-chart-bar mr-2 text-pink-600"></i>Sales Rep Performance
                    </h3>
                    <div class="chart-container">
                        <canvas id="salesPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-users-cog mr-2 text-green-600"></i>Akquise-Typ Analyse
                </h3>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="akquiseTypChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="cockpit-tab" class="tab-content hidden">
            <div class="mb-4">
                <button id="startFokusBtn" onclick="startTagesFokus()" 
                        class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all font-semibold">
                    <i class="fas fa-bullseye mr-2"></i>Tages-Fokus starten
                </button>
                <button id="exitFokusBtn" onclick="exitTagesFokus()" 
                        class="hidden bg-gradient-to-r from-red-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all font-semibold ml-3">
                    <i class="fas fa-times mr-2"></i>Fokus beenden
                </button>
            </div>
            <div id="cockpit-normal-view">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="glass-card">
                    <h3 id="cockpit-today-title" class="font-semibold text-lg mb-3"><i class="fas fa-calendar-day mr-2 text-blue-500"></i>Heute f√§llig</h3>
                    <ul id="cockpit-today" class="task-list" title="Kunden mit n√§chstem Kontakt = heute. Klicken, um Details zu sehen."></ul>
                </div>
                <div class="glass-card">
                    <h3 id="cockpit-overdue-title" class="font-semibold text-lg mb-3"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>√úberf√§llig</h3>
                    <ul id="cockpit-overdue" class="task-list" title="Kunden, deren n√§chster Kontakt in der Vergangenheit liegt. Klicken, um Details zu sehen."></ul>
                </div>
                <div class="glass-card">
                    <h3 id="cockpit-top-leads-title" class="font-semibold text-lg mb-3"><i class="fas fa-star mr-2 text-yellow-500"></i>Neue Top Leads</h3>
                    <ul id="cockpit-top-leads" class="task-list" title="Kunden mit hohem Lead Score (z.B. üî•üî•üî•). Klicken, um Details zu sehen."></ul>
                </div>
                <div class="glass-card">
                    <h3 id="cockpit-cold-leads-title" class="font-semibold text-lg mb-3"><i class="fas fa-snowflake mr-2 text-gray-400"></i>Kalte Leads</h3>
                    <ul id="cockpit-cold-leads" class="task-list" title="Kunden mit niedrigem Lead Score (z.B. ‚ùÑÔ∏è). Klicken, um Details zu sehen."></ul>
                </div>
            </div>
            
            <div class="glass-card">
                <div id="calendar-container">
                    <div class="calendar-header">
                        <button id="calendar-prev" class="calendar-nav-btn" title="Vorheriger Monat">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendar-month-year"></h3>
                        <div class="flex items-center space-x-2">
                            <button id="calendar-today" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-lg hover:bg-purple-200 transition-all" title="Zum heutigen Datum springen">
                                Heute
                            </button>
                            <button id="calendar-next" class="calendar-nav-btn" title="N√§chster Monat">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-weekdays">
                        </div>
                    <div class="calendar-grid" id="calendar-days" title="Klicken Sie auf einen Kundennamen, um Details zu sehen.">
                        </div>
                </div>
            </div>
            </div> <div id="cockpit-fokus-view" class="hidden">
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-bullseye mr-2 text-green-600"></i>Tages-Fokus
                        </h3>
                        <div class="text-lg font-semibold text-gray-600">
                            <span id="fokus-progress">Kunde <span id="fokus-current">0</span> von <span id="fokus-total">0</span></span>
                        </div>
                    </div>
                    
                    <div class="anrufer-screen-grid">
                        <div>
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-3 text-purple-700">Aufgabenliste</h4>
                                <ul id="fokus-task-list" class="task-list max-h-96" title="Klicken, um Kunden auszuw√§hlen">
                                </ul>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div id="fokusDetails" class="h-full flex flex-col">
                                <p class="text-gray-500 text-center mt-8">Lade ersten Kunden...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="customers-tab" class="tab-content hidden">
            <div class="glass-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-users mr-2 text-purple-600"></i>Kundenliste
                    </h3>
                    <div class="flex gap-3 items-center">
                        <label class="text-sm font-medium text-gray-700">Sortieren nach:</label>
                        <select id="sortColumnSelect" class="custom-select" style="min-width: 200px;">
                            <option value="">-- Spalte w√§hlen --</option>
                            <option value="Firma">Firma</option>
                            <option value="Sales Rep">Sales Rep</option>
                            <option value="Vision">Vision</option>
                            <option value="Scanning">Scanning</option>
                            <option value="Lead Score (berechnet)">Lead Score</option>
                            <option value="Upsell Status">Upsell Status</option>
                            <option value="Letzter Anruf am:">Letzter Anruf</option>
                            <option value="Wann erneuter Kontakt?">N√§chster Kontakt</option>
                        </select>
                        <select id="sortDirectionSelect" class="custom-select" style="min-width: 150px;">
                            <option value="asc">Aufsteigend ‚Üë</option>
                            <option value="desc">Absteigend ‚Üì</option>
                        </select>
                        <button id="applySortBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                            <i class="fas fa-sort mr-1"></i>Sortieren
                        </button>
                    </div>
                </div>
                <div class="table-scroll-container">
                    <table class="w-full" id="customerTable">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Firma</th>
                                <th class="text-left py-3 px-4">Sales Rep</th>
                                <th class="text-center py-3 px-4">Vision</th>
                                <th class="text-center py-3 px-4">Scanning</th>
                                <th class="text-left py-3 px-4">Lead Score</th>
                                <th class="text-left py-3 px-4">Upsell Status</th>
                                <th class="text-left py-3 px-4">Letzter Anruf</th>
                                <th class="text-left py-3 px-4">N√§chster Kontakt</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="matrix-tab" class="tab-content hidden">
            <div class="glass-card">
                <h3 class="text-lg font-semibold mb-4 text-gray-800" title="Kreuztabelle des berechneten Lead Status gegen den berechneten Lead Score. Klicken Sie auf eine Zahl, um die entsprechende Kundenliste zu filtern.">
                    <i class="fas fa-th mr-2 text-purple-600"></i>Lead Status (ber.) / Lead Score (ber.) Matrix
                </h3>
                <div class="overflow-x-auto">
                    <table class="matrix-table" id="matrixTable">
                        </table>
                </div>
            </div>
        </div>

        <div id="anrufer-tab" class="tab-content hidden">
            <div class="glass-card">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-phone-alt mr-2 text-green-600"></i>Anrufer-Modus
                </h3>
                
                <div class="anrufer-screen-grid">
                    <div>
                        <div class="mb-4">
                            <input type="text" id="anruferSearch" placeholder="Kunde suchen..." 
                                   class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   title="Kunden in der Anrufliste suchen">
                        </div>
                        <select id="anruferCustomerList" size="20" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Kunden ausw√§hlen, um Details anzuzeigen und Notizen zu speichern">
                            </select>
                    </div>
                    
                    <div class="details-section">
                        <div id="anruferDetails" class="h-full flex flex-col"> <p class="text-gray-500 text-center mt-8">W√§hlen Sie einen Kunden aus der Liste</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reasons-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800" title="Zeigt die h√§ufigsten Gr√ºnde, warum Kunden nicht gekauft haben. Klicken, um Kundenliste zu filtern.">
                        <i class="fas fa-times-circle mr-2 text-red-600"></i>Gr√ºnde NICHT gekauft
                    </h3>
                    <div class="chart-container">
                        <canvas id="reasonsNotBoughtChart"></canvas>
                    </div>
                </div>
                
                <div class="glass-card">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800" title="Zeigt die h√§ufigsten Gr√ºnde, warum Kunden gekauft haben. Klicken, um Kundenliste zu filtern.">
                        <i class="fas fa-check-circle mr-2 text-green-600"></i>Gr√ºnde gekauft
                    </h3>
                    <div class="chart-container">
                        <canvas id="reasonsBoughtChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="glass-card mt-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800" title="Zeigt die Top 10 der aktuell von Kunden verwendeten 3D-Software (basierend auf der aktuellen Filterung). Klicken, um Kundenliste zu filtern.">
                    <i class="fas fa-desktop mr-2 text-blue-600"></i>Top 10 Aktuell Verwendete 3D Software
                </h3>
                <div id="topSoftwareList" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                    </div>
            </div>
            
            <div class="glass-card mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800" title="Zeigt Freitext-Begr√ºndungen f√ºr 'Nicht gekauft' (basierend auf der aktuellen Filterung).">
                        <i class="fas fa-comment-dots mr-2 text-yellow-600"></i>Begr√ºndungen "NICHT gekauft" (Text)
                    </h3>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="reasonTextFilter" placeholder="Schlagworte filtern..." 
                               class="border rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               title="Begr√ºndungen und Kundennamen durchsuchen">
                    </div>
                </div>
                <div id="reasonsNotBoughtTextList" class="max-h-80 overflow-y-auto space-y-4 p-2">
                    </div>
            </div>
        </div>

        <!-- Neuer Geo-Analyse Tab -->
        <div id="geo-tab" class="tab-content hidden">
            <!-- Geo KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="geo-kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="geo-kpi-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div class="geo-kpi-content">
                        <div class="geo-kpi-label">Top Bundesland</div>
                        <div class="geo-kpi-value" id="geoTopBundesland">-</div>
                        <div class="geo-kpi-sublabel" id="geoTopBundeslandCount">0 Kunden</div>
                    </div>
                </div>
                
                <div class="geo-kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="geo-kpi-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="geo-kpi-content">
                        <div class="geo-kpi-label">Gesamt Kunden</div>
                        <div class="geo-kpi-value" id="geoTotalCustomers">0</div>
                        <div class="geo-kpi-sublabel" id="geoActiveBundeslaender">in 0 Bundesl√§ndern</div>
                    </div>
                </div>
                
                <div class="geo-kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="geo-kpi-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="geo-kpi-content">
                        <div class="geo-kpi-label">VISION Adoption</div>
                        <div class="geo-kpi-value" id="geoVisionRate">0%</div>
                        <div class="geo-kpi-sublabel" id="geoVisionCount">0 Kunden</div>
                    </div>
                </div>
                
                <div class="geo-kpi-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="geo-kpi-icon">
                        <i class="fas fa-scanner"></i>
                    </div>
                    <div class="geo-kpi-content">
                        <div class="geo-kpi-label">SCANNING Adoption</div>
                        <div class="geo-kpi-value" id="geoScanningRate">0%</div>
                        <div class="geo-kpi-sublabel" id="geoScanningCount">0 Kunden</div>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <input 
                        type="text" 
                        id="geoSearchInput" 
                        placeholder="üîç Bundesland suchen..." 
                        class="w-full px-6 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none transition-all text-lg"
                        onkeyup="filterBundeslandList()"
                    >
                </div>
            </div>
            
            <!-- Main Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Deutschland Karte (2/3 width) -->
                <div class="lg:col-span-2">
                    <div class="glass-card" style="height: 75vh;">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-map mr-2 text-purple-600"></i>Deutschland Heatmap
                            </h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>Klicken zum Filtern
                                </span>
                            </div>
                        </div>
                        <div style="height: calc(100% - 60px); display: flex; flex-direction: column;">
                            <div id="geoMapContainer" style="width: 100%; flex: 1; position: relative;">
                                <!-- SVG Deutschland-Karte wird hier eingef√ºgt -->
                            </div>
                            <div id="mapLegend" class="map-legend-section" style="padding: 16px 12px; background: white; border-top: 1px solid #e5e7eb;">
                                <!-- Legende wird dynamisch bef√ºllt -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bundesl√§nder Ranking (1/3 width) -->
                <div class="lg:col-span-1">
                    <div class="glass-card" style="height: 75vh; overflow-y: auto;">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 sticky top-0 bg-white pb-2 border-b-2 border-gray-100">
                            <i class="fas fa-trophy mr-2 text-yellow-500"></i>Bundesl√§nder Ranking
                        </h4>
                        <div id="bundeslandRankingList" class="space-y-3">
                            <!-- Wird dynamisch bef√ºllt -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customerModal" class="modal-overlay" onclick="closeModalOnClickOutside(event)">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Kundendetails</h2>
                <div class="flex items-center space-x-3">
                    <button id="modalNavPrev" onclick="navigateModalCustomer(-1)" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition-all" title="Vorheriger Kunde">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="modalNavNext" onclick="navigateModalCustomer(1)" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition-all" title="N√§chster Kunde">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button id="modalEditBtn" onclick="toggleModalEdit(true)"
                            class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-all"
                            title="Alle Felder dieses Kunden bearbeiten">
                        <i class="fas fa-edit mr-2"></i>Bearbeiten
                    </button>
                    <button id="modalCancelBtn" onclick="toggleModalEdit(false)"
                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all hidden"
                            title="Bearbeitung abbrechen (Esc)">
                        Abbrechen
                    </button>
                    <button id="modalSaveBtn" onclick="saveCustomerDetails()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all hidden"
                            title="√Ñnderungen in Google Sheets speichern">
                        <i class="fas fa-save mr-2"></i>Speichern
                    </button>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700" title="Modal schlie√üen (Esc)">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent">
                </div>
        </div>
    </div>

    <div id="advancedFilterModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-filter mr-2 text-purple-600"></i>Erweiterter Filter
                </h2>
                <button onclick="closeAdvancedFilterModal()" class="text-gray-500 hover:text-gray-700" title="Modal schlie√üen (Esc)">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-4">Filtern Sie nach beliebigen Spalten aus der Google-Tabelle. Klicken Sie auf eine Kategorie zum Ausklappen.</p>
            <div id="advancedFilterCategories" class="advanced-filter-categories">
                <!-- Wird dynamisch bef√ºllt -->
            </div>
            <div class="flex justify-between items-center mb-4 mt-4">
                <div class="flex gap-3">
                    <button id="previewAdvancedFilterBtn" onclick="previewAdvancedFilter()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-all">
                        <i class="fas fa-calculator mr-2"></i>Anzahl berechnen
                    </button>
                    <button id="resetAdvancedFilterBtn" onclick="resetAdvancedFilter()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                        <i class="fas fa-undo mr-2"></i>Zur√ºcksetzen
                    </button>
                </div>
                <div>
                    <span class="text-gray-600">Gefunden: </span>
                    <span id="advancedFilterCount" class="font-bold text-purple-600 text-xl">0</span>
                    <span class="text-gray-600"> Kunden</span>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeAdvancedFilterModal()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                    Abbrechen
                </button>
                <button id="applyAdvancedFilterBtn" onclick="applyAdvancedFilter()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all">
                    <i class="fas fa-check mr-2"></i>Liste anzeigen
                </button>
            </div>
        </div>
    </div>

    <div id="reasonCustomerModal" class="modal-overlay" onclick="closeReasonModalOnClickOutside(event)">
        <div class="simple-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800" id="reasonModalTitle">Kunden</h2>
                <button onclick="closeReasonModal()" class="text-gray-500 hover:text-gray-700" title="Modal schlie√üen (Esc)">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="reasonModalContent" title="Klicken Sie auf einen Kunden, um dessen Details anzuzeigen">
                <p>Lade Kunden...</p>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay" onclick="closeHelpModalOnClickOutside(event)">
        <div class="simple-modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-keyboard mr-2 text-purple-600"></i>Tastenk√ºrzel
                </h2>
                <button onclick="toggleHelpModal()" class="text-gray-500 hover:text-gray-700" title="Schlie√üen (Esc)">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 mb-4">Nutze diese Tastenk√ºrzel f√ºr schnelleres Arbeiten:</p>
                
                <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Filter-Suche aktivieren</span>
                        <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-mono">Ctrl + K</kbd>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Globale Suche aktivieren</span>
                        <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-mono">Ctrl + Shift + F</kbd>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Modal schlie√üen</span>
                        <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-mono">Esc</kbd>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-3">
                        <i class="fas fa-columns mr-2"></i>Zwischen Tabs wechseln
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí √úbersicht</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 1</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí SalesCockpit</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 2</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí Kundenliste</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 3</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí Matrix-Ansicht</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 4</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí Anrufer-Modus</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 5</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí Gr√ºnde-Analyse</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 6</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-800">‚Üí Geo-Analyse</span>
                            <kbd class="px-2 py-1 bg-white border border-blue-300 rounded text-xs font-mono">Alt + 7</kbd>
                        </div>
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-800">
                        <i class="fas fa-lightbulb mr-2"></i>
                        <strong>Tipp:</strong> Die Tastenk√ºrzel funktionieren auf allen Seiten des Dashboards.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay" onclick="closeInfoModalOnClickOutside(event)">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Dashboard-Anleitung & Informationen
                </h2>
                <button onclick="closeInfoModal()" class="text-gray-500 hover:text-gray-700" title="Schlie√üen (Esc)">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-2">üìä √úber dieses Dashboard</h3>
                    <p class="text-gray-700">Dieses 3D Kunden Dashboard wurde entwickelt, um Ihnen einen umfassenden √úberblick √ºber Ihre Kundendaten zu geben. Die Daten werden live aus Google Sheets geladen und automatisch analysiert.</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-database mr-2 text-purple-600"></i>Datenquelle</h3>
                    <p class="text-gray-700 mb-2">Die Kundendaten stammen aus einem Google Sheets Dokument und werden √ºber eine Web-App-API live synchronisiert.</p>
                    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1">
                        <li><strong>Aktualisierung:</strong> Automatisch beim Laden und auf Knopfdruck</li>
                        <li><strong>Bearbeitung:</strong> √Ñnderungen werden direkt in Google Sheets gespeichert</li>
                        <li><strong>Berechnungen:</strong> Lead Score und Lead Status werden automatisch berechnet</li>
                    </ul>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-cogs mr-2 text-purple-600"></i>Hauptfunktionen</h3>
                    <div class="space-y-3 text-gray-700">
                        <div><strong>üìà √úbersicht:</strong> Zentrale KPIs und dynamische Zusammenfassung mit klickbaren Filtern</div>
                        <div><strong>üîç Kundenliste:</strong> Vollst√§ndige sortierbare Kundentabelle mit Detailansicht</div>
                        <div><strong>üéØ Matrix-Ansicht:</strong> Lead Status vs. Lead Score Kreuztabelle</div>
                        <div><strong>üìû Anrufer-Modus:</strong> Spezialansicht f√ºr Telefon-Akquise</div>
                        <div><strong>üìä Gr√ºnde-Analyse:</strong> Treemap-Visualisierung der Kauf-/Nicht-Kauf-Gr√ºnde</div>
                        <div><strong>üíº SalesCockpit:</strong> Fokus-Modus f√ºr priorit√§re Kunden</div>
                        <div><strong>üó∫Ô∏è Geo-Analyse:</strong> Visualisierung der Kundenverteilung nach Bundesl√§ndern mit Online-PLZ-Validierung</div>
                    </div>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-green-800 mb-3"><i class="fas fa-map-marked-alt mr-2"></i>Geo-Analyse mit Online-Validierung</h3>
                    <p class="text-gray-700 mb-2">Die Geo-Analyse nutzt eine intelligente Online-Validierung f√ºr Postleitzahlen:</p>
                    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1">
                        <li><strong>Automatische PLZ-Korrektur:</strong> Vierstellige Postleitzahlen werden automatisch mit einer f√ºhrenden 0 versehen</li>
                        <li><strong>Online-Validierung:</strong> Beim Laden der Seite werden alle Postleitzahlen √ºber OpenStreetMap validiert</li>
                        <li><strong>Bundesland-Zuordnung:</strong> Pr√§zise Zuordnung von PLZ zu Bundesl√§ndern f√ºr genaue regionale Analysen</li>
                        <li><strong>Moderne Visualisierung:</strong> Farbverlauf zeigt die Kundenverteilung mit interaktiver Legende</li>
                    </ul>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-filter mr-2 text-purple-600"></i>Filter-Funktionen</h3>
                    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1">
                        <li><strong>Dropdown-Filter:</strong> Lead Status, Lead Score, Upsell Status, Sales Rep, Akquise-Typ</li>
                        <li><strong>Header-KPIs:</strong> Klickbare Zahlen f√ºr schnelle Filter (z.B. "X Kunden" zeigt alle)</li>
                        <li><strong>Aktuelle Auswahl:</strong> Farbige Hervorhebung zeigt wichtige Kennzahlen (nur zur Information, nicht klickbar)</li>
                        <li><strong>Erweiterter Filter:</strong> Detaillierte Mehrfachauswahl und Zeitr√§ume</li>
                        <li><strong>Chart-Filter:</strong> Klick auf Diagramm-Elemente filtert entsprechende Kunden</li>
                    </ul>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-calculator mr-2 text-purple-600"></i>Berechnungen</h3>
                    <div class="space-y-2 text-sm">
                        <div class="bg-white p-3 rounded">
                            <strong class="text-purple-700">Lead Score (berechnet):</strong>
                            <ul class="list-disc list-inside ml-4 mt-1 text-gray-600">
                                <li>üî•üî•üî• 10/10 - Hei√üer Lead: Vision=ja UND Scanning=ja UND 3D-Interesse=ja</li>
                                <li>üî•üî• 8/10 - Warmer Lead: 2 von 3 Bedingungen erf√ºllt</li>
                                <li>üî• 5/10 - Interessent: 1 von 3 Bedingungen erf√ºllt</li>
                                <li>‚ùÑÔ∏è 2/10 - Kalt: Keine Bedingungen erf√ºllt</li>
                            </ul>
                        </div>
                        <div class="bg-white p-3 rounded">
                            <strong class="text-purple-700">Lead Status (berechnet):</strong>
                            <ul class="list-disc list-inside ml-4 mt-1 text-gray-600">
                                <li>üèÜ Kunde: Vision ODER Scanning = "ja"</li>
                                <li>üìà Angebot: Lead enth√§lt "Angebot"</li>
                                <li>üí¨ Kontaktiert: Letzter Anruf vorhanden</li>
                                <li>üÜï Neu: Noch kein Kontakt</li>
                            </ul>
                        </div>
                        <div class="bg-white p-3 rounded">
                            <strong class="text-purple-700">Upsell Status:</strong>
                            <ul class="list-disc list-inside ml-4 mt-1 text-gray-600">
                                <li>üí° Upsell-Potenzial: Kunde hat nur 1 Modul (Vision ODER Scanning, nicht beide)</li>
                                <li>‚úÖ Vollausstattung: Beide Module vorhanden</li>
                                <li>- : Noch kein Modul</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-keyboard mr-2 text-purple-600"></i>Tastenk√ºrzel</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-white p-2 rounded"><kbd class="bg-gray-200 px-2 py-1 rounded">Ctrl+K</kbd> Filter-Suche</div>
                        <div class="bg-white p-2 rounded"><kbd class="bg-gray-200 px-2 py-1 rounded">Ctrl+Shift+F</kbd> Globale Suche</div>
                        <div class="bg-white p-2 rounded"><kbd class="bg-gray-200 px-2 py-1 rounded">Esc</kbd> Modal schlie√üen</div>
                        <div class="bg-white p-2 rounded"><kbd class="bg-gray-200 px-2 py-1 rounded">‚Üê/‚Üí</kbd> Im Modal navigieren</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border-l-4 border-purple-500">
                    <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-user mr-2 text-purple-600"></i>Entwickelt von</h3>
                    <p class="text-gray-700"><strong>Peter Scheurer</strong></p>
                    <p class="text-gray-700"><strong>HHK Datentechnik GmbH</strong></p>
                    <p class="text-gray-600 text-sm mt-2">Version 2.0 | November 2025</p>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                    <h3 class="font-bold text-yellow-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Tipps</h3>
                    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1 text-sm">
                        <li>Klicken Sie auf Diagrammelemente, um nach spezifischen Werten zu filtern</li>
                        <li>Nutzen Sie den erweiterten Filter f√ºr Zeitr√§ume (Von/Bis)</li>
                        <li>Der Anrufer-Modus zeigt nur Kunden mit Telefonnummer</li>
                        <li>Exportieren Sie gefilterte Listen als CSV</li>
                        <li>Bearbeiten Sie Kundendaten direkt im Modal und speichern Sie in Google Sheets</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="activeFilterBar">
        <div class="flex items-center gap-3">
            <i class="fas fa-filter"></i>
            <span class="font-semibold" id="filterBarTitle">Filter</span>
            <div id="filterBadgesContainer" class="flex flex-wrap gap-2">
                </div>
        </div>
        <button id="clearFiltersBtn" onclick="clearAllFilters()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <i class="fas fa-times"></i>
            Alle Filter entfernen
        </button>
    </div>
	<script>
        // Google Apps Script Web App URL - WICHTIG: Hier muss die richtige URL eingetragen werden!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbycN1Okn5QnFHY-gQXzRmf1LVm1l8KdW2_pZrHdEtpoZHCoXkK9cQcuoXqKxR0WVggF/exec';
        const API_SECRET = 'p3t3r-ist-d3r-b3st3-2025'; // Sicherheitsschl√ºssel

        // Global variables
        let masterData = [];
        let filteredData = [];
        let charts = {};
        let leafletMap = null;
        let bundeslaenderLayer = null;
        let hoveredBundesland = null;
        let latestBundeslandStats = {};
        let bundeslandLegendCache = { buckets: [], maxValue: 0 };
        let bundeslaenderGeoJSONPromise = null;
        const BUNDESLAND_ALIAS_MAP = {
            'baden w√ºrttemberg': 'Baden-W√ºrttemberg',
            'baden-w√ºrttemberg': 'Baden-W√ºrttemberg',
            'baden wuerttemberg': 'Baden-W√ºrttemberg',
            'baden-wurttemberg': 'Baden-W√ºrttemberg',
            'nordrhein westfalen': 'Nordrhein-Westfalen',
            'nordrhein-westfalen': 'Nordrhein-Westfalen',
            'nordrheinwestfalen': 'Nordrhein-Westfalen',
            'sachsen anhalt': 'Sachsen-Anhalt',
            'sachsen-anhalt': 'Sachsen-Anhalt',
            'mecklenburg vorpommern': 'Mecklenburg-Vorpommern',
            'mecklenburg-vorpommern': 'Mecklenburg-Vorpommern',
            'schleswig holstein': 'Schleswig-Holstein',
            'schleswig-holstein': 'Schleswig-Holstein',
            'thueringen': 'Th√ºringen',
            'thuringen': 'Th√ºringen',
            'freie hansestadt bremen': 'Bremen',
            'freie hansestadt hamburg': 'Hamburg',
            'freistaat bayern': 'Bayern',
            'freistaat sachsen': 'Sachsen',
            'freistaat thueringen': 'Th√ºringen',
            'freistaat thuringen': 'Th√ºringen',
            'land berlin': 'Berlin',
            'land brandenburg': 'Brandenburg',
            'land hessen': 'Hessen',
            'land niedersachsen': 'Niedersachsen',
            'land nordrhein westfalen': 'Nordrhein-Westfalen',
            'land rheinland pfalz': 'Rheinland-Pfalz',
            'land sachsen anhalt': 'Sachsen-Anhalt',
            'land schleswig holstein': 'Schleswig-Holstein',
            'land mecklenburg vorpommern': 'Mecklenburg-Vorpommern'
        };
        const ALL_BUNDESLAENDER = [
            'Baden-W√ºrttemberg', 'Bayern', 'Berlin', 'Brandenburg', 'Bremen',
            'Hamburg', 'Hessen', 'Mecklenburg-Vorpommern', 'Niedersachsen',
            'Nordrhein-Westfalen', 'Rheinland-Pfalz', 'Saarland', 'Sachsen',
            'Sachsen-Anhalt', 'Schleswig-Holstein', 'Th√ºringen'
        ];
        let userName = '';
        let originalHeaders = [];
        let currentModalCustomer = null;
        let contactsByDate = {};
        let calendarDate = new Date();
        let currentModalIndex = -1; // NEU: F√ºr Modal-Navigation
        let navigationContext = {
            type: 'customers', // 'customers', 'cockpit-today', 'cockpit-overdue', 'cockpit-new-leads', 'cockpit-cold-leads', 'calendar', 'reasons-text'
            data: [], // Die aktuelle Liste f√ºr die Navigation
            calendarDate: null // NEU: F√ºr Kalender-Navigation - speichert das aktuelle Datum
        };
        let currentReasonsData = []; // NEU: F√ºr Reasons-Text Navigation
        
        // NEU: Globale Listen f√ºr Cockpit-Navigation
        let cockpitLists = {
            todayTasks: [],
            overdueTasks: [],
            topLeads: [],
            coldLeads: []
        };
        
        // *** NEU: Globaler Status f√ºr Spezialfilter (aus Diagrammen) ***
        let activeSpecialFilter = null; 
        
        // 3. Konstante f√ºr Lead Score Sortierung (ANGEPASST)
        const LEAD_SCORE_ORDER = [
            '‚ùÑÔ∏è (1/10 - Geringes Potenzial)',
            'üî• (4/10 - Potenzial f√ºr 3D-Einstieg)',
            'üî•üî•üî• (6/10 - Upsell-Potenzial Scanning/Abo)', // NEU: Zwischen 4 und 7
            'üî•üî•üî•‚ú® (7/10 - Perfekter 3D-Kandidat)',
            'üî•üî•üî•üî• (8/10 - Demo/Test)',
            'üî•üî•üî•üî•üî• (10/10 - Angebot)',
            'Keine Angabe', // Fallback
            'üèÜ Kunde (Potenzial: Scanning/Abo)', // Kunde-Status 1
            'üèÜ Kunde (Potenzial: Abo)', // Kunde-Status 2
            'üëë Vollkunde' // Kunde-Status 3 (h√∂chste Stufe)
        ];

        // Performance optimization variables
        let searchDebounceTimer = null;
        let filterCache = {};
        const DEBOUNCE_DELAY = 300; // ms

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Benutzername holen oder setzen (beim Laden)
            setUserName(false);

            // Initialize components
            initializeEventListeners();
            initializeTabs();

            // Load data from Google Sheets
            await loadDataFromGoogleSheets();
            
            // NEU: Starte PLZ-Validierung im Hintergrund (nicht-blockierend)
            // Dies l√§uft asynchron und verbessert die Genauigkeit der Geo-Analyse
            validateAllPLZBatch().catch(error => {
                console.warn('PLZ-Validierung konnte nicht durchgef√ºhrt werden:', error);
            });
            
            // Initialize UX enhancements
            addResultsCounter();
            
            // NEU: Lade persistenten Tab
            const lastTab = localStorage.getItem('activeTab');
            if (lastTab) {
                const tabButton = document.querySelector(`[data-tab="${lastTab}"]`);
                if (tabButton) {
                    setTimeout(() => tabButton.click(), 100);
                }
            }
            
            // 5. Live-Nutzer-Ping starten
            await pingActiveUsers(); // Erster Ping sofort
            setInterval(pingActiveUsers, 60000); // Dann alle 60 Sekunden
        });
        
        // ==================== NEU: ERWEITERTER FILTER ====================
        
        // Globale Variable f√ºr den Filter-State
        let savedAdvancedFilterState = {};
        
        function openAdvancedFilterModal() {
            const modal = document.getElementById('advancedFilterModal');
            const container = document.getElementById('advancedFilterCategories');
            
            // Leere den Container
            container.innerHTML = '';
            
            // Spalten, die ausgeschlossen werden sollen
            const excludedColumns = ['Firma', 'Mailadresse', 'Telefonat', 'Gr√ºnde NICHT gekauft (txt)', 'next step'];
            
            // Datumsspalten
            const dateColumns = ['Wann erneuter Kontakt?', 'Letzter Anruf am:'];
            
            // Spalten mit kommagetrennten Werten
            const commaColumns = ['Lead', 'Aktuell verwendete 3D Software', 'Grund NICHT gekauft', 'Grund gekauft', 'Gekaufte Module'];
            
            // Spalten mit Suchfunktion
            const searchableColumns = ['Gekaufte Module'];
            
            // Kategorien definieren
            const categories = {
                'Wer?': ['Sales Rep', 'Anrufer', 'Aquise-Typ'],
                'Module': ['Vision', 'Scanning', 'Gekaufte Module'],
                'Wann?': ['Letzter Anruf am:', 'Wann erneuter Kontakt?'],
                'Lead Infos': ['Lead', 'Lead Status (berechnet)', 'Lead Score (berechnet)', 'Upsell Status'],
                'Software und Gr√ºnde': ['Aktuell verwendete 3D Software', 'Grund gekauft', 'Grund NICHT gekauft'],
                'Weitere': [] // Wird automatisch bef√ºllt
            };
            
            // Alle Spalten sammeln die in Kategorien sind
            const categorizedColumns = new Set();
            Object.values(categories).forEach(cols => {
                cols.forEach(col => categorizedColumns.add(col));
            });
            
            // Restliche Spalten zu "Weitere" hinzuf√ºgen
            originalHeaders.forEach(header => {
                if (!excludedColumns.includes(header) && !categorizedColumns.has(header)) {
                    categories['Weitere'].push(header);
                }
            });
            
            // Erstelle Kategorien
            Object.entries(categories).forEach(([categoryName, columns]) => {
                if (columns.length === 0) return; // √úberspringe leere Kategorien
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'filter-category';
                
                // Header
                const header = document.createElement('div');
                header.className = 'filter-category-header';
                header.innerHTML = `
                    <span><i class="fas fa-folder-open mr-2"></i>${categoryName}</span>
                    <i class="fas fa-chevron-down filter-category-icon"></i>
                `;
                header.onclick = () => toggleFilterCategory(categoryDiv);
                
                // Content
                const content = document.createElement('div');
                content.className = 'filter-category-content';
                
                columns.forEach(columnHeader => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'advanced-filter-field';
                    
                    const label = document.createElement('label');
                    label.textContent = columnHeader;
                    label.htmlFor = `adv-filter-${columnHeader}`;
                    
                    // Badge f√ºr ausgew√§hlte Items (wird sp√§ter aktualisiert)
                    const badge = document.createElement('span');
                    badge.className = 'selection-count-badge';
                    badge.id = `badge-${columnHeader}`;
                    badge.style.display = 'none';
                    label.appendChild(badge);
                    
                    // Label sofort zum DOM hinzuf√ºgen
                    fieldDiv.appendChild(label);
                    
                    // Pr√ºfe ob es ein Datumsfeld ist
                    if (dateColumns.includes(columnHeader)) {
                        // Erstelle Container f√ºr beide Datumsfelder
                        const dateContainer = document.createElement('div');
                        dateContainer.className = 'grid grid-cols-2 gap-2';
                        
                        // Startdatum
                        const startDiv = document.createElement('div');
                        const startLabel = document.createElement('label');
                        startLabel.textContent = 'Von:';
                        startLabel.className = 'text-xs text-gray-600 mb-1 block';
                        const startInput = document.createElement('input');
                        startInput.type = 'date';
                        startInput.id = `adv-filter-${columnHeader}-start`;
                        startInput.className = 'custom-select text-sm';
                        if (savedAdvancedFilterState[`${columnHeader}-start`]) {
                            startInput.value = savedAdvancedFilterState[`${columnHeader}-start`];
                        }
                        startDiv.appendChild(startLabel);
                        startDiv.appendChild(startInput);
                        
                        // Enddatum
                        const endDiv = document.createElement('div');
                        const endLabel = document.createElement('label');
                        endLabel.textContent = 'Bis:';
                        endLabel.className = 'text-xs text-gray-600 mb-1 block';
                        const endInput = document.createElement('input');
                        endInput.type = 'date';
                        endInput.id = `adv-filter-${columnHeader}-end`;
                        endInput.className = 'custom-select text-sm';
                        if (savedAdvancedFilterState[`${columnHeader}-end`]) {
                            endInput.value = savedAdvancedFilterState[`${columnHeader}-end`];
                        }
                        endDiv.appendChild(endLabel);
                        endDiv.appendChild(endInput);
                        
                        // Event-Listener f√ºr Badge-Updates und Preview
                        const updateBadgeAndPreview = () => {
                            const hasStart = startInput.value;
                            const hasEnd = endInput.value;
                            if (hasStart || hasEnd) {
                                badge.textContent = (hasStart && hasEnd) ? '2' : '1';
                                badge.style.display = 'inline-flex';
                            } else {
                                badge.style.display = 'none';
                            }
                            previewAdvancedFilter();
                        };
                        
                        startInput.addEventListener('change', updateBadgeAndPreview);
                        endInput.addEventListener('change', updateBadgeAndPreview);
                        
                        dateContainer.appendChild(startDiv);
                        dateContainer.appendChild(endDiv);
                        fieldDiv.appendChild(dateContainer);
                        
                        // Update Badge
                        const hasStart = savedAdvancedFilterState[`${columnHeader}-start`];
                        const hasEnd = savedAdvancedFilterState[`${columnHeader}-end`];
                        if (hasStart || hasEnd) {
                            badge.textContent = (hasStart && hasEnd) ? '2' : '1';
                            badge.style.display = 'inline-flex';
                        }
                        
                        content.appendChild(fieldDiv);
                        return;
                    }
                    
                    // Einzigartige Werte sammeln
                    const valueSet = new Set();
                    masterData.forEach(row => {
                        const value = row[columnHeader];
                        if (value !== null && value !== undefined && value !== '') {
                            if (commaColumns.includes(columnHeader)) {
                                String(value).split(',').forEach(v => {
                                    const trimmed = v.trim();
                                    if (trimmed) valueSet.add(trimmed);
                                });
                            } else {
                                valueSet.add(String(value));
                            }
                        }
                    });
                    
                    // Sortiere Werte
                    const sortedValues = Array.from(valueSet).sort();
                    
                    // Erstelle Checkbox-Dropdown
                    const dropdownContainer = createCheckboxDropdown(
                        columnHeader, 
                        sortedValues,
                        searchableColumns.includes(columnHeader),
                        savedAdvancedFilterState[columnHeader] || []
                    );
                    
                    fieldDiv.appendChild(dropdownContainer);
                    content.appendChild(fieldDiv);
                });
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                container.appendChild(categoryDiv);
            });
            
            // Zeige Modal
            modal.classList.add('active');
            
            // Aktualisiere alle Badges nach dem Rendern
            setTimeout(() => {
                Object.keys(savedAdvancedFilterState).forEach(columnHeader => {
                    const savedValue = savedAdvancedFilterState[columnHeader];
                    if (savedValue && savedValue.length > 0) {
                        updateCheckboxDropdownButton(columnHeader);
                    }
                });
            }, 0);
            
            // Berechne Anzahl mit gespeicherten Filtern
            if (Object.keys(savedAdvancedFilterState).length > 0) {
                previewAdvancedFilter();
            } else {
                document.getElementById('advancedFilterCount').textContent = masterData.length;
            }
        }
        
        function createCheckboxDropdown(columnName, values, withSearch = false, selectedValues = []) {
            const container = document.createElement('div');
            container.className = 'checkbox-dropdown';
            
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'checkbox-dropdown-button';
            button.id = `adv-filter-btn-${columnName}`;
            
            const buttonText = document.createElement('span');
            buttonText.textContent = 'Ausw√§hlen...';
            buttonText.className = 'button-text';
            
            const selectedCount = document.createElement('span');
            selectedCount.className = 'selected-count';
            selectedCount.style.display = 'none';
            
            button.appendChild(buttonText);
            button.appendChild(selectedCount);
            
            const list = document.createElement('div');
            list.className = 'checkbox-dropdown-list';
            list.id = `adv-filter-list-${columnName}`;
            
            // Suchfeld hinzuf√ºgen wenn gew√ºnscht
            if (withSearch) {
                const searchDiv = document.createElement('div');
                searchDiv.className = 'checkbox-dropdown-search';
                
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Suchen...';
                searchInput.addEventListener('input', (e) => {
                    filterCheckboxDropdownItems(columnName, e.target.value);
                });
                
                searchDiv.appendChild(searchInput);
                list.appendChild(searchDiv);
            }
            
            // Checkbox-Items hinzuf√ºgen
            values.forEach(value => {
                const item = document.createElement('div');
                item.className = 'checkbox-dropdown-item';
                item.dataset.value = value.toLowerCase();
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `adv-filter-${columnName}-${value}`;
                checkbox.value = value;
                checkbox.dataset.column = columnName;
                
                // Setze gespeicherte Auswahl
                if (selectedValues.includes(value)) {
                    checkbox.checked = true;
                }
                
                checkbox.addEventListener('change', () => {
                    updateCheckboxDropdownButton(columnName);
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = value;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                
                // Klick auf Item togglet Checkbox
                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                list.appendChild(item);
            });
            
            // Toggle Button
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const wasActive = list.classList.contains('active');
                
                // Schlie√üe alle anderen Dropdowns
                document.querySelectorAll('.checkbox-dropdown-list.active').forEach(l => {
                    l.classList.remove('active');
                });
                document.querySelectorAll('.checkbox-dropdown-button.active').forEach(b => {
                    b.classList.remove('active');
                });
                
                if (!wasActive) {
                    list.classList.add('active');
                    button.classList.add('active');
                }
            });
            
            container.appendChild(button);
            container.appendChild(list);
            
            // Initiales Update des Buttons
            updateCheckboxDropdownButton(columnName);
            
            return container;
        }
        
        function updateCheckboxDropdownButton(columnName) {
            const button = document.getElementById(`adv-filter-btn-${columnName}`);
            const badge = document.getElementById(`badge-${columnName}`);
            if (!button) return;
            
            const checkboxes = document.querySelectorAll(`input[data-column="${columnName}"]:checked`);
            const buttonText = button.querySelector('.button-text');
            const selectedCount = button.querySelector('.selected-count');
            
            // Aktualisiere Badge neben Label
            if (badge) {
                if (checkboxes.length === 0) {
                    badge.style.display = 'none';
                } else {
                    badge.textContent = checkboxes.length;
                    badge.style.display = 'inline-flex';
                }
            }
            
            // Aktualisiere Button-Text
            if (checkboxes.length === 0) {
                buttonText.textContent = 'Ausw√§hlen...';
                selectedCount.style.display = 'none';
            } else if (checkboxes.length === 1) {
                buttonText.textContent = checkboxes[0].value;
                selectedCount.style.display = 'none';
            } else {
                buttonText.textContent = 'Mehrere ausgew√§hlt';
                selectedCount.textContent = `(${checkboxes.length})`;
                selectedCount.style.display = 'inline';
            }
        }
        
        function filterCheckboxDropdownItems(columnName, searchTerm) {
            const list = document.getElementById(`adv-filter-list-${columnName}`);
            const items = list.querySelectorAll('.checkbox-dropdown-item');
            const search = searchTerm.toLowerCase();
            
            items.forEach(item => {
                const value = item.dataset.value;
                if (value.includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Schlie√üe Dropdowns bei Klick au√üerhalb
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.checkbox-dropdown')) {
                document.querySelectorAll('.checkbox-dropdown-list.active').forEach(list => {
                    list.classList.remove('active');
                });
                document.querySelectorAll('.checkbox-dropdown-button.active').forEach(button => {
                    button.classList.remove('active');
                });
            }
        });
        
        function toggleFilterCategory(categoryDiv) {
            categoryDiv.classList.toggle('collapsed');
        }
        
        function closeAdvancedFilterModal() {
            document.getElementById('advancedFilterModal').classList.remove('active');
        }
        
        function resetAdvancedFilter() {
            // L√∂sche alle Checkboxen
            document.querySelectorAll('#advancedFilterCategories input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // L√∂sche alle Datumsfelder
            document.querySelectorAll('#advancedFilterCategories input[type="date"]').forEach(input => {
                input.value = '';
            });
            
            // Aktualisiere alle Dropdown-Buttons
            const allColumns = Array.from(document.querySelectorAll('[data-column]'))
                .map(el => el.dataset.column)
                .filter((v, i, a) => a.indexOf(v) === i); // unique
            
            allColumns.forEach(col => updateCheckboxDropdownButton(col));
            
            // L√∂sche gespeicherten State
            savedAdvancedFilterState = {};
            
            // Zeige alle Kunden
            document.getElementById('advancedFilterCount').textContent = masterData.length;
            
            showNotification('Filter zur√ºckgesetzt', 'success', 1500);
        }
        
        function previewAdvancedFilter() {
            const filtered = getAdvancedFilteredData();
            document.getElementById('advancedFilterCount').textContent = filtered.length;
        }
        
        function getAdvancedFilteredData() {
            let filtered = [...masterData];
            
            const excludedColumns = ['Firma', 'Mailadresse', 'Telefonat', 'Gr√ºnde NICHT gekauft (txt)', 'next step'];
            const dateColumns = ['Wann erneuter Kontakt?', 'Letzter Anruf am:'];
            const commaColumns = ['Lead', 'Aktuell verwendete 3D Software', 'Grund NICHT gekauft', 'Grund gekauft', 'Gekaufte Module'];
            
            originalHeaders.forEach(header => {
                if (excludedColumns.includes(header)) return;
                
                // Datumsfelder
                if (dateColumns.includes(header)) {
                    const startElement = document.getElementById(`adv-filter-${header}-start`);
                    const endElement = document.getElementById(`adv-filter-${header}-end`);
                    if (!startElement || !endElement) return;
                    
                    const startDate = startElement.value;
                    const endDate = endElement.value;
                    
                    if (startDate || endDate) {
                        filtered = filtered.filter(row => {
                            const cellValue = row[header];
                            if (!cellValue) return false;
                            
                            // Konvertiere ISO-Datum aus Sheet zu Vergleichsformat
                            const cellDate = cellValue.split('T')[0]; // Nimm nur Datum-Teil
                            
                            // Zeitraum-Filterung
                            if (startDate && endDate) {
                                // Von-Bis: Zwischen beiden Daten (inklusiv)
                                return cellDate >= startDate && cellDate <= endDate;
                            } else if (startDate) {
                                // Nur Start: Exakte Suche
                                return cellDate === startDate;
                            } else if (endDate) {
                                // Nur End: Bis zu diesem Datum
                                return cellDate <= endDate;
                            }
                            return true;
                        });
                    }
                    return;
                }
                
                // Checkbox-Felder
                const checkboxes = document.querySelectorAll(`input[data-column="${header}"]:checked`);
                if (checkboxes.length > 0) {
                    const selectedValues = Array.from(checkboxes).map(cb => cb.value);
                    
                    filtered = filtered.filter(row => {
                        const cellValue = row[header];
                        if (cellValue === null || cellValue === undefined) return false;
                        
                        // F√ºr kommaseparierte Spalten
                        if (commaColumns.includes(header)) {
                            const values = String(cellValue).split(',').map(v => v.trim());
                            // Pr√ºfe ob mindestens ein ausgew√§hlter Wert vorhanden ist
                            return selectedValues.some(selectedValue => values.includes(selectedValue));
                        } else {
                            // F√ºr normale Spalten: Pr√ºfe ob der Wert in der Auswahl ist
                            return selectedValues.includes(String(cellValue));
                        }
                    });
                }
            });
            
            return filtered;
        }
        
        function saveAdvancedFilterState() {
            savedAdvancedFilterState = {};
            
            const dateColumns = ['Wann erneuter Kontakt?', 'Letzter Anruf am:'];
            
            // Speichere Datumswerte
            dateColumns.forEach(header => {
                const startElement = document.getElementById(`adv-filter-${header}-start`);
                const endElement = document.getElementById(`adv-filter-${header}-end`);
                if (startElement && startElement.value) {
                    savedAdvancedFilterState[`${header}-start`] = startElement.value;
                }
                if (endElement && endElement.value) {
                    savedAdvancedFilterState[`${header}-end`] = endElement.value;
                }
            });
            
            // Speichere Checkbox-Auswahlen
            const allColumns = Array.from(document.querySelectorAll('[data-column]'))
                .map(el => el.dataset.column)
                .filter((v, i, a) => a.indexOf(v) === i); // unique
            
            allColumns.forEach(column => {
                const checkboxes = document.querySelectorAll(`input[data-column="${column}"]:checked`);
                if (checkboxes.length > 0) {
                    savedAdvancedFilterState[column] = Array.from(checkboxes).map(cb => cb.value);
                }
            });
        }
        
        function applyAdvancedFilter() {
            // Speichere aktuellen Filter-State
            saveAdvancedFilterState();
            
            // Alle normalen Filter zur√ºcksetzen
            document.getElementById('resetFilters').click();
            
            // Filterte Daten setzen
            filteredData = getAdvancedFilteredData();
            
            // Setze Spezialfilter f√ºr die Filterbar
            activeSpecialFilter = {
                type: 'advancedFilter',
                value: `Erweiterter Filter (${filteredData.length} Treffer)`
            };
            
            // UI aktualisieren
            updateDashboard();
            updateCustomerTable();
            updateMatrixView();
            updateAnruferList();
            updateActiveFilterBar();
            
            // Zur Kundenliste wechseln
            document.querySelector('[data-tab="customers"]').click();
            
            // Modal schlie√üen
            closeAdvancedFilterModal();
            
            // Notification
            showNotification(`${filteredData.length} Kunden gefunden`, 'success', 2000);
        }
        
        // ==================== NEU: ZULETZT ANGESEHENE KUNDEN ====================
        
        // ==================== NEU: MODAL NAVIGATION ====================
        
        function setNavigationContext(type, data = [], calendarDate = null) {
            navigationContext.type = type;
            navigationContext.data = data;
            navigationContext.calendarDate = calendarDate;
        }
        
        // Wrapper-Funktionen zum √ñffnen mit Kontext
        function openCustomerFromList(encodedFirma) {
            setNavigationContext('customers', filteredData);
            showCustomerDetailsByFirma(encodedFirma);
        }
        
        function openCustomerFromCockpit(encodedFirma, listType, listData) {
            setNavigationContext(listType, listData);
            showCustomerDetailsByFirma(encodedFirma);
        }
        
        function openCustomerFromReasons(encodedFirma, reasonsData) {
            setNavigationContext('reasons-text', reasonsData);
            showCustomerDetailsByFirma(encodedFirma);
        }
        
        // NEU: Spezielle Funktion f√ºr Kalender mit Datum
        function openCustomerFromCalendar(encodedFirma, dateKey) {
            const customersOnDate = contactsByDate[dateKey] || [];
            setNavigationContext('calendar', customersOnDate, dateKey);
            showCustomerDetailsByFirma(encodedFirma);
        }
        
        function navigateModalCustomer(direction) {
            const newIndex = currentModalIndex + direction;
            
            // Verwende die Kontext-Daten f√ºr Navigation
            const dataSource = navigationContext.data.length > 0 ? navigationContext.data : filteredData;
            
            // Pr√ºfe Grenzen
            if (newIndex < 0 || newIndex >= dataSource.length) {
                return;
            }
            
            const nextCustomer = dataSource[newIndex];
            const encodedFirma = encodeURIComponent(nextCustomer['Firma'] || '');
            showCustomerDetailsByFirma(encodedFirma);
        }
        
        function updateModalNavButtons() {
            const prevBtn = document.getElementById('modalNavPrev');
            const nextBtn = document.getElementById('modalNavNext');
            
            if (prevBtn && nextBtn) {
                const dataSource = navigationContext.data.length > 0 ? navigationContext.data : filteredData;
                
                prevBtn.disabled = (currentModalIndex <= 0);
                nextBtn.disabled = (currentModalIndex >= dataSource.length - 1);
                
                // Styling f√ºr deaktivierte Buttons
                if (prevBtn.disabled) {
                    prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                if (nextBtn.disabled) {
                    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        
        // ==================== ENDE NEUE FUNKTIONEN ====================
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Benutzername holen oder setzen (beim Laden)
            setUserName(false);

            // Initialize components
            initializeEventListeners();
            initializeTabs();

            // Load data from Google Sheets
            await loadDataFromGoogleSheets();
            
            // Initialize UX enhancements
            addResultsCounter();
            
            // 5. Live-Nutzer-Ping starten
            await pingActiveUsers(); // Erster Ping sofort
            setInterval(pingActiveUsers, 60000); // Dann alle 60 Sekunden
        });
        
        // 1. Funktion zum Setzen/√Ñndern des Benutzernamens (KORRIGIERT)
        function setUserName(forcePrompt = false) {
            let currentName = localStorage.getItem('userName');
            if (forcePrompt) {
                // Aufruf durch Button-Klick: Immer Prompt anzeigen
                let newName = prompt('Bitte gib deinen Namen ein:', currentName || 'Gast');
                if (newName && newName.trim() !== '') {
                    userName = newName.trim();
                    localStorage.setItem('userName', userName);
                } else if (newName === null) {
                    // User hat "Abbrechen" geklickt, nichts tun
                } else {
                    // User hat leeren String eingegeben, nichts tun
                }
            } else {
                // 1. KORREKTUR: Aufruf beim initialen Laden: NICHT prompten, nur Standard setzen
                userName = currentName || 'Gast';
                localStorage.setItem('userName', userName);
            }
            document.getElementById('userName').textContent = userName;
            // 5. Ping erneut ausl√∂sen, falls sich der Name ge√§ndert hat
            if(forcePrompt) pingActiveUsers();
        }
        
        // 5. Neue Funktion f√ºr Live-Nutzer-Ping
        async function pingActiveUsers() {
            if (!userName || userName === 'Gast') {
                document.getElementById('onlineUsers').innerHTML = `<i class="fas fa-circle text-gray-400 text-xs mr-1"></i> Live-Status (als Gast inaktiv)`;
                return; // Nicht pingen, wenn "Gast"
            }
            
            try {
                const response = await fetch(`${WEB_APP_URL}?secret=${API_SECRET}&action=ping&name=${encodeURIComponent(userName)}`);
                if (!response.ok) return;
                
                const result = await response.json();
                
                if (result.status === 'Erfolg' && result.activeUsers) {
                    const onlineSpan = document.getElementById('onlineUsers');
                    if (result.activeUsers.length > 0) {
                        onlineSpan.innerHTML = `<i class="fas fa-circle text-green-500 text-xs mr-1"></i> Live: <span class="font-semibold">${result.activeUsers.join(', ')}</span>`;
                        onlineSpan.title = "Nutzer, die in den letzten 5 Minuten aktiv waren.";
                    } else {
                        onlineSpan.innerHTML = `<i class="fas fa-circle text-gray-400 text-xs mr-1"></i> Live: Niemand aktiv`;
                        onlineSpan.title = "Keine anderen Nutzer in den letzten 5 Minuten aktiv.";
                    }
                }
            } catch (error) {
                console.warn('Ping-Fehler:', error);
                const onlineSpan = document.getElementById('onlineUsers');
                onlineSpan.innerHTML = `<i class="fas fa-circle text-yellow-500 text-xs mr-1"></i> Live-Statusfehler`;
            }
        }

        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            // Reset refresh button
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.remove('bg-yellow-200', 'text-yellow-800', 'border-yellow-500');
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Aktualisieren';

            try {
                const response = await fetch(`${WEB_APP_URL}?secret=${API_SECRET}&action=getData`);

                if (!response.ok) {
                    throw new Error('Netzwerkfehler beim Laden der Daten');
                }

                const result = await response.json();
                
                if (result.status === 'Erfolg' && result.data) {
                    // 1. Leere Zeilen filtern
                    masterData = result.data.filter(row => row['Firma'] && row['Firma'].trim() !== '');
                    
                    originalHeaders = Object.keys(masterData[0] || {});
                    filteredData = [...masterData];
                    
                    // Update UI
                    initializeFilters();
                    initializeCharts();
                    
                    // 2. updateDashboard() ruft jetzt updateSalesCockpit() auf
                    updateDashboard(); 
                    
                    updateCustomerTable();
                    updateMatrixView();
                    updateAnruferList();
                    updateCompanyAutocomplete();
                    
                    // Update last update time
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = 
                        now.toLocaleDateString('de-DE') + ' ' + now.toLocaleTimeString('de-DE');
                    
                    console.log('Daten erfolgreich geladen:', masterData.length, 'Eintr√§ge');
                } else {
                    throw new Error(result.message || 'Fehler beim Laden der Daten');
                }
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                alert('Fehler beim Laden der Daten. Bitte pr√ºfen Sie die Verbindung und versuchen Sie es erneut.');
            } finally {
                loadingOverlay.classList.remove('active');
            }
        }
		
        // *** ANGEPASST: populateFilter behandelt jetzt kommaseparierte Werte ***
        function initializeFilters() {
            // Helper function
            const populateFilter = (elementId, columnKey, defaultText) => {
                const valueSet = new Set();
                
                // *** NEUE LOGIK f√ºr Multi-Select-Spalten ***
                if (columnKey === 'Lead' || columnKey === 'Aktuell verwendete 3D Software' || columnKey === 'Grund NICHT gekauft' || columnKey === 'Grund gekauft') {
                    masterData.forEach(d => {
                        const valuesStr = d[columnKey];
                        if (valuesStr) {
                            valuesStr.split(',').forEach(v => {
                                const trimmed = v.trim();
                                if (trimmed) valueSet.add(trimmed);
                            });
                        }
                    });
                } else if (columnKey === 'Bundesland') {
                    masterData.forEach(d => {
                        const normalized = normalizeBundeslandName(d[columnKey]);
                        if (normalized) valueSet.add(normalized);
                    });
                } else {
                    // Alte Logik f√ºr Single-Select-Spalten
                    masterData.forEach(d => {
                        if (d[columnKey]) valueSet.add(d[columnKey]);
                    });
                }

                const values = [...valueSet];
                
                if (columnKey === 'Lead Score (berechnet)') {
                    values.sort(sortLeadScores);
                } else {
                    values.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
                }
                
                const filterElement = document.getElementById(elementId);
                filterElement.innerHTML = `<option value="all">${defaultText}</option>`;
                values.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    filterElement.appendChild(option);
                });
            };

            populateFilter('salesRepFilter', 'Sales Rep', 'Alle Sales Reps');
            populateFilter('akquiseTypFilter', 'Aquise-Typ', 'Alle Akquise-Typen');
            populateFilter('leadScoreFilter', 'Lead Score (berechnet)', 'Alle Lead Scores (ber.)');
            populateFilter('leadStatusBerechnetFilter', 'Lead Status (berechnet)', 'Alle Lead Status (ber.)');
            populateFilter('leadFilter', 'Lead', 'Alle Leads');
            populateFilter('upsellStatusFilter', 'Upsell Status', 'Alle Upsell Status');
            populateFilter('bundeslandFilter', 'Bundesland', 'Alle Bundesl√§nder');
        }

        // --- Geo-Analyse Funktionen ---
        
        // NEUE FUNKTIONEN: Online-PLZ-Validierung
        
        // Cache f√ºr PLZ-zu-Bundesland-Zuordnungen
        const plzCache = new Map();
        let plzValidationInProgress = false;
        
        // Funktion zur Online-Validierung einer PLZ via Nominatim API
        async function validatePLZOnline(plz) {
            if (!plz) return null;
            
            // Normalisiere PLZ (f√ºhrende Nullen hinzuf√ºgen wenn nur 4 Stellen)
            let cleanedPLZ = String(plz).replace(/\D/g, '').trim();
            
            // Pr√ºfe auf g√ºltige L√§nge
            if (cleanedPLZ.length < 1 || cleanedPLZ.length > 5) {
                console.warn(`Ung√ºltige PLZ-L√§nge: ${cleanedPLZ}`);
                return null;
            }
            
            // WICHTIG: Bei 4-stelliger PLZ f√ºhrende 0 hinzuf√ºgen
            if (cleanedPLZ.length === 4) {
                cleanedPLZ = '0' + cleanedPLZ;
            }
            
            // Nur 5-stellige PLZ sind g√ºltig
            if (cleanedPLZ.length !== 5) {
                console.warn(`PLZ hat nicht 5 Stellen: ${cleanedPLZ}`);
                return null;
            }
            
            // Pr√ºfe Cache
            if (plzCache.has(cleanedPLZ)) {
                return plzCache.get(cleanedPLZ);
            }
            
            try {
                // Verwende OpenPLZ API f√ºr PLZ-Validierung
                // API Dokumentation: https://www.openplzapi.org/de/
                // Korrekter Endpunkt: /de/Localities mit postalCode Parameter
                const response = await fetch(
                    `https://openplzapi.org/de/Localities?postalCode=${cleanedPLZ}`,
                    {
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    console.warn(`API-Fehler f√ºr PLZ ${cleanedPLZ}: ${response.status}`);
                    return null;
                }
                
                const data = await response.json();
                
                // OpenPLZ API gibt ein Array von Orten zur√ºck
                // Jeder Ort hat eine federalState Eigenschaft mit Name und Key
                if (data && Array.isArray(data) && data.length > 0 && data[0].federalState) {
                    const bundesland = data[0].federalState.name; // Der vollst√§ndige Bundeslandname
                    
                    // Speichere im Cache
                    plzCache.set(cleanedPLZ, bundesland);
                    
                    console.log(`‚úì PLZ ${cleanedPLZ} ‚Üí ${bundesland} (${data[0].name})`);
                    return bundesland;
                }
                
                console.warn(`Keine Daten f√ºr PLZ ${cleanedPLZ} gefunden`);
                return null;
            } catch (error) {
                console.warn(`Fehler bei PLZ-Validierung f√ºr ${cleanedPLZ}:`, error);
                return null;
            }
        }
        
        // Batch-Validierung aller PLZ beim Laden
        async function validateAllPLZBatch() {
            if (plzValidationInProgress) return;
            plzValidationInProgress = true;
            
            console.log('üîÑ Starte PLZ-Validierung mit OpenPLZ API...');
            
            // Sammle alle einzigartigen PLZ aus den Daten
            const uniquePLZ = new Set();
            masterData.forEach(customer => {
                let plz = customer['PLZ'];
                if (plz) {
                    plz = String(plz).replace(/\D/g, '').trim();
                    // Bei 4 Stellen: f√ºhrende 0 hinzuf√ºgen
                    if (plz.length === 4) plz = '0' + plz;
                    // Nur g√ºltige 5-stellige PLZ verarbeiten
                    if (plz.length === 5) uniquePLZ.add(plz);
                }
            });
            
            console.log(`üìã ${uniquePLZ.size} eindeutige PLZ gefunden`);
            
            // Validiere jede PLZ (mit Rate-Limiting: max 2 Requests pro Sekunde)
            let count = 0;
            let successCount = 0;
            let cacheHits = 0;
            
            for (const plz of uniquePLZ) {
                if (plzCache.has(plz)) {
                    cacheHits++;
                    continue; // Bereits im Cache
                }
                
                // Rate-Limiting: Warte 600ms zwischen Anfragen (ca. 1.7 pro Sekunde, um sicher zu gehen)
                await new Promise(resolve => setTimeout(resolve, 600));
                
                const bundesland = await validatePLZOnline(plz);
                count++;
                
                if (bundesland) {
                    successCount++;
                }
                
                // Status-Update alle 10 Validierungen
                if (count % 10 === 0) {
                    console.log(`‚è≥ ${count} von ${uniquePLZ.size - cacheHits} PLZ validiert (${successCount} erfolgreich)`);
                }
            }
            
            console.log(`‚úÖ PLZ-Validierung abgeschlossen`);
            console.log(`   ‚îú‚îÄ Gesamt: ${uniquePLZ.size} eindeutige PLZ`);
            console.log(`   ‚îú‚îÄ Cache-Treffer: ${cacheHits}`);
            console.log(`   ‚îú‚îÄ Neu validiert: ${count}`);
            console.log(`   ‚îî‚îÄ Erfolgreich: ${successCount} (${Math.round(successCount / count * 100)}%)`);
            
            plzValidationInProgress = false;
            
            // Aktualisiere die Geo-Ansicht nach Validierung
            if (currentTab === 'geo') {
                updateGeoChart();
            }
        }
        
        // Hilfsfunktion: PLZ zu Bundesland mappen (verbessert mit Online-Validierung)
        function getBundeslandByPLZ(plz) {
            if (!plz) return null;

            // Bereinige die PLZ: Entferne alle nicht-numerischen Zeichen
            let cleanedPLZ = String(plz).replace(/\D/g, '').trim();
            if (!cleanedPLZ || cleanedPLZ.length < 1) return null;
            
            // SCHRITT 1: Pr√ºfe die L√§nge und korrigiere falls n√∂tig
            if (cleanedPLZ.length === 4) {
                // 4-stellige PLZ: F√ºge eine 0 vorne an (z.B. 1069 ‚Üí 01069)
                cleanedPLZ = '0' + cleanedPLZ;
            } else if (cleanedPLZ.length === 3) {
                // 3-stellige PLZ: F√ºge zwei 0en vorne an
                cleanedPLZ = '00' + cleanedPLZ;
            } else if (cleanedPLZ.length === 2) {
                // 2-stellige PLZ: F√ºge drei 0en vorne an
                cleanedPLZ = '000' + cleanedPLZ;
            } else if (cleanedPLZ.length === 1) {
                // 1-stellige PLZ: F√ºge vier 0en vorne an
                cleanedPLZ = '0000' + cleanedPLZ;
            } else if (cleanedPLZ.length > 5) {
                // Mehr als 5 Ziffern: Nehme nur die ersten 5
                cleanedPLZ = cleanedPLZ.substring(0, 5);
            }
            
            // SCHRITT 2: Jetzt sollten wir immer 5 Ziffern haben
            if (cleanedPLZ.length !== 5) {
                return null; // Sicherheitscheck
            }
            
            // NEU: Pr√ºfe zuerst den Online-Cache
            if (plzCache.has(cleanedPLZ)) {
                return plzCache.get(cleanedPLZ);
            }
            
            // FALLBACK: Verwende die lokale PLZ-Zuordnung wenn nicht im Cache
            // SCHRITT 3: Extrahiere die ersten 2 Ziffern f√ºr die Zuordnung
            const firstTwo = parseInt(cleanedPLZ.substring(0, 2));
            
            // PLZ-Bereiche f√ºr deutsche Bundesl√§nder (vollst√§ndig und korrekt)
            
            // WICHTIG: Sachsen-Anhalt (06xxx und 39xxx) muss VOR Sachsen gepr√ºft werden!
            if (firstTwo === 6 || firstTwo === 39) return 'Sachsen-Anhalt';
            
            // Sachsen (00-09, ABER ohne 06 - siehe oben)
            if (firstTwo >= 0 && firstTwo <= 9) return 'Sachsen';
            
            // Berlin (10-14), Brandenburg (15-19)
            if (firstTwo >= 10 && firstTwo <= 14) return 'Berlin';
            if (firstTwo >= 15 && firstTwo <= 19) return 'Brandenburg';
            
            // Hamburg (20-21), Schleswig-Holstein (22-25)
            if (firstTwo >= 20 && firstTwo <= 21) return 'Hamburg';
            if (firstTwo >= 22 && firstTwo <= 25) return 'Schleswig-Holstein';
            
            // Bremen (26-27), Niedersachsen (28-29, 30-38, 49)
            if (firstTwo >= 26 && firstTwo <= 27) return 'Bremen';
            if (firstTwo >= 28 && firstTwo <= 29) return 'Niedersachsen';
            if (firstTwo >= 30 && firstTwo <= 38) return 'Niedersachsen';
            if (firstTwo === 49) return 'Niedersachsen';
            
            // Nordrhein-Westfalen (40-48, 50-53, 57-59)
            if (firstTwo >= 40 && firstTwo <= 48) return 'Nordrhein-Westfalen';
            if (firstTwo >= 50 && firstTwo <= 53) return 'Nordrhein-Westfalen';
            if (firstTwo >= 57 && firstTwo <= 59) return 'Nordrhein-Westfalen';
            
            // Rheinland-Pfalz (54-56, 67-69)
            if (firstTwo >= 54 && firstTwo <= 56) return 'Rheinland-Pfalz';
            if (firstTwo >= 67 && firstTwo <= 69) return 'Rheinland-Pfalz';
            
            // Hessen (60-65)
            if (firstTwo >= 60 && firstTwo <= 65) return 'Hessen';
            
            // Saarland (66)
            if (firstTwo === 66) return 'Saarland';
            
            // Baden-W√ºrttemberg (70-76, 77-79)
            if (firstTwo >= 70 && firstTwo <= 76) return 'Baden-W√ºrttemberg';
            if (firstTwo >= 77 && firstTwo <= 79) return 'Baden-W√ºrttemberg';
            
            // Bayern (80-97)
            if (firstTwo >= 80 && firstTwo <= 97) return 'Bayern';
            
            // Th√ºringen (98-99)
            if (firstTwo >= 98 && firstTwo <= 99) return 'Th√ºringen';

            // Unbekannt (sollte nicht vorkommen bei korrekten deutschen PLZ)
            return null;
        }

        function normalizeBundeslandName(name) {
            if (!name) return '';
            const trimmed = String(name).trim();
            if (!trimmed) return '';

            const asciiNormalized = trimmed
                .replace(/√ü/g, 'ss')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
            const key = asciiNormalized
                .toLowerCase()
                .replace(/[^a-z\s-]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            if (BUNDESLAND_ALIAS_MAP[key]) {
                return BUNDESLAND_ALIAS_MAP[key];
            }

            return trimmed;
        }

        function getCustomerBundesland(customer) {
            if (!customer) return null;
            const fromSheet = normalizeBundeslandName(customer['Bundesland']);
            if (fromSheet) return fromSheet;

            return null;
        }

        function getFeatureBundeslandName(feature) {
            if (!feature || !feature.properties) return '';
            const props = feature.properties;
            return normalizeBundeslandName(
                props.name || props.NAME_1 || props.GEN || props.krs_name || props.kreis_name || props.BEZ || ''
            );
        }

        function getChoroplethColor(value) {
            if (!value || value <= 0) return 'rgba(226, 232, 240, 0.8)';
            if (value <= 5) return 'rgba(167, 139, 250, 0.65)';
            if (value <= 10) return 'rgba(139, 92, 246, 0.75)';
            if (value <= 20) return 'rgba(124, 58, 237, 0.85)';
            if (value <= 50) return 'rgba(109, 40, 217, 0.9)';
            return 'rgba(91, 33, 182, 0.95)';
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function loadBundeslaenderGeoJSON() {
            if (bundeslaenderGeoJSONPromise) {
                return bundeslaenderGeoJSONPromise;
            }

            bundeslaenderGeoJSONPromise = fetch('https://unpkg.com/deutschland-geojson@3.0.1/deutschland/bundeslaender.geo.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Antwort des GeoJSON-Servers war nicht erfolgreich');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Bundesl√§nder-GeoJSON:', error);
                    return null;
                })
                .then(result => {
                    if (!result) {
                        bundeslaenderGeoJSONPromise = null;
                    }
                    return result;
                });

            return bundeslaenderGeoJSONPromise;
        }

        function initializeGeoMapChart() {
            const container = document.getElementById('geoMapContainer');
            if (!container) return;

            if (!leafletMap) {
                container.innerHTML = '';
                leafletMap = L.map(container, {
                    zoomControl: true,
                    attributionControl: false
                }).setView([51.163, 10.447], 6);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(leafletMap);

                setTimeout(() => {
                    leafletMap.invalidateSize();
                }, 150);
            }

            loadBundeslaenderGeoJSON().then(geojson => {
                if (!geojson) {
                    container.innerHTML = '<div class="flex items-center justify-center h-full text-sm text-red-500">Konnte Bundesl√§nder-GeoJSON nicht laden.</div>';
                    return;
                }

                if (bundeslaenderLayer) {
                    updateGeoMapColors();
                    return;
                }

                bundeslaenderLayer = L.geoJSON(geojson, {
                    style: feature => ({
                        weight: 1.5,
                        color: '#ffffff',
                        fillOpacity: 0.85,
                        fillColor: getChoroplethColor((latestBundeslandStats[getFeatureBundeslandName(feature)] || {}).total || 0)
                    }),
                    onEachFeature: (feature, layer) => {
                        const name = getFeatureBundeslandName(feature);
                        layer.options.title = name;
                        layer.on({
                            mouseover: () => handleBundeslandHover(name, layer),
                            mouseout: () => handleBundeslandOut(layer),
                            click: () => selectBundesland(name)
                        });
                    }
                }).addTo(leafletMap);

                updateGeoMapColors();
            });
        }

        function handleBundeslandHover(name, layer) {
            hoveredBundesland = name;
            if (layer && layer.bringToFront) {
                layer.bringToFront();
            }
            updateGeoMapColors();
        }

        function handleBundeslandOut() {
            hoveredBundesland = null;
            updateGeoMapColors();
        }

        function getDataForBundesland(bundeslandName) {
            const normalized = normalizeBundeslandName(bundeslandName);
            const data = latestBundeslandStats[normalized];
            if (data) {
                return { ...data };
            }
            return { total: 0, vision: 0, scanning: 0 };
        }

        function updateGeoMapColors() {
            updateMapLegend(latestBundeslandStats, hoveredBundesland);

            if (!bundeslaenderLayer) {
                return;
            }

            bundeslaenderLayer.eachLayer(layer => {
                const name = getFeatureBundeslandName(layer.feature);
                const stats = latestBundeslandStats[name] || { total: 0 };
                const isHovered = hoveredBundesland && hoveredBundesland === name;

                layer.setStyle({
                    weight: isHovered ? 2.5 : 1.5,
                    color: isHovered ? '#4c1d95' : '#ffffff',
                    fillOpacity: isHovered ? 0.95 : (stats.total > 0 ? 0.85 : 0.6),
                    fillColor: getChoroplethColor(stats.total)
                });

                if (isHovered && layer.bringToFront) {
                    layer.bringToFront();
                }
            });
        }

        function computeLegendBuckets(values) {
            const base = [{ label: 'Keine Kunden', color: 'rgba(226, 232, 240, 0.8)' }];
            if (!values || values.length === 0) {
                bundeslandLegendCache = { buckets: base, maxValue: 0 };
                return bundeslandLegendCache;
            }

            const maxValue = Math.max(...values);
            const buckets = [...base];

            if (maxValue <= 10) {
                buckets.push({ label: '1-5 Kunden', color: 'rgba(167, 139, 250, 0.65)' });
                if (maxValue > 5) {
                    buckets.push({ label: '6-10 Kunden', color: 'rgba(139, 92, 246, 0.75)' });
                }
            } else if (maxValue <= 50) {
                buckets.push({ label: '1-5 Kunden', color: 'rgba(167, 139, 250, 0.65)' });
                buckets.push({ label: '6-10 Kunden', color: 'rgba(139, 92, 246, 0.75)' });
                if (maxValue > 10) {
                    buckets.push({ label: '11-20 Kunden', color: 'rgba(124, 58, 237, 0.85)' });
                }
                if (maxValue > 20) {
                    buckets.push({ label: '21-50 Kunden', color: 'rgba(109, 40, 217, 0.9)' });
                }
            } else {
                buckets.push({ label: '1-5 Kunden', color: 'rgba(167, 139, 250, 0.65)' });
                buckets.push({ label: '6-10 Kunden', color: 'rgba(139, 92, 246, 0.75)' });
                buckets.push({ label: '11-20 Kunden', color: 'rgba(124, 58, 237, 0.85)' });
                buckets.push({ label: '21-50 Kunden', color: 'rgba(109, 40, 217, 0.9)' });
                buckets.push({ label: '50+ Kunden', color: 'rgba(91, 33, 182, 0.95)' });
            }

            bundeslandLegendCache = { buckets, maxValue };
            return bundeslandLegendCache;
        }

        function updateMapLegend(bundeslandData = latestBundeslandStats, hoveredName = hoveredBundesland) {
            const legendContainer = document.getElementById('mapLegend');
            if (!legendContainer) return;

            const values = Object.values(bundeslandData || {}).map(d => d.total).filter(v => v > 0);
            const { buckets, maxValue } = computeLegendBuckets(values);

            const scaleHtml = buckets.map(item => `
                <div class="map-legend-item">
                    <span class="map-legend-color" style="background: ${item.color};"></span>
                    <span>${item.label}</span>
                </div>
            `).join('');

            let infoHtml = '<div>Fahre √ºber ein Bundesland, um Details zu sehen.</div>';
            if (hoveredName && bundeslandData && bundeslandData[hoveredName]) {
                const stats = bundeslandData[hoveredName];
                infoHtml = `
                    <div><strong>${escapeHtml(hoveredName)}</strong></div>
                    <div>üë• ${stats.total} Kunden</div>
                    <div>üëÅÔ∏è ${stats.vision} Vision Nutzer</div>
                    <div>üîç ${stats.scanning} Scanning Nutzer</div>
                `;
            } else if (maxValue === 0) {
                infoHtml = '<div>Keine Kundendaten verf√ºgbar.</div>';
            }

            legendContainer.innerHTML = `
                <div class="map-legend-scale">${scaleHtml || '<div class="text-xs text-gray-400">Keine Kundendaten</div>'}</div>
                <div class="map-legend-info">${infoHtml}</div>
            `;
        }
        
        // Initialisiere Balkendiagramm f√ºr Geo-Analyse
        
        // Aktualisiere Geo-Tab mit modernem Design
        function updateGeoChart() {
            // Aggregiere nach Bundesland
            const bundeslandData = {};
            ALL_BUNDESLAENDER.forEach(bl => {
                bundeslandData[bl] = { total: 0, vision: 0, scanning: 0 };
            });
            let totalVision = 0;
            let totalScanning = 0;

            // Z√§hle ALLE Kunden und kategorisiere sie
            filteredData.forEach(customer => {
                const bundesland = getCustomerBundesland(customer);
                if (bundesland) {
                    // Initialisiere Bundesland-Eintrag falls nicht vorhanden
                    if (!bundeslandData[bundesland]) {
                        bundeslandData[bundesland] = {
                            total: 0,
                            vision: 0,
                            scanning: 0
                        };
                    }
                    
                    // Z√§hle Gesamtkunden
                    bundeslandData[bundesland].total++;
                    
                    // Z√§hle VISION User
                    if (customer['Vision'] === 'ja') {
                        bundeslandData[bundesland].vision++;
                        totalVision++;
                    }
                    
                    // Z√§hle SCANNING User
                    if (customer['Scanning'] === 'ja') {
                        bundeslandData[bundesland].scanning++;
                        totalScanning++;
                    }
                }
            });

            latestBundeslandStats = bundeslandData;
            initializeGeoMapChart();
            
            // Berechne Gesamt-Statistiken
            const totalCustomers = filteredData.length;
            const activeBundeslaender = Object.values(bundeslandData).filter(entry => entry.total > 0).length;
            const visionRate = totalCustomers > 0 ? ((totalVision / totalCustomers) * 100).toFixed(1) : 0;
            const scanningRate = totalCustomers > 0 ? ((totalScanning / totalCustomers) * 100).toFixed(1) : 0;
            
            // Finde Top Bundesland
            const sortedBundeslaender = Object.entries(bundeslandData)
                .filter(([, data]) => data.total > 0)
                .sort((a, b) => b[1].total - a[1].total);
            const topBundesland = sortedBundeslaender.length > 0 ? sortedBundeslaender[0] : null;
            
            // Update KPI Cards mit Animationen
            updateGeoKPI('geoTopBundesland', topBundesland ? topBundesland[0] : '-');
            updateGeoKPI('geoTopBundeslandCount', topBundesland ? `${topBundesland[1].total} Kunden` : '0 Kunden');
            updateGeoKPI('geoTotalCustomers', totalCustomers.toLocaleString('de-DE'));
            updateGeoKPI('geoActiveBundeslaender', `in ${activeBundeslaender} Bundesl√§ndern`);
            updateGeoKPI('geoVisionRate', `${visionRate}%`);
            updateGeoKPI('geoVisionCount', `${totalVision} Kunden`);
            updateGeoKPI('geoScanningRate', `${scanningRate}%`);
            updateGeoKPI('geoScanningCount', `${totalScanning} Kunden`);
            
            // Update Bundesland Ranking Liste
            updateBundeslandRankingList(sortedBundeslaender);
            
            // Update Leaflet-Karte
            updateGeoMapColors();
        }
        
        // Hilfsfunktion: Animierte KPI Updates
        function updateGeoKPI(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                // Kurze Fade-Animation
                element.style.opacity = '0.5';
                element.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    element.textContent = value;
                    element.style.opacity = '1';
                    element.style.transform = 'scale(1)';
                }, 150);
                
                element.style.transition = 'all 0.3s ease';
            }
        }
        
        // Bundesland Ranking Liste erstellen
        function updateBundeslandRankingList(sortedBundeslaender) {
            const container = document.getElementById('bundeslandRankingList');
            if (!container) return;
            
            if (sortedBundeslaender.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine Daten verf√ºgbar</p>';
                return;
            }
            
            // Finde Maximum f√ºr Prozentbalken
            const maxCount = sortedBundeslaender[0][1].total;
            
            container.innerHTML = sortedBundeslaender.map(([bundesland, data], index) => {
                const rank = index + 1;
                const percentage = maxCount > 0 ? (data.total / maxCount) * 100 : 0;
                const visionRate = data.total > 0 ? ((data.vision / data.total) * 100).toFixed(0) : 0;
                const scanningRate = data.total > 0 ? ((data.scanning / data.total) * 100).toFixed(0) : 0;
                const safeBundesland = escapeHtml(bundesland);

                // Rank Badge Klasse
                let rankClass = 'rank-other';
                let rankIcon = '';
                if (rank === 1) {
                    rankClass = 'rank-1';
                    rankIcon = '<i class="fas fa-crown ml-1"></i>';
                } else if (rank === 2) {
                    rankClass = 'rank-2';
                    rankIcon = '<i class="fas fa-medal ml-1"></i>';
                } else if (rank === 3) {
                    rankClass = 'rank-3';
                    rankIcon = '<i class="fas fa-award ml-1"></i>';
                }

                return `
                    <div class="bundesland-item" onclick="selectBundesland('${bundesland}')" data-bundesland="${safeBundesland}">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="bundesland-rank ${rankClass}">${rank}${rankIcon}</span>
                                <span class="bundesland-name">${safeBundesland}</span>
                            </div>
                            <span class="text-2xl font-bold text-purple-600">${data.total}</span>
                        </div>

                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                        
                        <div class="bundesland-stats">
                            <div class="stat-item">
                                <div class="stat-value" style="color: #667eea;">${data.vision}</div>
                                <div class="stat-label">üëÅÔ∏è Vision</div>
                                <div class="text-xs text-gray-500 mt-1">${visionRate}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #43e97b;">${data.scanning}</div>
                                <div class="stat-label">üîç Scanning</div>
                                <div class="text-xs text-gray-500 mt-1">${scanningRate}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #f5576c;">${data.total}</div>
                                <div class="stat-label">üë• Gesamt</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Bundesland ausw√§hlen und filtern
        function selectBundesland(bundesland) {
            const normalizedBundesland = normalizeBundeslandName(bundesland);
            // Setze den (versteckten) Filter
            const filterSelect = document.getElementById('bundeslandFilter');
            if (!filterSelect) {
                // Erstelle Filter falls nicht vorhanden
                const select = document.createElement('select');
                select.id = 'bundeslandFilter';
                select.style.display = 'none';
                select.innerHTML = '<option value="all">Alle Bundesl√§nder</option>';
                
                ALL_BUNDESLAENDER.forEach(bl => {
                    const option = document.createElement('option');
                    option.value = bl;
                    option.textContent = bl;
                    select.appendChild(option);
                });

                document.body.appendChild(select);
            }

            const filterElement = document.getElementById('bundeslandFilter');
            if (!Array.from(filterElement.options).some(opt => opt.value === normalizedBundesland)) {
                const option = document.createElement('option');
                option.value = normalizedBundesland;
                option.textContent = normalizedBundesland;
                filterElement.appendChild(option);
            }
            filterElement.value = normalizedBundesland;

            // NEU: Setze Spezialfilter f√ºr Filterbar-Anzeige
            activeSpecialFilter = {
                type: 'bundesland',
                value: normalizedBundesland
            };

            // Trigger Filter
            applyFilters();
            updateActiveFilterBar(); // NEU: Update die Filterbar
            
            // Wechsle zur Kundenliste
            document.querySelector('[data-tab="customers"]').click();
            
            // Zeige Toast Notification
            showToast(`üó∫Ô∏è Gefiltert nach: ${normalizedBundesland}`, 'info');
        }
        
        // Bundesland-Liste filtern (Suchfunktion)
        function filterBundeslandList() {
            const searchInput = document.getElementById('geoSearchInput');
            const filter = searchInput.value.toLowerCase();
            const items = document.querySelectorAll('.bundesland-item');
            
            items.forEach(item => {
                const bundesland = item.getAttribute('data-bundesland').toLowerCase();
                if (bundesland.includes(filter)) {
                    item.style.display = '';
                    item.style.animation = 'slideIn 0.3s ease';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Toast Notification (falls nicht vorhanden)
        function showToast(message, type = 'info') {
            // Erstelle Toast falls nicht vorhanden
            let toast = document.getElementById('customToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'customToast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    padding: 1rem 1.5rem;
                    border-radius: 12px;
                    background: white;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    display: none;
                    animation: slideInRight 0.3s ease;
                    min-width: 250px;
                `;
                document.body.appendChild(toast);
            }
            
            // Farben je nach Typ
            const colors = {
                info: '#667eea',
                success: '#43e97b',
                warning: '#f59e0b',
                error: '#ef4444'
            };
            
            toast.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5rem;">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
                    <span style="font-weight: 600; color: #1f2937;">${message}</span>
                </div>
            `;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.style.display = 'none', 300);
            }, 3000);
        }

        // *** ANGEPASST: Legenden bei Balkendiagrammen entfernt ***
        function initializeCharts() {
            Chart.register(ChartDataLabels); // Plugin registrieren
            
            // Lead Score Chart
            const ctxLead = document.getElementById('leadScoreChart')?.getContext('2d');
            if (ctxLead) {
                if (charts.leadScore) charts.leadScore.destroy(); 
                charts.leadScore = new Chart(ctxLead, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                                '#feca57', '#ff9ff3', '#00d2d3', '#5f27cd', '#ee5a6f'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right', 
                                labels: {
                                    padding: 10,
                                    font: { size: 11 },
                                    sort: (a, b) => {
                                        const aIndex = LEAD_SCORE_ORDER.indexOf(a.text) ?? 99;
                                        const bIndex = LEAD_SCORE_ORDER.indexOf(b.text) ?? 99;
                                        return aIndex - bIndex;
                                    }
                                }
                            },
                            datalabels: {
                                color: 'white',
                                font: { weight: 'bold', size: 14 },
                                formatter: (value, ctx) => {
                                    const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    const percentage = ((value / sum) * 100).toFixed(1) + '%';
                                    return percentage;
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const leadScore = charts.leadScore.data.labels[index];
                                applyChartFilter('leadScore', leadScore);
                            }
                        }
                    }
                });
            }

            // Sales Performance Chart
            const ctxSales = document.getElementById('salesPerformanceChart')?.getContext('2d');
            if (ctxSales) {
                if (charts.salesPerformance) charts.salesPerformance.destroy();
                charts.salesPerformance = new Chart(ctxSales, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Anzahl Kunden', // Label bleibt f√ºr Tooltip
                            data: [],
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // *** LEGENDE HIER AUSGEBLENDET ***
                            },
                            datalabels: { display: false } 
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const salesRep = charts.salesPerformance.data.labels[index];
                                applyChartFilter('salesRep', salesRep);
                            }
                        }
                    }
                });
            }

            // Akquise-Typ Chart
            const ctxAkquise = document.getElementById('akquiseTypChart')?.getContext('2d');
            if (ctxAkquise) {
                if (charts.akquiseTyp) charts.akquiseTyp.destroy();
                charts.akquiseTyp = new Chart(ctxAkquise, {
                    type: 'bar', 
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Anzahl', // Label bleibt f√ºr Tooltip
                            data: [],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(251, 146, 60, 0.8)'
                            ],
                            borderColor: [
                                'rgba(34, 197, 94, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(251, 146, 60, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // *** LEGENDE HIER AUSGEBLENDET ***
                            },
                            datalabels: { display: false }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const akquiseTyp = charts.akquiseTyp.data.labels[index];
                                applyChartFilter('akquiseTyp', akquiseTyp);
                            }
                        }
                    }
                });
            }

            // Reasons Not Bought Chart
            const ctxReasonNot = document.getElementById('reasonsNotBoughtChart')?.getContext('2d');
            if (ctxReasonNot) {
                if (charts.reasonsNotBought) charts.reasonsNotBought.destroy();
                charts.reasonsNotBought = new Chart(ctxReasonNot, {
                    type: 'treemap',
                    data: {
                        datasets: [{
                            tree: [],
                            key: 'value',
                            groups: ['label'],
                            spacing: 0.5,
                            borderWidth: 1.5,
                            borderColor: 'white',
                            backgroundColor: (ctx) => {
                                const colors = [
                                    '#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e',
                                    '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6'
                                ];
                                return colors[ctx.dataIndex % colors.length];
                            },
                            labels: {
                                display: true,
                                formatter: (ctx) => {
                                    if (ctx.type !== 'data') return '';
                                    return [ctx.raw._data.label, ctx.raw.v];
                                },
                                color: 'white',
                                font: { size: 12, weight: 'bold' }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => ctx[0].raw._data.label,
                                    label: (ctx) => `Anzahl: ${ctx.raw.v}`
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const reason = elements[0].element.$context.raw._data.label;
                                applyChartFilter('reasonNotBought', reason, 'Grund (nicht)');
                            }
                        }
                    }
                });
            }

            // Reasons Bought Chart
            const ctxReasonBought = document.getElementById('reasonsBoughtChart')?.getContext('2d');
            if (ctxReasonBought) {
                if (charts.reasonsBought) charts.reasonsBought.destroy();
                charts.reasonsBought = new Chart(ctxReasonBought, {
                    type: 'treemap',
                    data: {
                        datasets: [{
                            tree: [],
                            key: 'value',
                            groups: ['label'],
                            spacing: 0.5,
                            borderWidth: 1.5,
                            borderColor: 'white',
                            backgroundColor: (ctx) => {
                                const colors = [
                                    '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6',
                                    '#6366f1', '#8b5cf6', '#a855f7', '#c026d3', '#e11d48'
                                ];
                                return colors[ctx.dataIndex % colors.length];
                            },
                            labels: {
                                display: true,
                                formatter: (ctx) => {
                                    if (ctx.type !== 'data') return '';
                                    return [ctx.raw._data.label, ctx.raw.v];
                                },
                                color: 'white',
                                font: { size: 12, weight: 'bold' }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => ctx[0].raw._data.label,
                                    label: (ctx) => `Anzahl: ${ctx.raw.v}`
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const reason = elements[0].element.$context.raw._data.label;
                                applyChartFilter('reasonBought', reason, 'Grund (gekauft)');
                            }
                        }
                    }
                });
            }
            
            // Initialisiere Geo-Karte
            initializeGeoMapChart(); // Choroplethenkarte
        }
        
        // --- Helper Functions f√ºr Sortierung und Formatierung ---
        
        function getLeadScoreSortIndex(score) {
            const index = LEAD_SCORE_ORDER.indexOf(score);
            return index === -1 ? 99 : index; // Unbekannte ans Ende
        }

        // *** NEU: Helper f√ºr Fokus-Modus Sortierung (Hei√ü $\rightarrow$ Kalt) ***
        function getLeadScoreSortIndexReverse(score) {
            const index = LEAD_SCORE_ORDER.indexOf(score);
            // Wir drehen die Logik um: H√∂chster Score (Index 7, 6) soll *zuerst* kommen (niedrigste Zahl)
            // üëë Vollkunde (Index 7) $\rightarrow$ -7
            // üèÜ Kunde (Index 6) $\rightarrow$ -6
            // ‚ùÑÔ∏è Kalt (Index 0) $\rightarrow$ 0
            if (index === -1) return 99; // Unbekannt ans Ende
            return -index; // Negative Zahl, damit hohe Scores (gro√üer Index) zuerst kommen
        }
        
        function sortLeadScores(a, b) {
            return getLeadScoreSortIndex(a) - getLeadScoreSortIndex(b);
        }
        
        // *** NEU: Sortierung f√ºr Fokus-Modus (Hei√ü $\rightarrow$ Kalt) ***
        function sortLeadScoresReverse(a, b) {
            let aScore = a['Lead Score (berechnet)'];
            let bScore = b['Lead Score (berechnet)'];
            return getLeadScoreSortIndexReverse(aScore) - getLeadScoreSortIndexReverse(bScore);
        }
        
        // 8. Datumsformatierung
        function formatISODate(dateString) {
          if (!dateString || !dateString.includes('T')) return dateString;
          try {
            const date = new Date(dateString);
            // Pr√ºfen, ob das Datum g√ºltig ist (verhindert 'Invalid Date')
            if (isNaN(date.getTime())) return dateString; 
            return date.toLocaleDateString('de-DE'); // Formats to dd.MM.yyyy
          } catch (e) {
            return dateString; // Fallback
          }
        }
        
        function formatISODateForInput(dateString) {
          if (!dateString) return '';
          try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0]; // Format yyyy-MM-dd
          } catch (e) {
            return '';
          }
        }
        
        // -----------------------------------------------------

        // 1. Initialize event listeners (Aktualisiert)
        function initializeEventListeners() {
            // 1. Benutzername-Button (KORRIGIERT)
            document.getElementById('userNameBtn').addEventListener('click', () => setUserName(true));
            
            // Filter events with debouncing for search
            document.getElementById('globalSearch').addEventListener('input', function() {
                clearTimeout(searchDebounceTimer);
                
                searchDebounceTimer = setTimeout(() => {
                    applyFilters();
                }, DEBOUNCE_DELAY);
            });
            document.getElementById('salesRepFilter').addEventListener('change', applyFilters);
            document.getElementById('akquiseTypFilter').addEventListener('change', applyFilters);
            document.getElementById('leadScoreFilter').addEventListener('change', applyFilters);
            document.getElementById('leadStatusBerechnetFilter').addEventListener('change', applyFilters);
            document.getElementById('leadFilter').addEventListener('change', applyFilters);
            document.getElementById('upsellStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('bundeslandFilter').addEventListener('change', applyFilters);

            // 4. Event Listener f√ºr Text-Gr√ºnde-Filter
            // *** GE√ÑNDERT: Ruft jetzt applyFilters auf, damit die Liste neu gefiltert wird ***
            document.getElementById('reasonTextFilter').addEventListener('input', applyFilters);


            // Reset filters
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('globalSearch').value = '';
                document.getElementById('salesRepFilter').value = 'all';
                document.getElementById('akquiseTypFilter').value = 'all';
                document.getElementById('leadScoreFilter').value = 'all';
                document.getElementById('leadStatusBerechnetFilter').value = 'all';
                document.getElementById('leadFilter').value = 'all';
                document.getElementById('upsellStatusFilter').value = 'all';
                // *** NEU: Textfilter auch zur√ºcksetzen ***
                document.getElementById('reasonTextFilter').value = '';
                // *** NEU: Bundesland-Filter zur√ºcksetzen ***
                const bundeslandFilter = document.getElementById('bundeslandFilter');
                if (bundeslandFilter) {
                    bundeslandFilter.value = 'all';
                }
                // *** NEU: Spezialfilter zur√ºcksetzen ***
                activeSpecialFilter = null;
                
                // Clear KPI card filters
                document.querySelectorAll('.kpi-card').forEach(card => {
                    card.classList.remove('active-filter');
                });
                
                // NEU: Clear Header KPI filters
                document.querySelectorAll('.header-kpi').forEach(el => {
                    el.classList.remove('active-filter-header');
                });
                
                applyFilters();
            });
            document.getElementById('resetFilters').title = 'Alle Filter und Suchanfragen zur√ºcksetzen'; // NEU

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadDataFromGoogleSheets);
            document.getElementById('refreshBtn').title = 'Daten neu von Google Sheets laden'; // NEU

            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('exportBtn').title = 'Aktuell gefilterte Daten als CSV exportieren'; // NEU

            // KPI card clicks
            document.querySelectorAll('.kpi-card').forEach(card => {
                card.title = `Klicken, um Kundenliste zu filtern: ${card.querySelector('.kpi-label').textContent}`; // NEU
                card.addEventListener('click', function() {
                    const filterType = this.dataset.filterType;
                    const filterValue = this.dataset.filterValue;
                    
                    // Toggle active state
                    this.classList.toggle('active-filter');
                    
                    // Apply KPI filter
                    applyKPIFilter(filterType, filterValue, this.classList.contains('active-filter'));
                });
            });

            // Anrufer search
            const anruferSearch = document.getElementById('anruferSearch');
            if (anruferSearch) {
                anruferSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const select = document.getElementById('anruferCustomerList');
                    const options = Array.from(select.options);
                    
                    options.forEach(option => {
                        if (option.text.toLowerCase().includes(searchTerm)) { // Suche nach Text statt Value
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            }

            // Anrufer customer selection
            const anruferList = document.getElementById('anruferCustomerList');
            if (anruferList) {
                anruferList.addEventListener('change', (e) => {
                    const firma = e.target.value;
                    if (firma) {
                        showAnruferDetails(firma);
                    }
                });
            }

            // 4. Sortierung √ºber Dropdown
            document.getElementById('applySortBtn').addEventListener('click', function() {
                const column = document.getElementById('sortColumnSelect').value;
                const direction = document.getElementById('sortDirectionSelect').value;
                
                if (!column) {
                    showNotification('Bitte w√§hlen Sie eine Spalte zum Sortieren', 'warning', 2000);
                    return;
                }
                
                sortTable(column, direction);
            });
            
            // Automatisch sortieren bei √Ñnderung der Dropdown-Felder
            document.getElementById('sortColumnSelect').addEventListener('change', function() {
                const column = this.value;
                const direction = document.getElementById('sortDirectionSelect').value;
                if (column) {
                    sortTable(column, direction);
                }
            });
            
            document.getElementById('sortDirectionSelect').addEventListener('change', function() {
                const column = document.getElementById('sortColumnSelect').value;
                const direction = this.value;
                if (column) {
                    sortTable(column, direction);
                }
            });
            
            // 10. Calendar Navigation
            document.getElementById('calendar-prev').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            document.getElementById('calendar-next').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            
            // 2. Calendar "Heute" Button
            document.getElementById('calendar-today').addEventListener('click', () => {
                calendarDate = new Date(); // Auf heute zur√ºcksetzen
                renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            
            // NEU: Erweiterter Filter Button
            document.getElementById('advancedFilterBtn').addEventListener('click', openAdvancedFilterModal);
        }

        // Initialize tabs
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.title = `Zur Registerkarte '${button.textContent.trim()}' wechseln`; // NEU
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // NEU: Tab in localStorage speichern
                    localStorage.setItem('activeTab', targetTab);
                    
                    // Update active button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update visible content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
                    
                    // Update Geo-Charts when switching to geo tab
                    if (targetTab === 'geo') {
                        updateGeoChart();
                        setTimeout(() => {
                            if (leafletMap) {
                                leafletMap.invalidateSize();
                            }
                        }, 200);
                    }
                });
            });
        }

        // *** ANGEPASST: Filterlogik f√ºr 'Lead' ge√§ndert (includes statt ===) ***
        function applyFilters() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const salesRep = document.getElementById('salesRepFilter').value;
            const akquiseTyp = document.getElementById('akquiseTypFilter').value;
            const leadScore = document.getElementById('leadScoreFilter').value;
            const leadStatusBerechnet = document.getElementById('leadStatusBerechnetFilter').value;
            const lead = document.getElementById('leadFilter').value;
            const upsellStatus = document.getElementById('upsellStatusFilter').value;
            const bundesland = document.getElementById('bundeslandFilter')?.value || 'all';
            
            filteredData = masterData.filter(customer => {
                let match = true;

                // Search filter
                if (searchTerm) {
                    match = (customer['Firma']?.toLowerCase() || '').includes(searchTerm) ||
                            (customer['Mailadresse']?.toLowerCase() || '').includes(searchTerm);
                }

                // Sales Rep filter
                if (salesRep !== 'all' && match) {
                    match = customer['Sales Rep'] === salesRep;
                }
                
                // Akquise-Typ filter
                if (akquiseTyp !== 'all' && match) {
                    match = customer['Aquise-Typ'] === akquiseTyp;
                }

                // Lead Score filter
                if (leadScore !== 'all' && match) {
                    match = customer['Lead Score (berechnet)'] === leadScore;
                }
                
                // Lead Status (berechnet) filter
                if (leadStatusBerechnet !== 'all' && match) {
                    match = customer['Lead Status (berechnet)'] === leadStatusBerechnet;
                }

                // *** NEUE LOGIK F√úR LEAD (Multi-Select) ***
                if (lead !== 'all' && match) {
                    const customerLeads = (customer['Lead'] || '').split(',').map(s => s.trim());
                    match = customerLeads.includes(lead);
                }
                
                // Upsell Status filter
                if (upsellStatus !== 'all' && match) {
                    match = customer['Upsell Status'] === upsellStatus;
                }
                
                // Bundesland filter
                if (bundesland !== 'all' && match) {
                    const customerBundesland = getCustomerBundesland(customer);
                    match = customerBundesland === bundesland;
                }

                // *** NEU: Spezialfilter (aus Diagrammen) ***
                if (activeSpecialFilter && match) {
                    const value = activeSpecialFilter.value;
                    switch (activeSpecialFilter.type) {
                        case 'reasonNotBought':
                            match = (customer['Grund NICHT gekauft'] || '').split(',').map(r => r.trim()).includes(value);
                            break;
                        case 'reasonBought':
                            match = (customer['Grund gekauft'] || '').split(',').map(r => r.trim()).includes(value);
                            break;
                        case 'software':
                            match = (customer['Aktuell verwendete 3D Software'] || '').split(',').map(r => r.trim()).includes(value);
                            break;
                    }
                }

                return match;
            });

            // Sortierung anwenden, falls eine aktiv ist
            if (currentSortColumn && currentSortDirection) {
                applySortToFilteredData();
            }

            // 2. Dashboard aktualisieren (inkl. Cockpit)
            // Die Text-Gr√ºnde-Liste wird *innerhalb* von updateDashboard() gefiltert
            updateDashboard(); 
            updateCustomerTable();
            updateMatrixView();
            updateAnruferList();
            updateActiveFilterBar();
        }
        
        // Hilfsfunktion um Sortierung auf filteredData anzuwenden ohne updateCustomerTable aufzurufen
        function applySortToFilteredData() {
            if (!currentSortColumn) return;
            
            const columnKey = currentSortColumn;
            const direction = currentSortDirection;
            
            filteredData.sort((a, b) => {
                let aVal = a[columnKey] || '';
                let bVal = b[columnKey] || '';
                
                let comparison = 0;
                
                // Spezielle Sortierlogik
                if (columnKey === 'Lead Score (berechnet)') {
                    comparison = getLeadScoreSortIndex(aVal) - getLeadScoreSortIndex(bVal);
                
                } else if (columnKey === 'Letzter Anruf am:' || columnKey === 'Wann erneuter Kontakt?') {
                    // Datums-Sortierung (leere/ung√ºltige Daten immer nach unten)
                    const aTime = aVal ? new Date(aVal).getTime() : 0;
                    const bTime = bVal ? new Date(bVal).getTime() : 0;
                    
                    if (aTime === 0 && bTime === 0) {
                        comparison = 0;
                    } else if (aTime === 0) {
                        comparison = 1;
                    } else if (bTime === 0) {
                        comparison = -1;
                    } else {
                        comparison = aTime - bTime;
                    }
                    
                } else if (columnKey === 'Potenzieller NPS2 Kunde?' || columnKey === 'Vision' || columnKey === 'Scanning') {
                    const aSort = aVal === 'ja' ? 2 : (aVal === 'nein' ? 1 : 0);
                    const bSort = bVal === 'ja' ? 2 : (bVal === 'nein' ? 1 : 0);
                    comparison = aSort - bSort;
                    
                } else {
                    comparison = aVal.toString().localeCompare(bVal.toString(), 'de', { sensitivity: 'base' });
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
        }

        // NEUE FUNKTION f√ºr Header-KPIs
        function applyHeaderFilter(element, filterType, value = null) {
            const isActive = element.classList.contains('active-filter-header');
            
            // Alle Filter zur√ºcksetzen (setzt auch Header-Highlights zur√ºck)
            document.getElementById('resetFilters').click(); 
            
            if (isActive) {
                // Filter wurde deaktiviert, wir sind fertig
                return;
            }
            
            // Highlights von allen entfernen (wird durch resetFilters() miterledigt, aber zur Sicherheit)
            document.querySelectorAll('.header-kpi').forEach(el => el.classList.remove('active-filter-header'));
            // Aktiven Filter setzen
            element.classList.add('active-filter-header');

            // Spezifische Filterlogik anwenden
            switch (filterType) {
                case 'total':
                    // resetFilters hat bereits alles auf 'all' gesetzt
                    break;
                case 'vision':
                    filteredData = masterData.filter(d => d['Vision'] === value);
                    break;
                case 'scanning':
                    filteredData = masterData.filter(d => d['Scanning'] === value);
                    break;
                case 'interesse3D':
                    filteredData = masterData.filter(d => d['Interesse 3D?'] === value);
                    break;
                case 'nps2':
                    filteredData = masterData.filter(d => d['Potenzieller NPS2 Kunde?'] === value);
                    break;
                case 'hotLeads':
                    filteredData = masterData.filter(d => d['Lead Score (berechnet)']?.includes('üî•üî•üî•'));
                    break;
                case 'customers':
                    filteredData = masterData.filter(d => d['Lead Score (berechnet)']?.includes('üèÜ'));
                    break;
            }
            
            // Dashboard-Ansichten mit den manuell gefilterten Daten aktualisieren
            updateDashboard(); 
            updateCustomerTable();
            updateMatrixView();
            updateAnruferList();
            updateActiveFilterBar();
        }

        // Apply KPI filter
        function applyKPIFilter(filterType, filterValue, isActive) {
            // Setze Dropdown-Filter zur√ºck
            document.getElementById('globalSearch').value = '';
            document.getElementById('salesRepFilter').value = 'all';
            document.getElementById('akquiseTypFilter').value = 'all';
            document.getElementById('leadScoreFilter').value = 'all';
            document.getElementById('leadStatusBerechnetFilter').value = 'all';
            document.getElementById('leadFilter').value = 'all';
            document.getElementById('upsellStatusFilter').value = 'all';
            document.getElementById('reasonTextFilter').value = '';
            
            // Starte mit allen Daten
            filteredData = [...masterData];
            
            // Sammle alle aktiven KPI-Filter
            const activeFilters = [];
            document.querySelectorAll('.kpi-card.active-filter').forEach(card => {
                const type = card.dataset.filterType;
                const value = card.dataset.filterValue;
                const label = card.querySelector('.kpi-label').textContent;
                activeFilters.push({ type, value, label });
            });
            
            // Wenn Filter aktiv sind, setze Spezialfilter
            if (activeFilters.length > 0) {
                const filterLabels = activeFilters.map(f => f.label).join(', ');
                activeSpecialFilter = {
                    type: 'kpi-cards',
                    value: filterLabels
                };
            } else {
                activeSpecialFilter = null;
            }
            
            // Alle aktiven KPI-Filter anwenden
            activeFilters.forEach(({ type, value }) => {
                filteredData = filteredData.filter(customer => {
                    switch(type) {
                        case 'vision':
                            return customer['Vision'] === value;
                        case 'scanning':
                            return customer['Scanning'] === value;
                        case 'interesse3D':
                            return customer['Interesse 3D?'] === value;
                        case 'potenziell':
                            return customer['Potenzieller NPS2 Kunde?'] === value;
                        default:
                            return true;
                    }
                });
            });
            
            updateDashboard();
            updateCustomerTable();
            updateMatrixView();
            updateAnruferList();
            updateActiveFilterBar();
            
            // Wechsle zur Kundenliste
            document.querySelector('[data-tab="customers"]').click();
        }

        // Apply chart filter (ANGEPASST: Alle Klicks filtern jetzt)
        function applyChartFilter(type, value, label) {
            // Alle Filter zur√ºcksetzen, um Konflikte zu vermeiden
            document.getElementById('resetFilters').click();
            
            // Label f√ºr die Filterleiste setzen
            const filterLabel = label || type;
            
            switch(type) {
                case 'leadScore':
                    document.getElementById('leadScoreFilter').value = value;
                    break;
                case 'salesRep':
                    document.getElementById('salesRepFilter').value = value;
                    break;
                case 'akquiseTyp':
                    document.getElementById('akquiseTypFilter').value = value;
                    break;
                
                // Spezialfilter, die nicht in den Dropdowns sind
                case 'software':
                    activeSpecialFilter = { type: 'software', label: 'Software', value: value };
                    break;
                case 'reasonNotBought':
                    activeSpecialFilter = { type: 'reasonNotBought', label: filterLabel, value: value };
                    break;
                case 'reasonBought':
                    activeSpecialFilter = { type: 'reasonBought', label: filterLabel, value: value };
                    break;
            }
            
            // Standard-Filter anwenden
            applyFilters();
            
            // Zur Kundenliste wechseln
            document.querySelector('[data-tab="customers"]').click();
        }

        // Filter f√ºr Lead-Quellen Analyse
        function applyLeadSourceFilter(leadSource) {
            document.getElementById('resetFilters').click();
            document.getElementById('leadFilter').value = leadSource;
            applyFilters();
            document.querySelector('[data-tab="customers"]').click();
        }

        // 5. Update dashboard (Aktualisiert)
        function updateDashboard() {
            // Update quick stats
            document.getElementById('totalCustomers').textContent = filteredData.length;
            document.getElementById('visionCount').textContent = 
                filteredData.filter(d => d['Vision'] === 'ja').length;
            document.getElementById('scanningCount').textContent = 
                filteredData.filter(d => d['Scanning'] === 'ja').length;
            document.getElementById('interesse3DCount').textContent = 
                filteredData.filter(d => d['Interesse 3D?'] === 'ja').length;
            document.getElementById('nps2InteresseCount').textContent = 
                filteredData.filter(d => d['Potenzieller NPS2 Kunde?'] === 'ja').length;
            document.getElementById('hotLeadsCount').textContent = 
                filteredData.filter(d => d['Lead Score (berechnet)']?.includes('üî•üî•üî•')).length;
            document.getElementById('customerCount').textContent = 
                filteredData.filter(d => d['Lead Score (berechnet)']?.includes('üèÜ')).length;

            // Update charts
            updateCharts();
            
            // Update Geo-Chart
            updateGeoChart();
            
            // 2. Neue Lead-Analyse aktualisieren
            updateLeadAnalysis();
            
            // 5. Top Software Liste aktualisieren
            updateTopSoftwareList();
            
            // 5. Neue Text-Gr√ºnde-Liste aktualisieren (wird jetzt auch gefiltert)
            updateReasonsNotBoughtTextList();
            
            // 2. SalesCockpit immer aktualisieren
            updateSalesCockpit();
            
            // Update dynamic summary
            updateDynamicSummary();
        }
        
        // Dynamic Summary Function
        function updateDynamicSummary() {
            const container = document.getElementById('dynamicSummaryText');
            if (!container) return;

            const totalFiltered = filteredData.length;
            const totalMaster = masterData.length;
            const isFiltered = totalFiltered < totalMaster;

            if (totalFiltered === 0) {
                container.innerHTML = "<p>In der aktuellen Filterauswahl wurden keine Kunden gefunden.</p>";
                return;
            }

            const upsellCount = filteredData.filter(c => c['Upsell Status'] === 'üí° Upsell-Potenzial').length;
            const hotLeads = filteredData.filter(c => 
                c['Lead Score (berechnet)']?.includes('üî•üî•üî•') ||
                c['Lead Score (berechnet)']?.includes('10/10')
            ).length;
            const angebote = filteredData.filter(c => c['Lead Status (berechnet)'] === 'üìà Angebot').length;

            // √ÑNDERUNG: Farben bleiben, aber keine Klickbarkeit mehr
            let text = `Sie betrachten <strong style="color: #6366f1;">${totalFiltered} ${totalFiltered === 1 ? 'Kunde' : 'Kunden'}</strong>${isFiltered ? ' (gefiltert)' : ''}. `;
            if (hotLeads > 0) {
                text += `Davon sind <strong style="color: #ef4444;">${hotLeads} hei√üe Leads</strong> `;
            }
            if (angebote > 0) {
                text += `und <strong style="color: #10b981;">${angebote} ${angebote === 1 ? 'offenes Angebot' : 'offene Angebote'}</strong>. `;
            }
            if (upsellCount > 0) {
                text += `Bei <strong style="color: #f59e0b;">${upsellCount} Kunden</strong> besteht <strong style="color: #f59e0b;">Upsell-Potenzial</strong>.`;
            }

            container.innerHTML = `<p>${text.trim()}</p>`;
            
            // ENTFERNT: Keine Event-Listener mehr, da nicht klickbar
        }
        
        // ENTFERNT: Diese Funktion wird nicht mehr ben√∂tigt, da "Aktuelle Auswahl" nicht mehr klickbar ist
        /*
        function applySummaryFilter(filterType) {
            // Alle Filter zur√ºcksetzen
            document.getElementById('resetFilters').click();
            
            switch(filterType) {
                case 'all':
                    // Zeige alle (keine weiteren Filter)
                    break;
                case 'hotLeads':
                    // Filter f√ºr hei√üe Leads
                    document.getElementById('leadScoreFilter').value = 'üî•üî•üî• 10/10 - Hei√üer Lead';
                    break;
                case 'angebote':
                    // Filter f√ºr Angebote
                    document.getElementById('leadStatusFilter').value = 'üìà Angebot';
                    break;
                case 'upsell':
                    // Filter f√ºr Upsell-Potenzial
                    document.getElementById('upsellFilter').value = 'üí° Upsell-Potenzial';
                    break;
            }
            
            applyFilters();
            // Zur Kundenliste wechseln
            document.querySelector('[data-tab="customers"]').click();
        }
        */
        
        // *** ANGEPASST: Z√§hlt jetzt kommaseparierte Leads ***
        function updateLeadAnalysis() {
            const container = document.getElementById('lead-kpi-container');
            if (!container) return;

            const leadCounts = {};
            // Nutzt masterData f√ºr die Gesamt√ºbersicht
            masterData.forEach(d => {
                const leadStr = d['Lead'] || 'Unbekannt';
                const leads = leadStr.split(',').map(s => s.trim()).filter(Boolean);

                if (leads.length === 0) {
                    leads.push('Unbekannt');
                }

                leads.forEach(lead => {
                    if (!leadCounts[lead]) {
                        leadCounts[lead] = { total: 0, withModules: 0 };
                    }
                    leadCounts[lead].total++;
                    // Z√§hle Leads die Vision oder Scanning haben
                    if (d['Vision'] === 'ja' || d['Scanning'] === 'ja') {
                        leadCounts[lead].withModules++;
                    }
                });
            });

            // "Unbekannt" und leere herausfiltern
            delete leadCounts['Unbekannt'];
            delete leadCounts[''];

            const sortedLeads = Object.entries(leadCounts)
                .sort(([, a], [, b]) => b.total - a.total)
                .slice(0, 6); // Top 6

            if (sortedLeads.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Keine Lead-Quellen-Daten gefunden.</p>';
                return;
            }

            container.innerHTML = sortedLeads.map(([name, data]) => {
                const percentage = data.total > 0 ? (data.withModules / data.total) * 100 : 0;
                return `
                    <div class="lead-kpi-card cursor-pointer hover:shadow-lg transition-all" 
                         onclick="applyLeadSourceFilter('${name.replace(/'/g, "\\'")}')"
                         title="Klicken, um nach dieser Lead-Quelle zu filtern">
                        <div>
                            <h4 class="lead-kpi-title">${name}</h4>
                            <div class="lead-kpi-stat" title="Gesamtanzahl der Leads aus dieser Quelle">${data.total}</div>
                        </div>
                        <div class="lead-kpi-footer">
                            <span title="${data.withModules} von ${data.total} Leads haben Vision oder Scanning"><i class="fas fa-cube mr-1"></i> ${data.withModules} mit Modulen</span>
                            <span class="lead-kpi-rate" title="Prozentsatz der Leads mit Vision oder Scanning">${percentage.toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update charts (wird von updateDashboard aufgerufen)
        function updateCharts() {
            // Update Lead Score Chart
            if (charts.leadScore) {
                const leadScoreCounts = {};
                filteredData.forEach(d => {
                    const score = d['Lead Score (berechnet)'] || 'Keine Angabe';
                    leadScoreCounts[score] = (leadScoreCounts[score] || 0) + 1;
                });
                
                const sortedLabels = Object.keys(leadScoreCounts).sort(sortLeadScores);
                const sortedData = sortedLabels.map(label => leadScoreCounts[label]);

                charts.leadScore.data.labels = sortedLabels;
                charts.leadScore.data.datasets[0].data = sortedData;
                charts.leadScore.update();
            }

            // Update Sales Performance Chart
            if (charts.salesPerformance) {
                const salesRepCounts = {};
                filteredData.forEach(d => {
                    const rep = d['Sales Rep'] || 'Unbekannt';
                    salesRepCounts[rep] = (salesRepCounts[rep] || 0) + 1;
                });

                charts.salesPerformance.data.labels = Object.keys(salesRepCounts);
                charts.salesPerformance.data.datasets[0].data = Object.values(salesRepCounts);
                charts.salesPerformance.update();
            }

            // Update Akquise-Typ Chart
            if (charts.akquiseTyp) {
                const akquiseTypCounts = {};
                filteredData.forEach(d => {
                    const typ = d['Aquise-Typ'] || 'Keine Angabe';
                    akquiseTypCounts[typ] = (akquiseTypCounts[typ] || 0) + 1;
                });

                charts.akquiseTyp.data.labels = Object.keys(akquiseTypCounts);
                charts.akquiseTyp.data.datasets[0].data = Object.values(akquiseTypCounts);
                charts.akquiseTyp.update();
            }

            // Update Reasons Charts
            if (charts.reasonsNotBought) {
                const reasonsNotCounts = {};
                filteredData.forEach(d => {
                    const reasonsStr = d['Grund NICHT gekauft'];
                    if (reasonsStr) {
                        const reasons = reasonsStr.split(',').map(r => r.trim()).filter(Boolean);
                        reasons.forEach(reason => {
                            reasonsNotCounts[reason] = (reasonsNotCounts[reason] || 0) + 1;
                        });
                    }
                });

                const treemapData = Object.entries(reasonsNotCounts).map(([label, value]) => ({
                    label: label,
                    value: value
                }));
                charts.reasonsNotBought.data.datasets[0].tree = treemapData;
                charts.reasonsNotBought.update();
            }

            if (charts.reasonsBought) {
                const reasonsCounts = {};
                filteredData.forEach(d => {
                    const reasonsStr = d['Grund gekauft'];
                    if (reasonsStr) {
                        const reasons = reasonsStr.split(',').map(r => r.trim()).filter(Boolean);
                        reasons.forEach(reason => {
                            reasonsCounts[reason] = (reasonsCounts[reason] || 0) + 1;
                        });
                    }
                });

                const treemapData = Object.entries(reasonsCounts).map(([label, value]) => ({
                    label: label,
                    value: value
                }));
                charts.reasonsBought.data.datasets[0].tree = treemapData;
                charts.reasonsBought.update();
            }
        }
        
        // 5. Neue Funktion f√ºr Top Software Liste (ANGEPASST: Klickbar zum Filtern)
        function updateTopSoftwareList() {
            const softwareCounts = {};
            filteredData.forEach(d => {
                const softwareStr = d['Aktuell verwendete 3D Software'];
                if (softwareStr) {
                    const softwareList = softwareStr.split(',')
                                                  .map(s => s.trim())
                                                  .filter(s => s && s.toLowerCase() !== 'keine' && s.toLowerCase() !== '-');
                    softwareList.forEach(software => {
                        softwareCounts[software] = (softwareCounts[software] || 0) + 1;
                    });
                }
            });

            const sortedSoftware = Object.entries(softwareCounts)
                .sort(([, countA], [, countB]) => countB - countA)
                .slice(0, 10);
            
            const listContainer = document.getElementById('topSoftwareList');
            if (listContainer) {
                if (sortedSoftware.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500">Keine Software-Daten in der aktuellen Auswahl vorhanden.</p>';
                    return;
                }
                
                // *** NEU: onclick-Handler hinzugef√ºgt ***
                listContainer.innerHTML = sortedSoftware.map(([name, count]) => `
                    <div class="flex justify-between items-center py-1 border-b border-gray-100 
                                cursor-pointer hover:bg-purple-50"
                         onclick="applyChartFilter('software', '${name.replace(/'/g, "\\'")}', 'Software')"
                         title="Klicken, um nach '${name}' zu filtern">
                        <span class="font-medium text-gray-700">${name}</span>
                        <span class="font-bold text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full text-sm">${count}</span>
                    </div>
                `).join('');
            }
        }
        
        // 4. Funktion f√ºr Text-Gr√ºnde (ANGEPASST: Nutzt jetzt filteredData)
        function updateReasonsNotBoughtTextList() {
            const listContainer = document.getElementById('reasonsNotBoughtTextList');
            if (!listContainer) return;
            
            // Textfilter-Input holen
            const filterText = document.getElementById('reasonTextFilter').value.toLowerCase();
            
            // *** NEUE LOGIK: Startet mit 'filteredData' (globale Filter) statt 'masterData' ***
            let customersWithReasons = filteredData 
                .filter(c => c['Gr√ºnde NICHT gekauft (txt)'] && c['Gr√ºnde NICHT gekauft (txt)'].trim() !== '');
            
            // Wendet den *lokalen* Textfilter auf die *bereits global gefilterten* Daten an
            if (filterText) {
                customersWithReasons = customersWithReasons.filter(c => 
                    (c['Gr√ºnde NICHT gekauft (txt)'] || '').toLowerCase().includes(filterText) || 
                    (c['Firma'] || '').toLowerCase().includes(filterText)
                );
            }
            
            // Speichere f√ºr Navigation
            currentReasonsData = customersWithReasons;
                
            if (customersWithReasons.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Keine passenden Text-Begr√ºndungen in der aktuellen Auswahl gefunden.</p>';
                return;
            }
            
            listContainer.innerHTML = customersWithReasons.map((customer, index) => `
                <div class="border-b border-gray-200 pb-3">
                    <p class="font-semibold text-gray-800 cursor-pointer hover:text-purple-600 transition-colors" 
                       title="Details f√ºr ${customer['Firma']} anzeigen" 
                       onclick="openCustomerFromReasonsList('${encodeURIComponent(customer['Firma'] || '')}')">
                       ${customer['Firma']}
                    </p>
                    <blockquote class="border-l-4 border-yellow-500 bg-yellow-50 p-3 my-2 text-gray-700" style="white-space: pre-wrap;">${customer['Gr√ºnde NICHT gekauft (txt)']}</blockquote>
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>Software: <span class="font-medium text-gray-700">${customer['Aktuell verwendete 3D Software'] || '-'}</span></span>
                        <span>Sales Rep: <span class="font-medium text-gray-700">${customer['Sales Rep'] || 'N/A'}</span></span>
                    </div>
                </div>
            `).join('');
        }
        
        // NEU: Spezielle Funktion f√ºr Reasons-Liste
        function openCustomerFromReasonsList(encodedFirma) {
            setNavigationContext('reasons-text', currentReasonsData);
            showCustomerDetailsByFirma(encodedFirma);
        }

        // *** ANGEPASST: Neue Spalte "Upsell Status" hinzugef√ºgt ***
        function updateCustomerTable() {
            const tbody = document.getElementById('customerTableBody');
            if (!tbody) return;

            tbody.innerHTML = filteredData.map(customer => {
                const leadScoreClass = getLeadScoreClass(customer['Lead Score (berechnet)']);
                
                return `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 cursor-pointer hover:text-purple-600" 
                            title="Klicken f√ºr Details"
                            onclick="openCustomerFromList('${encodeURIComponent(customer['Firma'] || '')}')">
                            <div class="font-semibold">${customer['Firma'] || ''}</div>
                            <div class="text-sm text-gray-500">${customer['Mailadresse'] || ''}</div>
                        </td>
                        <td class="py-3 px-4">${customer['Sales Rep'] || ''}</td>
                        <td class="py-3 px-4 text-center">
                            ${customer['Vision'] === 'ja' ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-times text-gray-400"></i>'}
                        </td>
                        <td class="py-3 px-4 text-center">
                            ${customer['Scanning'] === 'ja' ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-times text-gray-400"></i>'}
                        </td>
                        <td class="py-3 px-4">
                            <span class="lead-score-badge ${leadScoreClass}">
                                ${customer['Lead Score (berechnet)'] || 'N/A'}
                            </span>
                        </td>
                        <td class="py-3 px-4">${customer['Upsell Status'] || '-'}</td>
                        <td class="py-3 px-4">${formatISODate(customer['Letzter Anruf am:']) || '-'}</td>
                        <td class="py-3 px-4">${formatISODate(customer['Wann erneuter Kontakt?']) || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            updateResultsCounter();
        }

        // Get lead score class
        function getLeadScoreClass(score) {
            if (!score) return 'lead-score-cold';
            if (score.includes('üèÜ') || score.includes('üëë')) return 'lead-score-customer';
            if (score.includes('10/10') || score.includes('üî•üî•üî•üî•üî•') || score.includes('üî•üî•üî•üî•')) return 'lead-score-hot';
            if (score.includes('7/10') || score.includes('üî•üî•üî•')) return 'lead-score-warm';
            return 'lead-score-cold';
        }

        // 4. Update matrix view (Lead Status (berechnet) / Lead Score (berechnet))
        function updateMatrixView() {
            const matrixTable = document.getElementById('matrixTable');
            if (!matrixTable) return;

            // Get unique values
            const leadStatuses = [...new Set(masterData.map(d => d['Lead Status (berechnet)']))].filter(Boolean).sort();
            const leadScores = [...new Set(masterData.map(d => d['Lead Score (berechnet)']))].filter(Boolean)
                .sort(sortLeadScores);

            // Build matrix data
            const matrix = {};
            leadStatuses.forEach(status => {
                matrix[status] = {};
                leadScores.forEach(score => {
                    matrix[status][score] = filteredData.filter(d => 
                        d['Lead Status (berechnet)'] === status && d['Lead Score (berechnet)'] === score
                    ).length;
                });
            });

            // Build HTML
            let html = '<thead><tr><th class="row-header">Lead Status (ber.) / Lead Score (ber.)</th>';
            leadScores.forEach(score => {
                html += `<th class="text-center">${score}</th>`;
            });
            html += '<th class="total">Gesamt</th></tr></thead><tbody>';

            leadStatuses.forEach(status => {
                html += `<tr><td class="row-header">${status}</td>`;
                let rowTotal = 0;
                leadScores.forEach(score => {
                    const count = matrix[status][score] || 0;
                    rowTotal += count;
                    html += `<td class="text-center interactive ${count > 0 ? 'font-semibold' : 'text-gray-400'}" 
                             title="Klicken, um ${count} Kunden mit Status '${status}' und Score '${score}' anzuzeigen"
                             onclick="filterByMatrix('${status}', '${score}')">${count}</td>`;
                });
                // NEU: Gesamt-Spalte klickbar machen
                html += `<td class="total interactive cursor-pointer hover:bg-purple-100 transition-colors" 
                         title="Klicken, um ${rowTotal} Kunden mit Status '${status}' anzuzeigen"
                         onclick="filterByMatrixStatus('${status}')">${rowTotal}</td></tr>`;
            });

            // Add totals row
            html += '<tr class="total"><td class="row-header">Gesamt</td>';
            let grandTotal = 0;
            leadScores.forEach(score => {
                const colTotal = leadStatuses.reduce((sum, status) => sum + (matrix[status][score] || 0), 0);
                grandTotal += colTotal;
                // NEU: Gesamt-Zeile klickbar machen
                html += `<td class="text-center interactive cursor-pointer hover:bg-purple-100 transition-colors" 
                         title="Klicken, um ${colTotal} Kunden mit Score '${score}' anzuzeigen"
                         onclick="filterByMatrixScore('${score}')">${colTotal}</td>`;
            });
            // NEU: Gesamt-Gesamt klickbar machen (zeigt alle)
            html += `<td class="interactive cursor-pointer hover:bg-purple-100 transition-colors" 
                     title="Klicken, um alle ${grandTotal} Kunden anzuzeigen"
                     onclick="filterByMatrixAll()">${grandTotal}</td></tr></tbody>`;

            matrixTable.innerHTML = html;
        }

        // 4. Filter by matrix cell (Aktualisiert)
        function filterByMatrix(leadStatus, leadScore) {
            document.getElementById('resetFilters').click(); // Stellt sicher, dass Spezialfilter gel√∂scht werden
            document.getElementById('leadStatusBerechnetFilter').value = leadStatus;
            document.getElementById('leadScoreFilter').value = leadScore;
            applyFilters();
            
            // Switch to customer list tab
            document.querySelector('[data-tab="customers"]').click();
        }
        
        // NEU: Filter nach Lead Status (Zeile)
        function filterByMatrixStatus(leadStatus) {
            document.getElementById('resetFilters').click();
            document.getElementById('leadStatusBerechnetFilter').value = leadStatus;
            applyFilters();
            document.querySelector('[data-tab="customers"]').click();
        }
        
        // NEU: Filter nach Lead Score (Spalte)
        function filterByMatrixScore(leadScore) {
            document.getElementById('resetFilters').click();
            document.getElementById('leadScoreFilter').value = leadScore;
            applyFilters();
            document.querySelector('[data-tab="customers"]').click();
        }
        
        // NEU: Zeige alle Kunden
        function filterByMatrixAll() {
            document.getElementById('resetFilters').click();
            document.querySelector('[data-tab="customers"]').click();
        }

        // Update Anrufer list
        function updateAnruferList() {
            const select = document.getElementById('anruferCustomerList');
            if (!select) return;

            select.innerHTML = filteredData // Gefilterte Daten verwenden
                .sort((a, b) => (a['Firma'] || '').localeCompare(b['Firma'] || ''))
                .map(customer => {
                    const tel = customer['Telefon'] ? ` - ${customer['Telefon']}` : '';
                    return `<option value="${customer['Firma']}" title="Details f√ºr ${customer['Firma']} anzeigen">${customer['Firma']}${tel}</option>`;
                })
                .join('');
        }

        // 4. Show Anrufer details (Layout √ºberarbeitet UND Einzug korrigiert)
        function showAnruferDetails(firma) {
            const customer = masterData.find(c => c['Firma'] === firma);
            if (!customer) return;

            const detailsContainer = document.getElementById('anruferDetails');
            
            let html = `
                <div class="anrufer-details-info"> 
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${customer['Firma']}</h3>
                        <p class="text-gray-600">${customer['Mailadresse'] || 'Keine E-Mail'}</p>
                        ${customer['Telefon'] ? `<p class="text-lg font-semibold text-purple-600 mt-2">
                            <a href="tel:${customer['Telefon'].replace(/[\s\/-]/g, '')}" class="hover:underline">
                                <i class="fas fa-phone mr-2"></i>${customer['Telefon']}
                            </a>
                        </p>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">Sales Rep</p>
                            <p class="font-semibold">${customer['Sales Rep'] || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Lead Score</p>
                            <p class="font-semibold">${customer['Lead Score (berechnet)'] || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Vision</p>
                            <p class="font-semibold">${customer['Vision'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Scanning</p>
                            <p class="font-semibold">${customer['Scanning'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">Gekaufte Module</p>
                            <p class="font-semibold">${customer['Gekaufte Module'] || '-'}</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold mb-2">Telefonat-Notizen</h4>
                        <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto" style="white-space: pre-wrap;">${customer['Telefonat'] || '<span class="text-gray-500">Keine Notizen vorhanden</span>'}</div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold mb-2">Weitere Informationen</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Anrufer:</strong> ${customer['Anrufer'] || '-'}</p>
                            <p><strong>Letzter Anruf:</strong> ${formatISODate(customer['Letzter Anruf am:']) || '-'}</p>
                            <p><strong>N√§chster Kontakt:</strong> ${formatISODate(customer['Wann erneuter Kontakt?']) || '-'}</p>
                            <p><strong>3D Interesse:</strong> ${customer['Interesse 3D?'] || '-'}</p>
                            <p><strong>Akquise-Typ:</strong> ${customer['Aquise-Typ'] || '-'}</p>
                        </div>
                    </div>
                </div> 
                <div class="anrufer-details-form"> 
                    <h4 class="font-semibold mb-3">Neue Notiz hinzuf√ºgen</h4>
                    <textarea id="newNote" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" 
                              placeholder="Notizen zum Gespr√§ch..."></textarea>
                    <div class="mt-3 flex items-center justify-between">
                        <div>
                            <label class="block text-sm font-semibold mb-1">N√§chster Kontakt am:</label>
                            <input type="date" id="nextContact" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <button onclick="saveAnruferNote('${firma}')" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                                title="Notiz und/oder Datum in Google Sheets speichern">
                            <i class="fas fa-save mr-2"></i>Notiz speichern
                        </button>
                    </div>
                </div> 
                `;

            detailsContainer.innerHTML = html;
        }

        // Save Anrufer note
        async function saveAnruferNote(firma) {
            const note = document.getElementById('newNote').value;
            const nextContact = document.getElementById('nextContact').value;
            
            if (!note && !nextContact) {
                alert('Bitte geben Sie eine Notiz oder ein Datum ein.');
                return;
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveCallNote',
                        firma: firma,
                        notiz: note,
                        naechsterKontakt: nextContact ? nextContact : '', // yyyy-MM-dd
                        secret: API_SECRET,
                        userName: userName
                    })
                });

                const result = await response.json();
                
                if (result.status === 'Erfolg') {
                    alert('Notiz erfolgreich gespeichert!');
                    document.getElementById('newNote').value = '';
                    document.getElementById('nextContact').value = '';
                    
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.classList.add('bg-yellow-200', 'text-yellow-800', 'border-yellow-500');
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Daten veraltet. Aktualisieren!';
                    
                } else {
                    throw new Error(result.message || 'Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Notiz. Bitte versuchen Sie es erneut.');
            }
        }

        // --- 3. Neue Modal-Funktionen ---
        
        // 3a. Show customer details modal (Aktualisiert auf ByFirma)
        function showCustomerDetailsByFirma(encodedFirma) {
            const firma = decodeURIComponent(encodedFirma);
            const customer = masterData.find(c => c['Firma'] === firma);
            if (!customer) {
                console.error('Kunde nicht gefunden:', firma);
                alert('Fehler: Kunde konnte nicht gefunden werden.');
                return;
            }
            
            currentModalCustomer = { ...customer }; // Wichtig: Kopie erstellen
            
            // NEU: Index in der richtigen Datenquelle finden
            const dataSource = navigationContext.data.length > 0 ? navigationContext.data : filteredData;
            currentModalIndex = dataSource.findIndex(c => c['Firma'] === firma);
            
            // Falls nicht in der Kontextliste gefunden, verwende filteredData als Fallback
            if (currentModalIndex === -1) {
                currentModalIndex = filteredData.findIndex(c => c['Firma'] === firma);
                navigationContext.data = filteredData;
                navigationContext.type = 'customers';
            }
            
            const modal = document.getElementById('customerModal');
            document.getElementById('modalTitle').textContent = currentModalCustomer['Firma'];
            
            // *** NEU: Stellt sicher, dass die Buttons zur√ºckgesetzt sind ***
            toggleModalEdit(false); 
            renderModalContent(currentModalCustomer, false); // Ansichts-Modus
            
            // NEU: Navigationsbuttons aktualisieren
            updateModalNavButtons();
            
            modal.classList.add('active');
        }
        
        // Modal-Ansicht (Lesen vs. Bearbeiten) umschalten
        function toggleModalEdit(isEditing) {
            document.getElementById('modalEditBtn').classList.toggle('hidden', isEditing);
            document.getElementById('modalCancelBtn').classList.toggle('hidden', !isEditing);
            document.getElementById('modalSaveBtn').classList.toggle('hidden', !isEditing);
            
            renderModalContent(currentModalCustomer, isEditing);
        }

        // *** NEU: Hilfsfunktion zum Ausklappen der Module ***
        function toggleModules(event) {
            event.preventDefault();
            const moreSpan = document.getElementById('modal-modules-more');
            const toggleBtn = document.getElementById('modal-modules-toggle');
            if (moreSpan.classList.contains('hidden')) {
                moreSpan.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Weniger anzeigen';
            } else {
                moreSpan.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Mehr anzeigen';
            }
        }
        
        function toggleReasonText(event) {
            event.preventDefault();
            const reasonText = document.getElementById('modal-reason-text');
            const toggleBtn = document.getElementById('modal-reason-toggle');
            if (reasonText.classList.contains('hidden')) {
                reasonText.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Grund NICHT gekauft (Details verbergen)';
            } else {
                reasonText.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Grund NICHT gekauft (Details anzeigen)';
            }
        }

        // *** ANGEPASST: "next step" + Layout + Ausklappbare Module + Multi-Lead ***
        function renderModalContent(customer, isEditing = false) {
            const modalContent = document.getElementById('modalContent');
            if (!customer) {
                modalContent.innerHTML = '<p>Kunde nicht gefunden.</p>';
                return;
            }
            
            let html = '';

            if (isEditing) {
                // --- BEARBEITEN-MODUS (Dynamisch generiert) ---
                html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">';
                
                // Spalten-Konfiguration
                const readOnlyCols = [
                    'Firma', 'Mailadresse', 'Lead Score (berechnet)', 'Lead Status (berechnet)',
                    'Gekaufte Module', 'Letzte √Ñnderung', 'Demo nach PowerHour', 'Kauf nach PowerHour',
                    'PLZ', 'Bundesland'
                ];
                const dateCols = ['Letzter Anruf am:', 'Wann erneuter Kontakt?'];
                const selectCols = [
                    'Vision', 'Scanning', 'Interesse 3D?', 'Potenzieller NPS2 Kunde?',
                    'Sales Rep', 'Aquise-Typ', 'Upsell Status', 'Anrufer'
                ];
                // *** "Lead" HINZUGEF√úGT ***
                const multiSelectCols = [
                    'Aktuell verwendete 3D Software', 'Grund NICHT gekauft', 'Grund gekauft', 'Lead'
                ];
                // *** "next step" KORRIGIERT ***
                const textAreaCols = ['Telefonat', 'Gr√ºnde NICHT gekauft (txt)', 'next step'];
                
                // Geht alle Spalten aus dem Google Sheet durch
                originalHeaders.forEach(header => {
                    // "Gekaufte Module" im Bearbeiten-Modus √ºberspringen, da es ein readonly-Feld ist
                    if (header === 'Gekaufte Module') {
                         html += `
                            <div class="md:col-span-3">
                                <label class="modal-label" for="${slugify(header)}">${header}</label>
                                <input type="text" id="${slugify(header)}" class="modal-input bg-gray-100" value="${customer[header] || ''}" readonly title="Dieses Feld kann nicht bearbeitet werden.">
                            </div>
                        `;
                        return; // N√§chste Iteration
                    }

                    const id = slugify(header);
                    const value = customer[header] || '';
                    let inputHtml = '';
                    
                    if (readOnlyCols.includes(header)) {
                        inputHtml = `<input type="text" id="${id}" class="modal-input bg-gray-100" value="${value}" readonly title="Dieses Feld kann nicht bearbeitet werden.">`;
                    
                    } else if (dateCols.includes(header)) {
                        inputHtml = `<input type="date" id="${id}" class="modal-input" value="${formatISODateForInput(value)}">`;
                   
                    // --- LOGIK F√úR MULTI-SELECT FELDER ---
                    } else if (multiSelectCols.includes(header)) {
                        let allValues = new Set();
                        masterData.forEach(d => {
                            if (d[header]) {
                                d[header].split(',').forEach(v => {
                                    const trimmed = v.trim();
                                    if (trimmed) allValues.add(trimmed);
                                });
                            }
                        });
                        
                        let options = [...allValues].sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
                        const currentValues = value ? value.split(',').map(v => v.trim()) : [];
                        
                        inputHtml = `<select id="${id}" class="modal-input" multiple size="6" title="Mehrfachauswahl m√∂glich (Strg+Klick)">`;
                        options.forEach(opt => {
                            const isSelected = currentValues.includes(opt);
                            inputHtml += `<option value="${opt}" ${isSelected ? 'selected' : ''}>${opt}</option>`;
                        });
                        inputHtml += `</select><p class="text-xs text-gray-500 mt-1">Tipp: Mehrfachauswahl mit Strg+Klick</p>`;
                    
                    // --- LOGIK F√úR DYNAMISCHE DROPDOWNS ---
                    } else if (selectCols.includes(header)) { 
                        let options = [...new Set(masterData.map(d => d[header]))].filter(Boolean); 
                        
                        if (header === 'Lead Score (berechnet)') {
                            options.sort(sortLeadScores);
                        } else {
                            options.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));
                        }
                        
                        inputHtml = `<select id="${id}" class="modal-input custom-select">`;
                        inputHtml += `<option value="" ${value === '' ? 'selected' : ''}>Keine Angabe</option>`;
                        
                        options.forEach(opt => {
                            inputHtml += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                        });
                        inputHtml += `</select>`;
                    
                    } else if (textAreaCols.includes(header)) {
                        // *** "next step" wird jetzt hier als Textarea gerendert ***
                        inputHtml = `<textarea id="${id}" rows="4" class="modal-input">${value}</textarea>`;
                    
                    } else {
                        // Standard-Texteingabe
                        inputHtml = `<input type="text" id="${id}" class="modal-input" value="${value}">`;
                    }
                    
                    // Layout f√ºr das Feld
                    const colSpan = (textAreaCols.includes(header) || multiSelectCols.includes(header)) ? 'md:col-span-3' : 'md:col-span-1';
                    
                    html += `
                        <div class="${colSpan}">
                            <label class="modal-label" for="${id}">${header}</label>
                            ${inputHtml}
                        </div>
                    `;
                });
                
                html += '</div>';

            } else {
                // --- LESE-MODUS (OPTIMIERT F√úR √úBERSICHTLICHKEIT) ---
                html = '<div class="grid grid-cols-2 gap-x-8 gap-y-1 text-sm">'; // Kleinere Schrift, mehr horizontaler Abstand
                
                // Linke Spalte
                html += '<div><h3 class="font-semibold mb-2 text-purple-600 text-base">Kontaktinformationen</h3>';
                html += `<p class="mb-1.5"><strong class="text-gray-700">E-Mail:</strong> <span class="text-gray-600">${customer['Mailadresse'] || '-'}</span></p>`;
                
                // Telefonnummer hinzuf√ºgen
                const tel = customer['Telefon'] || '-';
                const telLink = tel.replace(/[\s\/-]/g, ''); // Bereinigt f√ºr tel:
                html += `<p class="mb-1.5"><strong class="text-gray-700">Telefon:</strong> ${tel !== '-' ? `<a href="tel:${telLink}" class="text-purple-600 hover:underline">${tel}</a>` : '<span class="text-gray-600">-</span>'}</p>`;
                
                html += `<p class="mb-1.5"><strong class="text-gray-700">Sales Rep:</strong> <span class="text-gray-600">${customer['Sales Rep'] || '-'}</span></p>`;
                html += `<p class="mb-1.5"><strong class="text-gray-700">Anrufer:</strong> <span class="text-gray-600">${customer['Anrufer'] || '-'}</span></p>`;
                if (customer['PowerHour Teilnehmer']) {
                    html += `<p class="mb-1.5"><strong class="text-gray-700">PowerHour:</strong> <span class="text-gray-600">${customer['PowerHour Teilnehmer']}</span></p>`;
                }
                html += '</div>';
                
                // Rechte Spalte
                html += '<div><h3 class="font-semibold mb-2 text-purple-600 text-base">Status & Module</h3>';
                html += `<p class="mb-1.5"><strong class="text-gray-700">Vision:</strong> <span class="text-gray-600">${customer['Vision'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</span></p>`;
                html += `<p class="mb-1.5"><strong class="text-gray-700">Scanning:</strong> <span class="text-gray-600">${customer['Scanning'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</span></p>`;
                html += `<p class="mb-1.5"><strong class="text-gray-700">3D Interesse:</strong> <span class="text-gray-600">${customer['Interesse 3D?'] || '-'}</span></p>`;
                html += `<p class="mb-1.5"><strong class="text-gray-700">Lead Score:</strong> <span class="text-gray-600">${customer['Lead Score (berechnet)'] || '-'}</span></p>`;
                html += `<p class="mb-1.5"><strong class="text-gray-700">Verw. Software:</strong> <span class="text-gray-600">${customer['Aktuell verwendete 3D Software'] || '-'}</span></p>`;
                
                // Gekaufte Module mit Ausklappen
                const modulesStr = customer['Gekaufte Module'] || '';
                const modulesList = modulesStr.split(',').map(m => m.trim()).filter(Boolean);
                let modulesHtml = '';
                if (modulesList.length > 0) {
                    modulesHtml = `<strong class="text-gray-700">Gek. Module:</strong> <span class="text-gray-600">`;
                    if (modulesList.length <= 2) {
                        modulesHtml += modulesList.join(', ');
                    } else {
                        modulesHtml += `${modulesList.slice(0, 2).join(', ')} `;
                        modulesHtml += `<span id="modal-modules-more" class="hidden">, ${modulesList.slice(2).join(', ')}</span>`;
                        modulesHtml += `<a href="#" id="modal-modules-toggle" onclick="toggleModules(event)" class="text-xs text-purple-600 hover:underline ml-1">
                                            <i class="fas fa-chevron-down"></i> Mehr
                                        </a>`;
                    }
                    modulesHtml += `</span>`;
                } else {
                    modulesHtml = `<strong class="text-gray-700">Gek. Module:</strong> <span class="text-gray-600">-</span>`;
                }
                html += `<div class="mb-1.5">${modulesHtml}</div>`;
                
                html += '</div></div>';
                
                // Weitere Infos in kompaktem Grid
                html += '<div class="mt-3 pt-3 border-t">'; 
                html += '<h3 class="font-semibold mb-2 text-purple-600 text-base">Weitere Informationen</h3>';
                html += '<div class="grid grid-cols-2 gap-x-8 gap-y-1.5 text-sm">';
                html += `<p><strong class="text-gray-700">Letzter Anruf:</strong> <span class="text-gray-600">${formatISODate(customer['Letzter Anruf am:']) || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">N√§chster Kontakt:</strong> <span class="text-gray-600">${formatISODate(customer['Wann erneuter Kontakt?']) || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Akquise-Typ:</strong> <span class="text-gray-600">${customer['Aquise-Typ'] || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Lead:</strong> <span class="text-gray-600">${customer['Lead'] || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Lead Status:</strong> <span class="text-gray-600">${customer['Lead Status (berechnet)'] || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Upsell Status:</strong> <span class="text-gray-600">${customer['Upsell Status'] || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Grund gekauft:</strong> <span class="text-gray-600">${customer['Grund gekauft'] || '-'}</span></p>`;
                html += `<p><strong class="text-gray-700">Grund NICHT gekauft:</strong> <span class="text-gray-600">${customer['Grund NICHT gekauft'] || '-'}</span></p>`;
                html += '</div>';
                
                // Ausklappbarer "Grund NICHT gekauft (txt)"
                const reasonText = customer['Gr√ºnde NICHT gekauft (txt)'] || '';
                if (reasonText) {
                    html += `
                        <div class="mt-2">
                            <a href="#" id="modal-reason-toggle" onclick="toggleReasonText(event)" class="text-xs text-purple-600 hover:underline">
                                <i class="fas fa-chevron-down mr-1"></i> Grund NICHT gekauft (Details anzeigen)
                            </a>
                            <div id="modal-reason-text" class="hidden mt-2 bg-gray-50 p-2 rounded text-xs max-h-32 overflow-y-auto modal-scroll-box" style="white-space: pre-wrap;">${reasonText}</div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Notizen und Next Step - Texte gr√∂√üer (text-sm statt text-xs)
                html += '<div class="mt-3 pt-3 border-t space-y-3">'; 
                
                // Telefonat-Notizen
                html += '<div>';
                html += '<h3 class="font-semibold mb-2 text-purple-600 text-base">Telefonat-Notizen</h3>';
                html += `<div class="bg-gray-50 p-3 rounded text-sm max-h-40 overflow-y-auto modal-scroll-box" style="white-space: pre-wrap;">${customer['Telefonat'] || '<span class="text-gray-500">Keine Notizen vorhanden</span>'}</div>`;
                html += '</div>';

                // Next Step
                html += '<div>';
                html += '<h3 class="font-semibold mb-2 text-purple-600 text-base">Next Step</h3>';
                html += `<div class="bg-blue-50 border border-blue-200 p-3 rounded text-sm max-h-40 overflow-y-auto modal-scroll-box" style="white-space: pre-wrap;">${customer['next step'] || '<span class="text-gray-500">Keine Angabe</span>'}</div>`;
                html += '</div>';

                html += '</div>';
            }
            modalContent.innerHTML = html; 
        }
        // ===== ENDE: AKTUALISIERTE FUNKTION =====
        
        // 1. Kundendaten speichern (KOMPLETT ERSETZT)
        async function saveCustomerDetails() {
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Speichern...';

            const changesToSave = {};
            // Firma-ID wird jetzt auch dynamisch generiert
            const firmaKey = document.getElementById(slugify('Firma')).value;

            // Helper, um Originalwerte (die null sein k√∂nnten) sicher zu vergleichen
            const getOrig = (key) => currentModalCustomer[key] || '';
            
            // Helper, um √Ñnderungen zu finden
            const checkChange = (key, newValue, originalValue) => {
                // Vergleiche normalisierte Werte (behandle null/undefined/leeren String als gleich)
                const normNew = newValue || '';
                const normOrig = originalValue || '';
                
                if (normNew !== normOrig) {
                    changesToSave[key] = newValue;
                }
            };
            
            // Dynamisches Pr√ºfen aller Spalten
            originalHeaders.forEach(header => {
                // Firma, PLZ und andere ReadOnly-Felder √ºberspringen
                // WICHTIG: PLZ wird nicht gespeichert, da sie aus der Online-Validierung kommt
                if (header === 'Firma' || header === 'Gekaufte Module' || header === 'PLZ' || header === 'Bundesland') return;

                const id = slugify(header);
                const element = document.getElementById(id);
                if (!element) {
                    console.warn('Konnte Element nicht finden f√ºr Header:', header);
                    return;
                }
                
                let newValue;
                
                // Multi-Select Felder: Sammle alle ausgew√§hlten Optionen
                if (element.multiple) {
                    const selectedOptions = Array.from(element.selectedOptions).map(opt => opt.value);
                    newValue = selectedOptions.join(', ');
                } else {
                    newValue = element.value;
                }
                
                // Spezielle Pr√ºfung f√ºr Datums-Felder
                if (header === 'Letzter Anruf am:' || header === 'Wann erneuter Kontakt?') {
                    const originalDateAsInput = formatISODateForInput(getOrig(header));
                    if (newValue !== originalDateAsInput) {
                        changesToSave[header] = newValue;
                    }
                } else {
                    // Standard-Pr√ºfung f√ºr alle anderen Felder
                    checkChange(header, newValue, getOrig(header));
                }
            });

            // Pr√ºfen, ob √ºberhaupt etwas ge√§ndert wurde
            if (Object.keys(changesToSave).length === 0) {
                alert("Es wurden keine √Ñnderungen vorgenommen.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Speichern';
                toggleModalEdit(false); // Zur√ºck zur Ansicht
                return;
            }
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateCustomer',
                        secret: API_SECRET,
                        userName: userName,
                        firma: firmaKey,      
                        data: changesToSave   
                    })
                });

                const result = await response.json();
                
                if (result.status === 'Erfolg') {
                    alert('Daten erfolgreich gespeichert!');
                    
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.classList.add('bg-yellow-200', 'text-yellow-800', 'border-yellow-500');
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Daten veraltet. Aktualisieren!';

                    closeModal(); 
                    
                } else {
                    throw new Error(result.message || 'Unbekannter Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Daten. Bitte versuche es erneut.\nDetails: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Speichern';
            }
        }

        // 3. Neue Funktion zum Schlie√üen des Modals bei Klick nach au√üen
        function closeModalOnClickOutside(event) {
            if (event.target.id === 'customerModal') {
                closeModal();
            }
        }

        // Close modal (*** ANGEPASST: Setzt Buttons zur√ºck ***)
        function closeModal() {
            document.getElementById('customerModal').classList.remove('active');
            currentModalCustomer = null;
            currentModalIndex = -1; // NEU: Index zur√ºcksetzen
            // *** NEUER FIX: Stellt sicher, dass beim n√§chsten √ñffnen "Bearbeiten" angezeigt wird ***
            document.getElementById('modalEditBtn').classList.remove('hidden');
            document.getElementById('modalCancelBtn').classList.add('hidden');
            document.getElementById('modalSaveBtn').classList.add('hidden');
        }
        
        // --- 4. Modal-Funktionen (Wird f√ºr Klick-Interaktion nicht mehr gebraucht) ---
        
        function showCustomersForReason(title, filterFunction) {
            // Diese Funktion wird nicht mehr aufgerufen, aber wir behalten sie f√ºr den Fall,
            // dass sie an anderer Stelle noch ben√∂tigt wird.
            const customers = masterData.filter(filterFunction);
            document.getElementById('reasonModalTitle').textContent = `${title} (${customers.length} Kunden)`;
            
            const content = document.getElementById('reasonModalContent');
            if (customers.length === 0) {
                content.innerHTML = '<p class="text-gray-500">Keine Kunden f√ºr dieses Kriterium gefunden.</p>';
            } else {
                 content.innerHTML = '<ul class="simple-modal-list">' +
                    customers.map(c => 
                        `<li onclick="openCustomerFromReasonModal('${encodeURIComponent(c['Firma'] || '')}')">
                            ${c['Firma']}
                        </li>`
                    ).join('') + 
                    '</ul>';
            }
            document.getElementById('reasonCustomerModal').classList.add('active');
        }

        // Schlie√üt das "Gr√ºnde"-Modal
        function closeReasonModal() {
            document.getElementById('reasonCustomerModal').classList.remove('active');
        }
        
        // Schlie√üt das "Gr√ºnde"-Modal bei Klick nach au√üen
        function closeReasonModalOnClickOutside(event) {
            if (event.target.id === 'reasonCustomerModal') {
                closeReasonModal();
            }
        }
        
        // √ñffnet das Haupt-Kunden-Modal aus dem "Gr√ºnde"-Modal
        function openCustomerFromReasonModal(encodedFirma) {
            closeReasonModal();
            setTimeout(() => {
                showCustomerDetailsByFirma(encodedFirma);
            }, 100);
        }

        // Help Modal Functions
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
            }
        }

        function closeHelpModalOnClickOutside(event) {
            if (event.target.id === 'helpModal') {
                toggleHelpModal();
            }
        }
        
        // Info Modal Funktionen
        function openInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.add('active');
        }
        
        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.remove('active');
        }
        
        function closeInfoModalOnClickOutside(event) {
            if (event.target.id === 'infoModal') {
                closeInfoModal();
            }
        }
        
        // --- Ende Modal-Funktionen ---
        
        // NEUE HILFSFUNKTION zum Erstellen von IDs aus Spaltennamen
        function slugify(text) {
            if (!text) return 'edit-unknown';
            return 'edit-' + text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Leerzeichen durch - ersetzen
                .replace(/[^a-z0-9\-]+/g, '')   // Alle nicht-alphanumerischen Zeichen entfernen
                .replace(/\-\-+/g, '-')         // Mehrfache -- durch einen - ersetzen
                .replace(/^-+/, '')             // F√ºhrende - entfernen
                .replace(/-+$/, '');            // Nachfolgende - entfernen
        }
        
        // *** ANGEPASST: Neue Sortierlogik mit Dropdown ***
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        function sortTable(columnKey, direction) {
            if (!columnKey) return;
            
            currentSortColumn = columnKey;
            currentSortDirection = direction;
            
            console.log(`Sortiere ${columnKey} nach ${direction}`); // DEBUG
            
            applySortToFilteredData();
            updateCustomerTable();
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(';'),
                ...filteredData.map(row => 
                    headers.map(header => {
                        let value = row[header] || '';
                        // 8. Datum f√ºr Export formatieren
                        if (header === 'Letzter Anruf am:' || header === 'Wann erneuter Kontakt?') {
                            value = formatISODate(value);
                        }
                        // Escape quotes and wrap in quotes if contains semicolon or newline
                        const escaped = value.toString().replace(/"/g, '""');
                        return escaped.includes(';') || escaped.includes('\n') ? 
                               `"${escaped}"` : escaped;
                    }).join(';')
                )
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `3D_Kunden_Export_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }
        
        // --- 10. SalesCockpit Funktionen ---

        // 2. SalesCockpit (Aktualisiert, nutzt jetzt filteredData & setzt Z√§hler)
        function updateSalesCockpit() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Speichere Listen in globalen cockpitLists
            cockpitLists.todayTasks = [];
            cockpitLists.overdueTasks = [];
            cockpitLists.topLeads = [];
            cockpitLists.coldLeads = [];
            contactsByDate = {}; // Kalenderdaten zur√ºcksetzen

            // 2. Nutzt jetzt 'filteredData' statt 'masterData'
            filteredData.forEach(customer => {
                // Aufgabenlisten
                const nextContactStr = customer['Wann erneuter Kontakt?'];
                if (nextContactStr) {
                    try {
                        const nextContactDate = new Date(nextContactStr);
                        if (!isNaN(nextContactDate.getTime())) {
                            nextContactDate.setHours(0, 0, 0, 0);
                            
                            const dateKey = nextContactDate.toISOString().split('T')[0];
                            if (!contactsByDate[dateKey]) {
                                contactsByDate[dateKey] = [];
                            }
                            contactsByDate[dateKey].push(customer);
                            
                            if (nextContactDate.getTime() === today.getTime()) {
                                cockpitLists.todayTasks.push(customer);
                            } else if (nextContactDate < today) {
                                cockpitLists.overdueTasks.push(customer);
                            }
                        }
                    } catch (e) {
                        console.warn('Ung√ºltiges Datum:', nextContactStr);
                    }
                }
                
                // Lead-Listen
                const score = customer['Lead Score (berechnet)'];
                if (score) {
                    if (score.includes('üî•üî•üî•') || score.includes('10/10') || score.includes('8/10')) {
                        cockpitLists.topLeads.push(customer);
                    }
                    if (score.includes('‚ùÑÔ∏è')) {
                        cockpitLists.coldLeads.push(customer);
                    }
                }
            });

            // Listen im UI f√ºllen
            populateTaskList('cockpit-today', cockpitLists.todayTasks, 'cockpit-today');
            populateTaskList('cockpit-overdue', cockpitLists.overdueTasks, 'cockpit-overdue');
            populateTaskList('cockpit-top-leads', cockpitLists.topLeads, 'cockpit-new-leads', true); // Sortieren nach Score
            populateTaskList('cockpit-cold-leads', cockpitLists.coldLeads, 'cockpit-cold-leads', true);
            
            // 2. Z√§hler-HTML aktualisieren
            document.getElementById('cockpit-today-title').innerHTML = `
                <i class="fas fa-calendar-day mr-2 text-blue-500"></i>Heute f√§llig
                <span class="cockpit-count bg-blue-100 text-blue-700">${cockpitLists.todayTasks.length}</span>`;
            document.getElementById('cockpit-overdue-title').innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>√úberf√§llig
                <span class="cockpit-count bg-red-100 text-red-700">${cockpitLists.overdueTasks.length}</span>`;
            document.getElementById('cockpit-top-leads-title').innerHTML = `
                <i class="fas fa-star mr-2 text-yellow-500"></i>Neue Top Leads
                <span class="cockpit-count bg-yellow-100 text-yellow-700">${cockpitLists.topLeads.length}</span>`;
            document.getElementById('cockpit-cold-leads-title').innerHTML = `
                <i class="fas fa-snowflake mr-2 text-gray-400"></i>Kalte Leads
                <span class="cockpit-count bg-gray-100 text-gray-700">${cockpitLists.coldLeads.length}</span>`;
            
            // Kalender rendern
            renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
        }
        
        // 3. Cockpit-Liste (Aktualisiert auf Modal)
        function populateTaskList(elementId, customers, listType, sortByScore = false) {
            const ul = document.getElementById(elementId);
            if (!ul) return;
            
            if (sortByScore) {
                // Nutzt die Standard (Hei√ü ‚Üí Kalt) Sortierung
                customers.sort(sortLeadScoresReverse);
            } else {
                 customers.sort((a, b) => (a['Firma'] || '').localeCompare(b['Firma'] || ''));
            }
            
            if (customers.length === 0) {
                ul.innerHTML = '<li class="text-gray-500 italic px-3">Keine Eintr√§ge</li>';
                return;
            }
            
            // Erstelle Event Listener statt inline onclick
            ul.innerHTML = customers.map((c, index) => 
                `<li data-firma="${encodeURIComponent(c['Firma'] || '')}" data-list-type="${listType}" class="cockpit-list-item" title="Details f√ºr ${c['Firma']} anzeigen">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${c['Firma']}</span>
                        <span class="text-xs ${getLeadScoreClass(c['Lead Score (berechnet)'])} rounded-full px-2 py-0.5">
                            ${c['Lead Score (berechnet)'] || 'N/A'}
                        </span>
                    </div>
                </li>`
            ).join('');
            
            // F√ºge Event Listener hinzu
            ul.querySelectorAll('.cockpit-list-item').forEach((item, index) => {
                item.addEventListener('click', function() {
                    const firma = this.getAttribute('data-firma');
                    const listType = this.getAttribute('data-list-type');
                    const listName = getCockpitListName(listType);
                    openCustomerFromCockpit(firma, listType, cockpitLists[listName]);
                });
            });
        }
        
        // Hilfsfunktion um den Listen-Namen zu bekommen
        function getCockpitListName(listType) {
            const mapping = {
                'cockpit-today': 'todayTasks',
                'cockpit-overdue': 'overdueTasks',
                'cockpit-new-leads': 'topLeads',
                'cockpit-cold-leads': 'coldLeads'
            };
            return mapping[listType] || 'todayTasks';
        }
        
        // 3. Kalender rendern (Aktualisiert auf Modal)
        function renderCalendar(year, month) {
            const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
            const dayNames = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
            
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            const weekdaysContainer = document.getElementById('calendar-weekdays');
            weekdaysContainer.innerHTML = dayNames.map(day => `<div class="calendar-header-cell">${day}</div>`).join('');
            
            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';
            
            const firstDay = new Date(year, month, 1).getDay(); // 0 = Sonntag, 1 = Montag...
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Korrektur f√ºr deutschen Wochenstart (Montag)
            // Wir mappen JS-Sonntag (0) auf Index 6
            const startDayIndex = (firstDay === 0) ? 6 : firstDay - 1; 
            
            // Wochentage (Mo-So)
            weekdaysContainer.innerHTML = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"]
                .map(day => `<div class="calendar-header-cell">${day}</div>`).join('');

            // Leere Zellen f√ºr Tage vor dem 1. des Monats
            for (let i = 0; i < startDayIndex; i++) {
                daysContainer.innerHTML += `<div class="calendar-day-cell other-month"></div>`;
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = date.toISOString().split('T')[0];
                const isToday = date.getTime() === today.getTime();
                
                let tasksHtml = '';
                if (contactsByDate[dateKey]) {
                    tasksHtml = `<div class="calendar-tasks">` +
                        contactsByDate[dateKey].map(customer => 
                            // Verwendet openCustomerFromCalendar mit dateKey f√ºr Navigation
                            `<span class="calendar-task-item" onclick="openCustomerFromCalendar('${encodeURIComponent(customer['Firma'] || '')}', '${dateKey}')" title="Details f√ºr ${customer['Firma']} anzeigen">
                                ${customer['Firma']}
                            </span>`
                        ).join('') + 
                        `</div>`;
                }
                
                daysContainer.innerHTML += `
                    <div class="calendar-day-cell ${isToday ? 'is-today' : ''}">
                        <div class="day-number">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
            
            // Leere Zellen f√ºr Tage nach dem letzten des Monats (bis 42 Zellen = 6 Wochen)
             const totalCells = startDayIndex + daysInMonth;
             const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
             for (let i = 0; i < remainingCells; i++) {
                 daysContainer.innerHTML += `<div class="calendar-day-cell other-month"></div>`;
             }
        }
        
        // --- Ende SalesCockpit Funktionen ---

        // Autocomplete f√ºr Firma suchen
        function updateCompanyAutocomplete() {
            const datalist = document.getElementById('companyDatalist');
            if (!datalist) return;
            
            // Sortierte Liste aller Firmennamen
            const companies = [...new Set(masterData.map(c => c['Firma']))].filter(Boolean).sort();
            
            datalist.innerHTML = companies.map(company => 
                `<option value="${company}">`
            ).join('');
        }

        // --- Tages-Fokus Funktionen (ANGEPASST: Neue Sortierlogik & Interaktivit√§t) ---
        let fokusList = [];
        let fokusCurrentIndex = 0;
        let isFokusMode = false;

        function startTagesFokus() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayTasks = [];
            const overdueTasks = [];
            
            // *** NEU: Kalte Leads sammeln (Score ‚ùÑÔ∏è UND kein n√§chster Kontakt) ***
            // Wir verwenden hier masterData, damit der Fokus-Modus *alle* relevanten Leads enth√§lt,
            // unabh√§ngig von den aktuellen globalen Filtern.
            const coldLeads = masterData.filter(c => {
                const score = c['Lead Score (berechnet)'];
                const nextContact = c['Wann erneuter Kontakt?'];
                return (score && score.includes('‚ùÑÔ∏è') && !nextContact);
            });
            
            masterData.forEach(customer => {
                const nextContactStr = customer['Wann erneuter Kontakt?'];
                if (nextContactStr) {
                    try {
                        const nextContactDate = new Date(nextContactStr);
                        if (!isNaN(nextContactDate.getTime())) {
                            nextContactDate.setHours(0, 0, 0, 0);
                            
                            if (nextContactDate.getTime() === today.getTime()) {
                                todayTasks.push(customer);
                            } else if (nextContactDate < today) {
                                overdueTasks.push(customer);
                            }
                        }
                    } catch (e) {
                        console.warn('Ung√ºltiges Datum:', nextContactStr);
                    }
                }
            });
            
            // *** NEUE SORTIERUNG ***
            // 1. Heute f√§llig (alphabetisch)
            todayTasks.sort((a, b) => (a['Firma'] || '').localeCompare(b['Firma'] || ''));
            
            // 2. √úberf√§llig (Hei√ü $\rightarrow$ Kalt)
            overdueTasks.sort(sortLeadScoresReverse);
            
            // 3. Kalte Leads (alphabetisch)
            coldLeads.sort((a, b) => (a['Firma'] || '').localeCompare(b['Firma'] || ''));
            
            // 4. Liste mit Separatoren zusammenbauen
            fokusList = [];
            if (todayTasks.length > 0) {
                fokusList.push({ firma: '--- Heute f√§llig ---', isSeparator: true });
                fokusList.push(...todayTasks);
            }
            if (overdueTasks.length > 0) {
                fokusList.push({ firma: '--- √úberf√§llig (Priorisiert) ---', isSeparator: true });
                fokusList.push(...overdueTasks);
            }
            if (coldLeads.length > 0) {
                fokusList.push({ firma: '--- Kalte Leads (Reaktivierung) ---', isSeparator: true });
                fokusList.push(...coldLeads);
            }
            
            if (fokusList.length === 0) {
                alert('Keine f√§lligen Aufgaben oder kalte Leads gefunden!');
                return;
            }
            
            // Fokus-Modus aktivieren
            isFokusMode = true;
            fokusCurrentIndex = 0;
            
            // UI umschalten
            document.getElementById('cockpit-normal-view').classList.add('hidden');
            document.getElementById('cockpit-fokus-view').classList.remove('hidden');
            document.getElementById('startFokusBtn').classList.add('hidden');
            document.getElementById('exitFokusBtn').classList.remove('hidden');
            
            // Ersten Kunden laden (√ºberspringt den ersten Separator)
            if (fokusList[0].isSeparator) {
                fokusCurrentIndex = 1; 
            }
            
            if (fokusList[fokusCurrentIndex]) {
                updateFokusProgress();
                renderFokusTaskList();
                showFokusDetails(fokusList[fokusCurrentIndex]['Firma']);
            } else {
                exitTagesFokus();
            }
        }

        function exitTagesFokus() {
            isFokusMode = false;
            fokusList = [];
            fokusCurrentIndex = 0;
            
            // UI zur√ºckschalten
            document.getElementById('cockpit-normal-view').classList.remove('hidden');
            document.getElementById('cockpit-fokus-view').classList.add('hidden');
            document.getElementById('startFokusBtn').classList.remove('hidden');
            document.getElementById('exitFokusBtn').classList.add('hidden');
            
            // Daten neu laden, um √Ñnderungen zu reflektieren
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn.classList.contains('bg-yellow-200')) {
                if (confirm('Sie haben √Ñnderungen vorgenommen. M√∂chten Sie die Daten neu laden?')) {
                    loadDataFromGoogleSheets();
                }
            }
        }

        function updateFokusProgress() {
            // Z√§hlt nur echte Kunden, keine Separatoren
            const totalTasks = fokusList.filter(item => !item.isSeparator).length;
            const currentTaskIndex = fokusList.slice(0, fokusCurrentIndex + 1).filter(item => !item.isSeparator).length;
            
            document.getElementById('fokus-current').textContent = currentTaskIndex > 0 ? currentTaskIndex : 1;
            document.getElementById('fokus-total').textContent = totalTasks;
        }

        // *** ANGEPASST: Rendert jetzt auch Separatoren und macht Tasks klickbar ***
        function renderFokusTaskList() {
            const ul = document.getElementById('fokus-task-list');
            if (!ul) return;
            
            ul.innerHTML = fokusList.map((customer, index) => {
                // Separator
                if (customer.isSeparator) {
                    return `<li class="fokus-separator">${customer.firma}</li>`;
                }
                
                // Normaler Task
                const isActive = index === fokusCurrentIndex;
                const isCompleted = index < fokusCurrentIndex;
                const classes = `${isActive ? 'active-fokus' : ''} ${isCompleted ? 'completed' : ''}`;
                
                return `<li class="${classes}" onclick="jumpToFokusTask(${index})" title="Zu ${customer['Firma']} springen">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${customer['Firma']}</span>
                        ${isCompleted ? '<i class="fas fa-check text-green-600"></i>' : ''}
                    </div>
                </li>`;
            }).join('');
        }

        // *** NEU: Springt zu einem Task in der Fokus-Liste ***
        function jumpToFokusTask(index) {
            if (index === fokusCurrentIndex || !fokusList[index] || fokusList[index].isSeparator) {
                return; // Nicht springen, wenn es ein Separator oder der aktuelle Task ist
            }
            
            fokusCurrentIndex = index;
            
            updateFokusProgress();
            renderFokusTaskList(); // Hebt den neuen Task hervor
            showFokusDetails(fokusList[fokusCurrentIndex]['Firma']);
        }

        // *** ANGEPASST: F√ºgt "Bearbeiten"-Button hinzu ***
        function showFokusDetails(firma) {
            const customer = masterData.find(c => c['Firma'] === firma);
            if (!customer) return;

            const detailsContainer = document.getElementById('fokusDetails');
            
            let html = `
                <div class="anrufer-details-info"> 
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${customer['Firma']}</h3>
                            <p class="text-gray-600">${customer['Mailadresse'] || 'Keine E-Mail'}</p>
                        </div>
                        <button onclick="openFokusEditModal()" 
                                class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-all flex-shrink-0"
                                title="Alle Details dieses Kunden im Modal bearbeiten">
                            <i class="fas fa-edit mr-2"></i>Bearbeiten
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">Sales Rep</p>
                            <p class="font-semibold">${customer['Sales Rep'] || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Lead Score</p>
                            <p class="font-semibold">${customer['Lead Score (berechnet)'] || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Vision</p>
                            <p class="font-semibold">${customer['Vision'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Scanning</p>
                            <p class="font-semibold">${customer['Scanning'] === 'ja' ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">Gekaufte Module</p>
                            <p class="font-semibold">${customer['Gekaufte Module'] || '-'}</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold mb-2">Telefonat-Notizen</h4>
                        <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto modal-scroll-box" style="white-space: pre-wrap;">${customer['Telefonat'] || '<span class="text-gray-500">Keine Notizen vorhanden</span>'}</div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-semibold mb-2">Weitere Informationen</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Anrufer:</strong> ${customer['Anrufer'] || '-'}</p>
                            <p><strong>Letzter Anruf:</strong> ${formatISODate(customer['Letzter Anruf am:']) || '-'}</p>
                            <p><strong>N√§chster Kontakt:</strong> ${formatISODate(customer['Wann erneuter Kontakt?']) || '-'}</p>
                            <p><strong>3D Interesse:</strong> ${customer['Interesse 3D?'] || '-'}</p>
                            <p><strong>Akquise-Typ:</strong> ${customer['Aquise-Typ'] || '-'}</p>
                        </div>
                    </div>
                </div> 
                <div class="anrufer-details-form"> 
                    <h4 class="font-semibold mb-3">Neue Notiz hinzuf√ºgen</h4>
                    <textarea id="fokusNote" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" 
                              placeholder="Notizen zum Gespr√§ch..."></textarea>
                    <div class="mt-3 flex items-center justify-between">
                        <div>
                            <label class="block text-sm font-semibold mb-1">N√§chster Kontakt am:</label>
                            <input type="date" id="fokusNextContact" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <button onclick="saveFokusNoteAndNext('${firma}')" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                                title="Notiz speichern und zum n√§chsten Kunden">
                            <i class="fas fa-save mr-2"></i>Speichern & N√§chster
                        </button>
                    </div>
                </div> 
                `;

            detailsContainer.innerHTML = html;
        }
        
        // *** NEU: √ñffnet das Haupt-Modal aus dem Fokus-Modus ***
        function openFokusEditModal() {
            if (!fokusList[fokusCurrentIndex]) return;
            
            const firma = fokusList[fokusCurrentIndex]['Firma'];
            const encodedFirma = encodeURIComponent(firma || '');
            
            // Zeigt das Haupt-Kundenmodal
            showCustomerDetailsByFirma(encodedFirma);
            
            // Wechselt sofort in den Bearbeiten-Modus
            // Kleine Verz√∂gerung, damit das Modal erst rendern kann
            setTimeout(() => {
                toggleModalEdit(true);
            }, 50);
        }


        async function saveFokusNoteAndNext(firma) {
            const note = document.getElementById('fokusNote').value;
            const nextContact = document.getElementById('fokusNextContact').value;
            
            if (!note && !nextContact) {
                if (confirm('Keine Notiz oder Datum eingegeben. Trotzdem zum n√§chsten Kunden springen?')) {
                    loadNextFokusCustomer();
                }
                return;
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveCallNote',
                        firma: firma,
                        notiz: note,
                        naechsterKontakt: nextContact ? nextContact : '',
                        secret: API_SECRET,
                        userName: userName
                    })
                });

                const result = await response.json();
                
                if (result.status === 'Erfolg') {
                    // Markieren, dass Daten veraltet sind
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.classList.add('bg-yellow-200', 'text-yellow-800', 'border-yellow-500');
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Daten veraltet. Aktualisieren!';
                    
                    // N√§chsten Kunden laden
                    loadNextFokusCustomer();
                } else {
                    throw new Error(result.message || 'Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Notiz. Bitte versuchen Sie es erneut.');
            }
        }

        // *** ANGEPASST: √úberspringt Separatoren ***
        function loadNextFokusCustomer() {
            fokusCurrentIndex++;
            
            // √úberspringe Separatoren
            while (fokusList[fokusCurrentIndex] && fokusList[fokusCurrentIndex].isSeparator) {
                fokusCurrentIndex++;
            }
            
            if (fokusCurrentIndex >= fokusList.length) {
                // Alle Aufgaben abgeschlossen
                alert('Alle Aufgaben f√ºr heute erledigt! üéâ');
                exitTagesFokus();
                return;
            }
            
            // N√§chsten Kunden anzeigen
            updateFokusProgress();
            renderFokusTaskList();
            showFokusDetails(fokusList[fokusCurrentIndex]['Firma']);
        }

        // --- Ende Tages-Fokus Funktionen ---

        // --- Active Filter Bar Functions (ANGEPASST) ---
        // Diese Funktion √§ndert nur noch den INHALT der Leiste, nicht mehr die Sichtbarkeit.
        function updateActiveFilterBar() {
            const activeFilters = getActiveFilters();
            const badgesContainer = document.getElementById('filterBadgesContainer');
            const clearBtn = document.getElementById('clearFiltersBtn');
            const filterTitle = document.getElementById('filterBarTitle');
            
            if (activeFilters.length === 0) {
                // Zeige "Keine Filter" an und verstecke den L√∂schen-Button
                filterTitle.textContent = "Filter";
                badgesContainer.innerHTML = `<span class="text-gray-400 italic text-sm">Keine Filter aktiv</span>`;
                clearBtn.style.display = 'none';
                
            } else {
                // Zeige die Filter-Badges und den L√∂schen-Button
                filterTitle.textContent = "Aktive Filter:";
                badgesContainer.innerHTML = activeFilters.map(filter => `
                    <div class="filter-badge">
                        <span><strong>${filter.label}:</strong> ${filter.value}</span>
                        <span class="remove-filter" onclick="removeFilter('${filter.type}')" title="Filter entfernen">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `).join('');
                clearBtn.style.display = 'flex';
            }
        }

        // *** ANGEPASST: F√ºgt reasonText und special Filter hinzu ***
        function getActiveFilters() {
            const filters = [];
            
            // Search filter
            const searchTerm = document.getElementById('globalSearch').value;
            if (searchTerm) {
                filters.push({
                    type: 'search',
                    label: 'Suche',
                    value: searchTerm
                });
            }
            
            // Dropdown filters
            const filterConfigs = [
                { id: 'salesRepFilter', label: 'Sales Rep', type: 'salesRep' },
                { id: 'akquiseTypFilter', label: 'Akquise-Typ', type: 'akquiseTyp' },
                { id: 'leadScoreFilter', label: 'Lead Score', type: 'leadScore' },
                { id: 'leadStatusBerechnetFilter', label: 'Lead Status', type: 'leadStatus' },
                { id: 'leadFilter', label: 'Lead-Quelle', type: 'lead' },
                { id: 'upsellStatusFilter', label: 'Upsell Status', type: 'upsellStatus' },
                { id: 'bundeslandFilter', label: 'Bundesland', type: 'bundesland' }
            ];
            
            filterConfigs.forEach(config => {
                const element = document.getElementById(config.id);
                if (element && element.value !== 'all') {
                    filters.push({
                        type: config.type,
                        label: config.label,
                        value: element.value
                    });
                }
            });

            // *** NEU: Textfilter f√ºr Gr√ºnde ***
            const reasonText = document.getElementById('reasonTextFilter').value;
            if (reasonText) {
                filters.push({
                    type: 'reasonText',
                    label: 'Begr√ºndung (Text)',
                    value: reasonText
                });
            }
            
            // *** NEU: Spezialfilter (aus Diagrammen) ***
            if (activeSpecialFilter) {
                let label = 'Filter';
                let value = activeSpecialFilter.value;
                
                switch(activeSpecialFilter.type) {
                    case 'reasonNotBought':
                        label = 'Grund NICHT gekauft';
                        break;
                    case 'reasonBought':
                        label = 'Grund gekauft';
                        break;
                    case 'globalSearch':
                        label = 'Globale Suche';
                        break;
                    case 'bundesland':
                        label = 'üó∫Ô∏è Bundesland';
                        break;
                    default:
                        label = 'Spezialfilter';
                }
                
                filters.push({
                    type: 'special',
                    label: label,
                    value: value
                });
            }
            
            // Header KPI filters
            const activeHeaderKpi = document.querySelector('.header-kpi.active-filter-header');
            if (activeHeaderKpi) {
                filters.push({
                    type: 'headerKpi',
                    label: 'KPI',
                    value: activeHeaderKpi.querySelector('p:first-child')?.textContent || 'KPI Filter'
                });
            }
            
            // KPI Card filters
            const activeKpiCards = document.querySelectorAll('.kpi-card.active-filter');
            activeKpiCards.forEach(card => {
                filters.push({
                    type: 'kpiCard',
                    label: 'Modul',
                    value: card.querySelector('.kpi-label')?.textContent || 'KPI'
                });
            });
            
            return filters;
        }

        // *** ANGEPASST: F√ºgt reasonText und special Filter hinzu ***
        function removeFilter(filterType) {
            switch(filterType) {
                case 'search':
                    document.getElementById('globalSearch').value = '';
                    break;
                case 'salesRep':
                    document.getElementById('salesRepFilter').value = 'all';
                    break;
                case 'akquiseTyp':
                    document.getElementById('akquiseTypFilter').value = 'all';
                    break;
                case 'leadScore':
                    document.getElementById('leadScoreFilter').value = 'all';
                    break;
                case 'leadStatus':
                    document.getElementById('leadStatusBerechnetFilter').value = 'all';
                    break;
                case 'lead':
                    document.getElementById('leadFilter').value = 'all';
                    break;
                case 'upsellStatus':
                    document.getElementById('upsellStatusFilter').value = 'all';
                    break;
                case 'bundesland':
                    const blFilter = document.getElementById('bundeslandFilter');
                    if (blFilter) blFilter.value = 'all';
                    // Falls es ein Spezialfilter ist, auch zur√ºcksetzen
                    if (activeSpecialFilter && activeSpecialFilter.type === 'bundesland') {
                        activeSpecialFilter = null;
                    }
                    break;
                case 'reasonText':
                    document.getElementById('reasonTextFilter').value = '';
                    break;
                case 'special': // Spezialfilter aus Diagramm
                    // Falls es ein Bundesland-Spezialfilter ist, auch den bundeslandFilter zur√ºcksetzen
                    if (activeSpecialFilter && activeSpecialFilter.type === 'bundesland') {
                        const blFilter = document.getElementById('bundeslandFilter');
                        if (blFilter) blFilter.value = 'all';
                    }
                    activeSpecialFilter = null;
                    break;
                case 'headerKpi':
                    document.querySelectorAll('.header-kpi').forEach(el => {
                        el.classList.remove('active-filter-header');
                    });
                    break;
                case 'kpiCard':
                    document.querySelectorAll('.kpi-card').forEach(card => {
                        card.classList.remove('active-filter');
                    });
                    break;
            }
            
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('resetFilters').click();
        }

        // --- Performance & UX Helper Functions ---
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function smoothScrollTo(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10001;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            `;
            
            const colors = {
                info: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);',
                success: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%);',
                error: 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);',
                warning: 'background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);'
            };
            
            notification.style.cssText += colors[type] || colors.info;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle mr-2"></i>${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Add results counter to customer table
        function addResultsCounter() {
            const customersTab = document.getElementById('customers-tab');
            if (customersTab && !document.getElementById('resultsCounter')) {
                const counter = document.createElement('div');
                counter.id = 'resultsCounter';
                counter.className = 'results-counter';
                counter.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-filter text-purple-600"></i>
                        <span class="results-counter-text" id="resultsCounterText">Alle Kunden werden angezeigt</span>
                    </div>
                    <button onclick="clearAllFilters()" class="text-sm text-purple-600 hover:text-purple-800 font-semibold transition-colors">
                        <i class="fas fa-times-circle mr-1"></i>Filter zur√ºcksetzen
                    </button>
                `;
                
                const glassCard = customersTab.querySelector('.glass-card');
                if (glassCard) {
                    glassCard.insertBefore(counter, glassCard.firstChild);
                }
            }
        }

        // Update results counter
        function updateResultsCounter() {
            const counterText = document.getElementById('resultsCounterText');
            if (counterText) {
                const total = masterData.length;
                const filtered = filteredData.length;
                const percentage = total > 0 ? ((filtered / total) * 100).toFixed(0) : 0;
                
                if (filtered === total) {
                    counterText.innerHTML = `Alle <strong>${total}</strong> Kunden werden angezeigt`;
                } else {
                    counterText.innerHTML = `<strong>${filtered}</strong> von <strong>${total}</strong> Kunden (${percentage}%)`;
                }
            }
        }

        // --- Ende UX Functions ---

        // --- Global Search Functions ---
        function performGlobalSearch(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) {
                hideGlobalSearchDropdown();
                return;
            }

            const term = searchTerm.toLowerCase();
            const results = [];
            
            // Durchsuche alle Spalten f√ºr jeden Kunden
            masterData.forEach(customer => {
                let matchedFields = [];
                let matchCount = 0;
                
                // Durchsuche alle Spalten
                Object.keys(customer).forEach(key => {
                    const value = String(customer[key] || '').toLowerCase();
                    if (value.includes(term)) {
                        matchedFields.push({
                            field: key,
                            value: customer[key]
                        });
                        matchCount++;
                    }
                });
                
                // Wenn Treffer gefunden wurden, f√ºge zum Ergebnis hinzu
                if (matchCount > 0) {
                    results.push({
                        customer: customer,
                        matchedFields: matchedFields,
                        matchCount: matchCount
                    });
                }
            });
            
            // Sortiere nach Anzahl der Treffer (relevanteste zuerst)
            results.sort((a, b) => b.matchCount - a.matchCount);
            
            // Zeige max. 10 Top-Ergebnisse
            displayGlobalSearchResults(results.slice(0, 10), term);
        }

        function displayGlobalSearchResults(results, searchTerm) {
            const dropdown = document.getElementById('globalSearchDropdown');
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="global-search-no-results"><i class="fas fa-search mr-2"></i>Keine Ergebnisse gefunden</div>';
                dropdown.classList.add('active');
                return;
            }
            
            let html = '';
            results.forEach((result, index) => {
                const customer = result.customer;
                const firma = customer['Firma'] || 'Unbekannt';
                const email = customer['Mailadresse'] || '';
                const salesRep = customer['Sales Rep'] || '';
                const leadScore = customer['Lead Score (berechnet)'] || '';
                
                // Erstelle eine detaillierte Liste aller √ºbereinstimmenden Felder
                const matchDetails = result.matchedFields.map(field => {
                    let value = String(field.value || '');
                    // Highlight den Suchbegriff
                    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                    value = value.replace(regex, '<span class="global-search-highlight">$1</span>');
                    
                    // K√ºrze lange Werte
                    if (value.length > 80) {
                        const startIdx = value.toLowerCase().indexOf(searchTerm.toLowerCase());
                        if (startIdx > 30) {
                            value = '...' + value.substring(Math.max(0, startIdx - 20), Math.min(value.length, startIdx + 60)) + '...';
                        } else {
                            value = value.substring(0, 80) + '...';
                        }
                    }
                    
                    return `<div style="margin-bottom: 4px;"><strong>${field.field}:</strong> ${value}</div>`;
                }).join('');
                
                html += `
                    <div class="global-search-result" data-firma="${escapeForAttribute(firma)}" data-action="select">
                        <div class="global-search-result-company">${highlightSearchTerm(firma, searchTerm)}</div>
                        <div class="global-search-result-details">
                            ${email ? highlightSearchTerm(email, searchTerm) : ''} 
                            ${email && salesRep ? '‚Ä¢' : ''} 
                            ${salesRep ? 'Sales Rep: ' + highlightSearchTerm(salesRep, searchTerm) : ''}
                            ${leadScore ? '‚Ä¢ Score: ' + leadScore : ''}
                        </div>
                        <div class="global-search-result-details text-xs mt-2" style="line-height: 1.5;">${matchDetails}</div>
                    </div>
                `;
            });
            
            // Store the current search term and total results count globally
            window.currentGlobalSearchTerm = searchTerm;
            window.currentGlobalSearchResultsCount = results.length;
            
            // Add "Show all results" button if there are results
            html += `
                <div class="global-search-show-all" data-action="show-all">
                    <i class="fas fa-list mr-2"></i>Alle Treffer anzeigen
                    <span class="global-search-results-count">(${results.length} ${results.length === 1 ? 'Treffer' : 'Treffer'})</span>
                </div>
            `;
            
            dropdown.innerHTML = html;
            dropdown.classList.add('active');
            
            // F√ºge Event-Listener hinzu (statt inline onclick)
            dropdown.querySelectorAll('[data-action="select"]').forEach(element => {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const firma = this.getAttribute('data-firma');
                    selectGlobalSearchResult(firma);
                });
            });
            
            dropdown.querySelector('[data-action="show-all"]').addEventListener('click', function(e) {
                e.stopPropagation();
                showAllGlobalSearchResults();
            });
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!text) return '';
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return String(text).replace(regex, '<span class="global-search-highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeForAttribute(string) {
            return String(string).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function selectGlobalSearchResult(firma) {
            // Schlie√üe das Dropdown
            hideGlobalSearchDropdown();
            
            // L√∂sche das Suchfeld
            document.getElementById('globalSearchHeader').value = '';
            
            // Wechsle zur Kundenliste
            document.querySelector('[data-tab="customers"]').click();
            
            // Setze alle Filter zur√ºck
            document.getElementById('resetFilters').click();
            
            // Zeige nur diesen einen Kunden
            setTimeout(() => {
                // Filtere direkt auf diesen einen Kunden
                filteredData = masterData.filter(c => c['Firma'] === firma);
                
                // NEU: Spezialfilter setzen f√ºr Filterbar
                activeSpecialFilter = {
                    type: 'globalSearch',
                    value: `Kunde: ${firma}`
                };
                
                // Update die Ansicht
                updateDashboard();
                updateCustomerTable();
                updateMatrixView();
                updateAnruferList();
                updateActiveFilterBar();
                
                // Zeige Notification
                showNotification(`Kunde "${firma}" wird angezeigt`, 'success', 2000);
                
                // Scroll zur Tabelle
                setTimeout(() => {
                    const table = document.getElementById('customerTable');
                    if (table) {
                        table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }, 100);
        }

        function showAllGlobalSearchResults() {
            const searchTerm = window.currentGlobalSearchTerm;
            const resultsCount = window.currentGlobalSearchResultsCount;
            
            if (!searchTerm) {
                return;
            }
            
            // Schlie√üe das Dropdown
            hideGlobalSearchDropdown();
            
            // L√∂sche das Suchfeld
            document.getElementById('globalSearchHeader').value = '';
            
            // Wechsle zur Kundenliste
            document.querySelector('[data-tab="customers"]').click();
            
            // Setze alle Filter zur√ºck
            document.getElementById('resetFilters').click();
            
            // F√ºhre eine globale Suche durch und filtere alle passenden Kunden
            setTimeout(() => {
                const term = searchTerm.toLowerCase();
                
                filteredData = masterData.filter(customer => {
                    // Durchsuche alle Spalten
                    return Object.values(customer).some(value => {
                        return String(value || '').toLowerCase().includes(term);
                    });
                });
                
                // NEU: Spezialfilter setzen f√ºr Filterbar
                activeSpecialFilter = {
                    type: 'globalSearch',
                    value: `Suche: "${searchTerm}" (${filteredData.length} Treffer)`
                };
                
                // Update die Ansicht
                updateDashboard();
                updateCustomerTable();
                updateMatrixView();
                updateAnruferList();
                updateActiveFilterBar();
                
                // Zeige Notification
                showNotification(`${filteredData.length} ${filteredData.length === 1 ? 'Treffer' : 'Treffer'} f√ºr "${searchTerm}" werden angezeigt`, 'success', 3000);
                
                // Scroll zur Tabelle
                setTimeout(() => {
                    const table = document.getElementById('customerTable');
                    if (table) {
                        table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }, 100);
        }

        function hideGlobalSearchDropdown() {
            document.getElementById('globalSearchDropdown').classList.remove('active');
        }

        // Event Listener f√ºr globale Suche
        document.addEventListener('DOMContentLoaded', function() {
            const globalSearchInput = document.getElementById('globalSearchHeader');
            
            if (globalSearchInput) {
                // Debounced search
                let searchTimeout;
                globalSearchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performGlobalSearch(e.target.value);
                    }, 300);
                });
                
                // Schlie√üe Dropdown bei Klick au√üerhalb
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.global-search-container')) {
                        hideGlobalSearchDropdown();
                    }
                });
                
                // Schlie√üe Dropdown bei ESC
                globalSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        hideGlobalSearchDropdown();
                        globalSearchInput.value = '';
                    }
                });
            }
        });
        // --- Ende Global Search Functions ---

        // --- Ende UX Functions ---

        // Keyboard shortcuts (*** ANGEPASST: Alt+6 hinzugef√ºgt ***)
        document.addEventListener('keydown', function(event) {
            // Ctrl+K for search
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            
            // Ctrl+Shift+F for global search in header
            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'F') {
                event.preventDefault();
                const globalSearchInput = document.getElementById('globalSearchHeader');
                if (globalSearchInput) {
                    globalSearchInput.focus();
                    globalSearchInput.select();
                }
            }
            
            // Alt+Number: Switch between tabs
            if (event.altKey && (event.key >= '1' && event.key <= '7')) {
                event.preventDefault();
                const tabs = ['overview', 'cockpit', 'customers', 'matrix', 'anrufer', 'reasons', 'geo'];
                const tabIndex = parseInt(event.key) - 1;
                if (tabs[tabIndex]) {
                    document.querySelector(`[data-tab="${tabs[tabIndex]}"]`).click();
                }
            }
            
            // Escape to close modal
            if (event.key === 'Escape') {
                closeModal();
                closeReasonModal();
                closeAdvancedFilterModal(); // NEU
                const helpModal = document.getElementById('helpModal');
                if (helpModal.classList.contains('active')) {
                    toggleHelpModal();
                }
                const infoModal = document.getElementById('infoModal');
                if (infoModal && infoModal.classList.contains('active')) {
                    closeInfoModal();
                }
            }
        });
    </script>
</body>
</html>